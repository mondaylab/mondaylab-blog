import{_ as s,c as n,o as a,N as l}from"./chunks/framework.6510d215.js";const d=JSON.parse('{"title":"é¢è¯•ä¸­çš„ç½‘çº¢è™šæ‹ŸDOMï¼Œä½ çŸ¥å¤šå°‘å‘¢ï¼Ÿæ·±å…¥è§£è¯»diffç®—æ³•","description":"","frontmatter":{"title":"é¢è¯•ä¸­çš„ç½‘çº¢è™šæ‹ŸDOMï¼Œä½ çŸ¥å¤šå°‘å‘¢ï¼Ÿæ·±å…¥è§£è¯»diffç®—æ³•","author":"å‘¨ä¸€","date":"2021-06-28","categories":["å‰ç«¯å¼€å‘"],"tags":["vue.jsåŸç†è§£æ"],"sidebar":"auto"},"headers":[{"level":1,"title":"å‰è¨€","slug":"å‰è¨€","link":"#å‰è¨€","children":[]},{"level":1,"title":"ä¸€ã€è™šæ‹Ÿ DOMï¼ˆVitual DOMï¼‰","slug":"ä¸€ã€è™šæ‹Ÿ-dom-vitual-dom","link":"#ä¸€ã€è™šæ‹Ÿ-dom-vitual-dom","children":[{"level":2,"title":"1ã€è™šæ‹Ÿ DOMï¼ˆVitual DOMï¼‰å’Œ diff çš„å…³ç³»","slug":"_1ã€è™šæ‹Ÿ-dom-vitual-dom-å’Œ-diff-çš„å…³ç³»","link":"#_1ã€è™šæ‹Ÿ-dom-vitual-dom-å’Œ-diff-çš„å…³ç³»","children":[]},{"level":2,"title":"2ã€çœŸå® DOM çš„æ¸²æŸ“è¿‡ç¨‹","slug":"_2ã€çœŸå®-dom-çš„æ¸²æŸ“è¿‡ç¨‹","link":"#_2ã€çœŸå®-dom-çš„æ¸²æŸ“è¿‡ç¨‹","children":[]},{"level":2,"title":"3ã€è™šæ‹Ÿ DOM æ˜¯ä»€ä¹ˆï¼Ÿ","slug":"_3ã€è™šæ‹Ÿ-dom-æ˜¯ä»€ä¹ˆ","link":"#_3ã€è™šæ‹Ÿ-dom-æ˜¯ä»€ä¹ˆ","children":[]},{"level":2,"title":"4ã€è§£å†³æ–¹æ¡ˆ - vdom","slug":"_4ã€è§£å†³æ–¹æ¡ˆ-vdom","link":"#_4ã€è§£å†³æ–¹æ¡ˆ-vdom","children":[{"level":3,"title":"ï¼ˆ1ï¼‰é—®é¢˜å¼•å‡º","slug":"_1-é—®é¢˜å¼•å‡º","link":"#_1-é—®é¢˜å¼•å‡º","children":[]},{"level":3,"title":"ï¼ˆ2ï¼‰vdom å¦‚ä½•è§£å†³é—®é¢˜ï¼šå°†çœŸå® DOM è½¬ä¸º JS å¯¹è±¡çš„è®¡ç®—","slug":"_2-vdom-å¦‚ä½•è§£å†³é—®é¢˜-å°†çœŸå®-dom-è½¬ä¸º-js-å¯¹è±¡çš„è®¡ç®—","link":"#_2-vdom-å¦‚ä½•è§£å†³é—®é¢˜-å°†çœŸå®-dom-è½¬ä¸º-js-å¯¹è±¡çš„è®¡ç®—","children":[]}]},{"level":2,"title":"5ã€ç”¨ JS æ¨¡æ‹Ÿä¸€ä¸ª DOM ç»“æ„","slug":"_5ã€ç”¨-js-æ¨¡æ‹Ÿä¸€ä¸ª-dom-ç»“æ„","link":"#_5ã€ç”¨-js-æ¨¡æ‹Ÿä¸€ä¸ª-dom-ç»“æ„","children":[]},{"level":2,"title":"6ã€é€šè¿‡ snabbdom å­¦ä¹  vdom","slug":"_6ã€é€šè¿‡-snabbdom-å­¦ä¹ -vdom","link":"#_6ã€é€šè¿‡-snabbdom-å­¦ä¹ -vdom","children":[{"level":3,"title":"ï¼ˆ1ï¼‰snabbdom æ˜¯ä»€ä¹ˆ","slug":"_1-snabbdom-æ˜¯ä»€ä¹ˆ","link":"#_1-snabbdom-æ˜¯ä»€ä¹ˆ","children":[]},{"level":3,"title":"ï¼ˆ2ï¼‰snabbdom æµ…æ","slug":"_2-snabbdom-æµ…æ","link":"#_2-snabbdom-æµ…æ","children":[]},{"level":3,"title":"ï¼ˆ2ï¼‰snabbdom æ¼”ç¤º","slug":"_2-snabbdom-æ¼”ç¤º","link":"#_2-snabbdom-æ¼”ç¤º","children":[]}]},{"level":2,"title":"7ã€vdom æ€»ç»“","slug":"_7ã€vdom-æ€»ç»“","link":"#_7ã€vdom-æ€»ç»“","children":[]}]},{"level":1,"title":"äºŒã€diff ç®—æ³•","slug":"äºŒã€diff-ç®—æ³•","link":"#äºŒã€diff-ç®—æ³•","children":[{"level":2,"title":"1ã€diff ç®—æ³•","slug":"_1ã€diff-ç®—æ³•","link":"#_1ã€diff-ç®—æ³•","children":[]},{"level":2,"title":"2ã€diff ç®—æ³•æ¦‚è¿°","slug":"_2ã€diff-ç®—æ³•æ¦‚è¿°","link":"#_2ã€diff-ç®—æ³•æ¦‚è¿°","children":[]},{"level":2,"title":"3ã€æ ‘ diff çš„æ—¶é—´å¤æ‚åº¦ O(n3)","slug":"_3ã€æ ‘-diff-çš„æ—¶é—´å¤æ‚åº¦-o-n3","link":"#_3ã€æ ‘-diff-çš„æ—¶é—´å¤æ‚åº¦-o-n3","children":[]},{"level":2,"title":"4ã€ä¼˜åŒ–æ—¶é—´å¤æ‚åº¦åˆ° O(n)","slug":"_4ã€ä¼˜åŒ–æ—¶é—´å¤æ‚åº¦åˆ°-o-n","link":"#_4ã€ä¼˜åŒ–æ—¶é—´å¤æ‚åº¦åˆ°-o-n","children":[]}]},{"level":1,"title":"ä¸‰ã€æ·±å…¥ diff ç®—æ³•æºç ","slug":"ä¸‰ã€æ·±å…¥-diff-ç®—æ³•æºç ","link":"#ä¸‰ã€æ·±å…¥-diff-ç®—æ³•æºç ","children":[{"level":2,"title":"1ã€ç”Ÿæˆ vnode","slug":"_1ã€ç”Ÿæˆ-vnode","link":"#_1ã€ç”Ÿæˆ-vnode","children":[]},{"level":2,"title":"2ã€patch å‡½æ•°","slug":"_2ã€patch-å‡½æ•°","link":"#_2ã€patch-å‡½æ•°","children":[]},{"level":2,"title":"3ã€patchVnode å‡½æ•°","slug":"_3ã€patchvnode-å‡½æ•°","link":"#_3ã€patchvnode-å‡½æ•°","children":[]},{"level":2,"title":"4ã€updateChildren å‡½æ•°","slug":"_4ã€updatechildren-å‡½æ•°","link":"#_4ã€updatechildren-å‡½æ•°","children":[]}]},{"level":1,"title":"å››ã€ç»“æŸè¯­","slug":"å››ã€ç»“æŸè¯­","link":"#å››ã€ç»“æŸè¯­","children":[]}],"relativePath":"column/FrontEnd/VUEPrinciple/002.md","lastUpdated":1685151998000}'),p={name:"column/FrontEnd/VUEPrinciple/002.md"},o=l(`<h1 id="å‰è¨€" tabindex="-1">å‰è¨€ <a class="header-anchor" href="#å‰è¨€" aria-label="Permalink to &quot;å‰è¨€&quot;">â€‹</a></h1><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œåœ¨å‰ç«¯çš„é¢è¯•ä¸­ï¼Œé¢è¯•å®˜éå¸¸çˆ±è€ƒ vdom å’Œ diff ç®—æ³•ã€‚æ¯”å¦‚ï¼Œå¯èƒ½ä¼šå‡ºç°åœ¨ä»¥ä¸‹åœºæ™¯ ğŸ¤</p><p>æ»´æ»´æ»´ï¼Œé¢è¯•å®˜å‘æ¥ä¸€ä¸ªé¢è¯•é‚€è¯·ã€‚æ¥å—é‚€è¯· ğŸ“</p><p>ğŸ§‘ é¢è¯•å®˜ï¼šä½ çŸ¥é“ <code>key</code> çš„ä½œç”¨å—ï¼Ÿ</p><p>ğŸ™ æˆ‘ï¼š<code>key</code> çš„ä½œç”¨æ˜¯ä¿è¯æ•°æ®çš„å”¯ä¸€æ€§ã€‚</p><p>ğŸ§‘ é¢è¯•å®˜ï¼šæ€ä¹ˆä¿è¯æ•°æ®çš„å”¯ä¸€æ€§ï¼Ÿ</p><p>ğŸ™ æˆ‘ï¼šå°±....</p><p>ğŸ§‘ é¢è¯•å®˜ï¼šä½ çŸ¥é“è™šæ‹Ÿ dom å—ï¼Ÿ</p><p>ğŸ™ æˆ‘ï¼šè™šæ‹Ÿ dom å°±æ˜¯â€¦â€¦balabala</p><p>ğŸ§‘ é¢è¯•å®˜ï¼šï¼ˆå¥½åƒæœ‰ç‚¹é“ç†ï¼‰é‚£ä½ çŸ¥é“ diff ç®—æ³•å—ï¼Ÿ</p><p>ğŸ™ æˆ‘ï¼šï¼ˆå¿ƒé‡Œï¼šwhatâ€¦â€¦diff ç®—æ³•æ˜¯ä»€ä¹ˆï¼Ÿï¼Ÿï¼‰</p><p>ğŸ§‘ é¢è¯•å®˜ï¼šæœ¬æ¬¡é¢è¯•ç»“æŸï¼Œå›å»ç­‰é¢è¯•ç»“æœé€šçŸ¥ã€‚</p><p>ğŸ™‹ğŸ™‹ğŸ™‹</p><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œ <code>key</code> çš„ä½œç”¨åœ¨å‰ç«¯çš„é¢è¯•æ˜¯ä¸€é“å¾ˆæ™®éçš„é¢˜ç›®ï¼Œä½†æ˜¯å‘¢ï¼Œå¾ˆå¤šæ—¶å€™æˆ‘ä»¬éƒ½åªæµ®äºçŸ¥è¯†çš„è¡¨é¢ï¼Œè€Œæ²¡æœ‰å»æ·±æŒ–å…¶åŸç†æ‰€åœ¨ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬çš„ç«äº‰åŠ›å°±åœ¨è¿™è¢«æ‹‰ä¸‹äº†ã€‚æ‰€ä»¥å‘¢ï¼Œæ·±å…¥å­¦ä¹ åŸç†å¯¹äºæå‡è‡ªèº«çš„æ ¸å¿ƒç«äº‰åŠ›æ˜¯ä¸€ä¸ªå¿…ä¸å¯å°‘çš„è¿‡ç¨‹ã€‚</p><p>åœ¨æ¥ä¸‹æ¥çš„è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†è®²è§£é¢è¯•ä¸­å¾ˆçˆ±è€ƒçš„è™šæ‹Ÿ DOM ä»¥åŠå…¶èƒŒåçš„ diff ç®—æ³•ã€‚</p><h1 id="ä¸€ã€è™šæ‹Ÿ-dom-vitual-dom" tabindex="-1">ä¸€ã€è™šæ‹Ÿ DOMï¼ˆVitual DOMï¼‰ <a class="header-anchor" href="#ä¸€ã€è™šæ‹Ÿ-dom-vitual-dom" aria-label="Permalink to &quot;ä¸€ã€è™šæ‹Ÿ DOMï¼ˆVitual DOMï¼‰&quot;">â€‹</a></h1><h2 id="_1ã€è™šæ‹Ÿ-dom-vitual-dom-å’Œ-diff-çš„å…³ç³»" tabindex="-1">1ã€è™šæ‹Ÿ DOMï¼ˆVitual DOMï¼‰å’Œ diff çš„å…³ç³» <a class="header-anchor" href="#_1ã€è™šæ‹Ÿ-dom-vitual-dom-å’Œ-diff-çš„å…³ç³»" aria-label="Permalink to &quot;1ã€è™šæ‹Ÿ DOMï¼ˆVitual DOMï¼‰å’Œ diff çš„å…³ç³»&quot;">â€‹</a></h2><p>æˆ‘ä»¬éƒ½çŸ¥é“ <code>DOM</code> æ“ä½œæ˜¯éå¸¸è€—è´¹æ€§èƒ½çš„ï¼Œæ—©æœŸæˆ‘ä»¬ç”¨ <code>JQuery</code> æ¥è‡ªè¡Œæ§åˆ¶ <code>DOM</code> æ“ä½œçš„æ—¶æœºï¼Œä¹Ÿå°±æ˜¯æ‰‹åŠ¨è°ƒæ•´ï¼Œè¿™æ ·å­å…¶å®ä¹Ÿä¸æ˜¯ç‰¹åˆ«æ–¹ä¾¿ã€‚å› æ­¤å°±å‡ºç°äº†è™šæ‹Ÿ <code>DOM</code> ï¼Œå³ <code>Vitual DOM</code> ï¼ˆä¸‹æ–‡ç®€ç§°ä¸º <code>vdom</code> ï¼‰ï¼Œæ¥è§£å†³ <code>DOM</code> æ“ä½œçš„é—®é¢˜ã€‚ <code>vdom </code> æ˜¯ç°å¦‚ä»Šçš„ä¸€ä¸ªçƒ­é—¨è¯é¢˜ï¼Œä¹Ÿæ˜¯é¢è¯•ä¸­çš„çƒ­é—¨è¯é¢˜ï¼ŒåŸºæœ¬ä¸Šåœ¨å‰ç«¯çš„é¢è¯•ä¸­éƒ½ä¼šé—®åˆ° <code>è™šæ‹ŸDOM</code> çš„é—®é¢˜ã€‚</p><p>è€Œä¸ºä»€ä¹ˆä¼šé—®åˆ° <code>vdom</code> çš„é—®é¢˜å‘¢ï¼ŒåŸå› åœ¨äºç°åœ¨æµè¡Œçš„ <code>vue </code> å’Œ <code>react</code> æ¡†æ¶ï¼Œéƒ½æ˜¯æ•°æ®é©±åŠ¨è§†å›¾ï¼Œå¹¶ä¸”æ˜¯åŸºäº <code>vdom</code> å®ç°çš„ï¼Œå¯ä»¥è¯´ <code>vdom</code> æ˜¯å®ç° <code>vue</code> å’Œ <code>react</code> çš„é‡è¦åŸºçŸ³ã€‚</p><p>è°ˆåˆ° <code>vdom</code> ï¼Œæˆ‘ä»¬ä¸æ˜è§‰å‰çš„è¿˜ä¼šæƒ³åˆ° <strong>diff ç®—æ³•</strong> ã€‚é‚£ <strong>diff ç®—æ³•</strong> å’Œ <strong>vdom</strong> æ˜¯ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ</p><p>å…¶å®ï¼Œ <code>vdom</code> æ˜¯ä¸€ä¸ªå¤§çš„æ¦‚å¿µï¼Œè€Œ <code>diffç®—æ³•</code> æ˜¯ <code>vdom</code> çš„ä¸€éƒ¨åˆ†ï¼Œ <code>vdom</code> çš„æ ¸å¿ƒä»·å€¼åœ¨äº<strong>æœ€å¤§ç¨‹åº¦çš„å‡å°‘ DOM çš„ä½¿ç”¨èŒƒå›´</strong>ï¼Œ <code>vdom</code> é€šè¿‡æŠŠ <code>DOM</code> <strong>ç”¨ JS çš„æ–¹å¼</strong>è¿›è¡Œæ¨¡æ‹Ÿï¼Œä¹‹åè¿›è¡Œè®¡ç®—å’Œå¯¹æ¯”ï¼Œæœ€åæ‰¾å‡ºæœ€å°çš„æ›´æ–°èŒƒå›´å»æ›´æ–°ã€‚é‚£ä¹ˆè¿™ä¸ªå¯¹æ¯”çš„è¿‡ç¨‹å°±æ˜¯ <strong>diff ç®—æ³•</strong> ã€‚ä¹Ÿå°±æ˜¯è¯´ä»–ä»¬ä¸¤è€…æ˜¯<strong>åŒ…å«å…³ç³»</strong>ï¼Œ<strong>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</strong></p><p><img src="https://mondaylab-1309616765.cos.ap-shanghai.myqcloud.com/images/202305270739755.png" alt="vdomå’Œdiffç®—æ³•"></p><p>å¯ä»¥è¯´ï¼Œdiff ç®—æ³•æ˜¯ <code>vdom</code> ä¸­æœ€æ ¸å¿ƒã€æœ€å…³é”®çš„éƒ¨åˆ†ï¼Œæ•´ä¸ª <code>vdom</code> çš„æ ¸å¿ƒåŒ…å›´ç€å¤§é‡çš„ <strong>diff ç®—æ³•</strong> ã€‚</p><p>æœ‰äº†è¿™å‡ ä¸ªæ¦‚å¿µçš„åŸºç¡€é“ºå«ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥å¼€å§‹äº†è§£ <strong>è™šæ‹Ÿ DOM</strong> æ˜¯ä»€ä¹ˆã€‚</p><h2 id="_2ã€çœŸå®-dom-çš„æ¸²æŸ“è¿‡ç¨‹" tabindex="-1">2ã€çœŸå® DOM çš„æ¸²æŸ“è¿‡ç¨‹ <a class="header-anchor" href="#_2ã€çœŸå®-dom-çš„æ¸²æŸ“è¿‡ç¨‹" aria-label="Permalink to &quot;2ã€çœŸå® DOM çš„æ¸²æŸ“è¿‡ç¨‹&quot;">â€‹</a></h2><p>åœ¨å¼€å§‹è®²è§£ <code>è™šæ‹ŸDOM</code> ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£çœŸå®çš„ <code>DOM</code> åœ¨æµè§ˆå™¨ä¸­æ˜¯æ€ä¹ˆè§£æçš„ã€‚æµè§ˆå™¨æ¸²æŸ“å¼•æ“å·¥ä½œæµç¨‹å¤§è‡´åˆ†ä¸ºä»¥ä¸‹<strong>4 ä¸ªæ­¥éª¤ï¼š</strong></p><p><strong>åˆ›å»º DOM æ ‘</strong> â†’ <strong>åˆ›å»º CSSOM æ ‘</strong> â†’ <strong>ç”Ÿæˆ render æ ‘</strong> â†’ <strong>å¸ƒå±€ render æ ‘</strong> â†’ <strong>ç»˜åˆ¶ render æ ‘</strong> ã€‚</p><ul><li>ç¬¬ä¸€æ­¥ï¼šåˆ›å»º <code>DOM</code> æ ‘ã€‚æ¸²æŸ“å¼•æ“é¦–å…ˆè§£æ <code>HTML</code> ä»£ç ï¼Œå¹¶ç”Ÿæˆ <code>DOM</code> æ ‘ã€‚</li><li>ç¬¬äºŒæ­¥ï¼šåˆ›å»º <code>CSSOM</code> æ ‘ã€‚æµè§ˆä¸ºè·å¾—å¤–éƒ¨ <code>css</code> æ–‡ä»¶çš„æ•°æ®åï¼Œå°±ä¼šåƒæ„å»º <code>DOM</code> æ ‘ä¸€æ ·å¼€å§‹æ„å»º <code>CSSOM</code> æ ‘ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸ç¬¬ä¸€æ­¥æ²¡ä»€ä¹ˆå·®åˆ«ã€‚</li><li>ç¬¬ä¸‰æ­¥ï¼šç”Ÿæˆ <code>Render</code> æ ‘ã€‚å°† <code>DOM</code> æ ‘å’Œ <code>CSSOM</code> æ ‘å…³è”èµ·æ¥ï¼Œç”Ÿæˆä¸€æ£µ <code>Render</code> ï¼ˆæ¸²æŸ“ï¼‰æ ‘ã€‚</li><li>ç¬¬å››æ­¥ï¼šå¸ƒå±€ <code>Render</code> æ ‘ã€‚æœ‰äº† <code>Render</code> æ ‘ä¹‹åï¼Œæµè§ˆå™¨å¼€å§‹å¯¹æ¸²æŸ“æ ‘çš„æ¯ä¸ªèŠ‚ç‚¹è¿›è¡Œå¸ƒå±€å¤„ç†ï¼Œç¡®å®šå…¶<strong>åœ¨å±å¹•ä¸Šçš„æ˜¾ç¤ºä½ç½®</strong>ã€‚</li><li>ç¬¬äº”æ­¥ï¼šç»˜åˆ¶ <code>Render</code> æ ‘ã€‚å°†<strong>æ¯ä¸ªèŠ‚ç‚¹</strong>ç»˜åˆ¶åˆ°å±å¹•ä¸Šã€‚</li></ul><p>å¼•ç”¨ç½‘ä¸Šçš„ä¸€å¼ å›¾æ¥å‘ˆç°<strong>çœŸå® DOM çš„æ¸²æŸ“è¿‡ç¨‹ï¼š</strong></p><p><img src="https://mondaylab-1309616765.cos.ap-shanghai.myqcloud.com/images/202305270739063.png" alt="çœŸå®DOMçš„æ¸²æŸ“è¿‡ç¨‹"></p><h2 id="_3ã€è™šæ‹Ÿ-dom-æ˜¯ä»€ä¹ˆ" tabindex="-1">3ã€è™šæ‹Ÿ DOM æ˜¯ä»€ä¹ˆï¼Ÿ <a class="header-anchor" href="#_3ã€è™šæ‹Ÿ-dom-æ˜¯ä»€ä¹ˆ" aria-label="Permalink to &quot;3ã€è™šæ‹Ÿ DOM æ˜¯ä»€ä¹ˆï¼Ÿ&quot;">â€‹</a></h2><p>å½“ç”¨åŸç”Ÿ <code>js</code> æˆ–è€… <code>jq</code> å»æ“ä½œçœŸå® <code>DOM</code> çš„æ—¶å€™ï¼Œæµè§ˆå™¨ä¼š<strong>ä»æ„å»º DOM æ ‘å¼€å§‹</strong>ï¼Œ<strong>ä»å¤´åˆ°å°¾æ‰§è¡Œä¸€éæµç¨‹</strong>ã€‚é‚£è¿™æ ·çš„è¯ï¼Œå°±å¾ˆæœ‰å¯èƒ½å¯¼è‡´<strong>æ“ä½œæ¬¡æ•°è¿‡å¤š</strong>ã€‚å½“æ“ä½œæ¬¡æ•°è¿‡å¤šæ—¶ï¼Œä¹‹å‰è®¡ç®—çš„ä¸ <code>DOM</code> èŠ‚ç‚¹ç›¸å…³çš„åæ ‡å€¼ç­‰å„ç§å€¼å°±......ä¸çŸ¥ä¸è§‰çš„æµªè´¹æ‰äº†å…¶æ€§èƒ½ï¼Œå› æ­¤å‘¢ï¼Œ<strong>è™šæ‹Ÿ DOM ç”±æ­¤äº§ç”Ÿ</strong>ã€‚</p><h2 id="_4ã€è§£å†³æ–¹æ¡ˆ-vdom" tabindex="-1">4ã€è§£å†³æ–¹æ¡ˆ - vdom <a class="header-anchor" href="#_4ã€è§£å†³æ–¹æ¡ˆ-vdom" aria-label="Permalink to &quot;4ã€è§£å†³æ–¹æ¡ˆ - vdom&quot;">â€‹</a></h2><h3 id="_1-é—®é¢˜å¼•å‡º" tabindex="-1">ï¼ˆ1ï¼‰é—®é¢˜å¼•å‡º <a class="header-anchor" href="#_1-é—®é¢˜å¼•å‡º" aria-label="Permalink to &quot;ï¼ˆ1ï¼‰é—®é¢˜å¼•å‡º&quot;">â€‹</a></h3><p>å¤§å®¶éƒ½çŸ¥é“ï¼Œ <code>DOM</code> æ ‘æ˜¯å…·æœ‰ä¸€å®šçš„å¤æ‚åº¦çš„ï¼Œæ‰€ä»¥ï¼Œåœ¨ç”Ÿæˆ <code>DOM</code> æ ‘çš„è¿‡ç¨‹ä¸­ï¼Œä¼šä¸æ–­çš„è¿›è¡Œè®¡ç®—æ“ä½œï¼Œä½†éš¾å°±éš¾åœ¨ï¼Œæƒ³è¦<strong>å‡å°‘è®¡ç®—æ¬¡æ•°</strong>å…¶å®è¿˜æ˜¯æ¯”è¾ƒéš¾çš„ã€‚</p><p>é‚£æ¢ä¸ªæ€è·¯è€ƒè™‘ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ï¼Œ<code> JS</code> çš„æ‰§è¡Œé€Ÿåº¦<strong>å¾ˆå¿«å¾ˆå¿«</strong>ï¼Œé‚£èƒ½ä¸èƒ½å°è¯•ç€æŠŠè¿™ä¸ª<strong>è®¡ç®—</strong>ï¼Œæ›´å¤šçš„è½¬ä¸º<strong>JS è®¡ç®—</strong>å‘¢ï¼Ÿ<strong>ç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚</strong></p><h3 id="_2-vdom-å¦‚ä½•è§£å†³é—®é¢˜-å°†çœŸå®-dom-è½¬ä¸º-js-å¯¹è±¡çš„è®¡ç®—" tabindex="-1">ï¼ˆ2ï¼‰vdom å¦‚ä½•è§£å†³é—®é¢˜ï¼šå°†çœŸå® DOM è½¬ä¸º JS å¯¹è±¡çš„è®¡ç®— <a class="header-anchor" href="#_2-vdom-å¦‚ä½•è§£å†³é—®é¢˜-å°†çœŸå®-dom-è½¬ä¸º-js-å¯¹è±¡çš„è®¡ç®—" aria-label="Permalink to &quot;ï¼ˆ2ï¼‰vdom å¦‚ä½•è§£å†³é—®é¢˜ï¼šå°†çœŸå® DOM è½¬ä¸º JS å¯¹è±¡çš„è®¡ç®—&quot;">â€‹</a></h3><p>å‡è®¾åœ¨ä¸€æ¬¡æ“ä½œä¸­æœ‰<strong>1000 ä¸ªèŠ‚ç‚¹</strong>éœ€è¦æ›´æ–° <code>DOM</code> ï¼Œé‚£ä¹ˆ <strong>è™šæ‹Ÿ DOM</strong> ä¸ä¼šç«‹å³å» <strong>æ“ä½œ DOM</strong> ï¼Œè€Œæ˜¯å°†è¿™ 1000 æ¬¡æ›´æ–°çš„ <code>diff</code> å†…å®¹ä¿å­˜åˆ°æœ¬åœ°çš„ä¸€ä¸ª <code>JS</code> å¯¹è±¡å½“ä¸­ï¼Œä¹‹åå°†è¿™ä¸ª <code>JS </code>å¯¹è±¡ä¸€æ¬¡æ€§ <strong>attach</strong> åˆ° <code>DOM</code> æ ‘ä¸Šï¼Œæœ€åå†è¿›è¡Œåç»­çš„æ“ä½œï¼Œè¿™æ ·å­å°±<strong>é¿å…äº†å¤§é‡æ²¡æœ‰å¿…è¦çš„è®¡ç®—</strong>ã€‚</p><p>æ‰€ä»¥ï¼Œ<strong>ç”¨ JS å¯¹è±¡æ¨¡æ‹Ÿ DOM èŠ‚ç‚¹çš„å¥½å¤„</strong>æ˜¯ï¼Œå…ˆå°†é¡µé¢çš„æ›´æ–°å…¨éƒ¨åæ˜ åˆ°è™šæ‹Ÿ <code>DOM</code> ä¸Šï¼Œè¿™æ ·å­å°±å…ˆ**<u>æ“ä½œå†…å­˜ä¸­çš„ JS å¯¹è±¡</u>**ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæ“ä½œå†…å­˜ä¸­ <code>JS</code> å¯¹è±¡çš„é€Ÿåº¦æ˜¯ç›¸å½“å¿«çš„ã€‚å› æ­¤ï¼Œç­‰åˆ°å…¨éƒ¨ <strong>DOM èŠ‚ç‚¹</strong> æ›´æ–°å®Œæˆä¹‹åï¼Œå†å°† <strong>æœ€åçš„ JS å¯¹è±¡</strong> æ˜ å°„åˆ° <strong>çœŸå®çš„ DOM</strong> ä¸Šï¼Œäº¤ç”± <strong>æµè§ˆå™¨</strong> å»ç»˜åˆ¶ã€‚</p><p>è¿™æ ·ï¼Œå°±è§£å†³äº†çœŸå® <code>DOM</code> <strong>æ¸²æŸ“é€Ÿåº¦æ…¢</strong>ï¼Œ<strong>æ€§èƒ½æ¶ˆè€—å¤§</strong>çš„é—®é¢˜ã€‚</p><h2 id="_5ã€ç”¨-js-æ¨¡æ‹Ÿä¸€ä¸ª-dom-ç»“æ„" tabindex="-1">5ã€ç”¨ JS æ¨¡æ‹Ÿä¸€ä¸ª DOM ç»“æ„ <a class="header-anchor" href="#_5ã€ç”¨-js-æ¨¡æ‹Ÿä¸€ä¸ª-dom-ç»“æ„" aria-label="Permalink to &quot;5ã€ç”¨ JS æ¨¡æ‹Ÿä¸€ä¸ª DOM ç»“æ„&quot;">â€‹</a></h2><p>æ ¹æ®ä¸‹æ–¹çš„ <code>html</code> ä»£ç ï¼Œç”¨ <code>v-node</code> æ¨¡æ‹Ÿå‡ºè¯¥ <code>html</code> ä»£ç çš„ <code>DOM</code> ç»“æ„ã€‚</p><p><strong>html ä»£ç ï¼š</strong></p><div class="language-html line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">id</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">div1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">class</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">container</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">p</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">vdom</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">p</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">ul</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">style</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">font-size:20px;</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">li</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">a</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">li</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">ul</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>ç”¨ JS æ¨¡æ‹Ÿå‡ºä»¥ä¸Šä»£ç çš„ DOM ç»“æ„ï¼š</strong></p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#FFCB6B;">tag</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">div</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">props</span><span style="color:#89DDFF;">:{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#FFCB6B;">className</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">container</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#FFCB6B;">id</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">div1</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">children</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> [</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">            tag</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">p</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">            chindren</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">vdom</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">            tag</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">ul</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">            props</span><span style="color:#89DDFF;">:{</span><span style="color:#F07178;"> style</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">font-size: 20px</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#F07178;">            children</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> [</span></span>
<span class="line"><span style="color:#F07178;">                </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">                    tag</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">li</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">                    children</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">a</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#F07178;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">                </span><span style="color:#676E95;font-style:italic;">// ....</span></span>
<span class="line"><span style="color:#F07178;">            ]</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    ]</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>é€šè¿‡ä»¥ä¸Šä»£ç æˆ‘ä»¬å¯ä»¥åˆ†æå‡ºï¼Œæˆ‘ä»¬ç”¨ <code>tag</code> ï¼Œ <code>props</code> å’Œ <code>children</code> æ¥æ¨¡æ‹Ÿ <code>DOM</code> æ ‘ç»“æ„ã€‚ç”¨ <code>JS</code> æ¨¡æ‹Ÿ <code>DOM</code> æ ‘çš„ç»“æ„ï¼Œè¿™æ ·åšçš„å¥½å¤„åœ¨äºï¼Œå¯ä»¥è®¡ç®—å‡º<strong>æœ€å°çš„å˜æ›´</strong>ï¼Œæ“ä½œ<strong>æœ€å°‘çš„ DOM</strong>ã€‚</p><h2 id="_6ã€é€šè¿‡-snabbdom-å­¦ä¹ -vdom" tabindex="-1">6ã€é€šè¿‡ snabbdom å­¦ä¹  vdom <a class="header-anchor" href="#_6ã€é€šè¿‡-snabbdom-å­¦ä¹ -vdom" aria-label="Permalink to &quot;6ã€é€šè¿‡ snabbdom å­¦ä¹  vdom&quot;">â€‹</a></h2><p><code>vue</code> çš„ <strong>vdom</strong> å’Œ <strong>diff ç®—æ³•</strong> æ˜¯å‚è€ƒ <code>github</code> ä¸Šçš„ä¸€ä¸ªå¼€æºåº“ <a href="https://github.com/snabbdom/snabbdom" target="_blank" rel="noreferrer">snabbdom</a> æ”¹é€ è¿‡æ¥çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥ä¸‹æ¥å°±ç”¨è¿™ä¸ªåº“ä¸ºä¾‹ï¼Œæ¥å­¦ä¹  <code>vdom</code> çš„æ€æƒ³ã€‚</p><h3 id="_1-snabbdom-æ˜¯ä»€ä¹ˆ" tabindex="-1">ï¼ˆ1ï¼‰snabbdom æ˜¯ä»€ä¹ˆ <a class="header-anchor" href="#_1-snabbdom-æ˜¯ä»€ä¹ˆ" aria-label="Permalink to &quot;ï¼ˆ1ï¼‰snabbdom æ˜¯ä»€ä¹ˆ&quot;">â€‹</a></h3><ul><li><code>snabbdom</code> æ˜¯ä¸€ä¸ªç®€æ´åˆå¼ºå¤§çš„ <code>vdom</code> åº“ï¼Œæ˜“å­¦æ˜“ç”¨ï¼›</li><li><code>Vue</code> å‚è€ƒå®ƒå®ç°çš„ <code>vdom</code> å’Œ <code>diff</code> ï¼›</li><li><code>Vue3.0</code> é‡å†™äº† <code>vdom</code> çš„ä»£ç ï¼Œä¼˜åŒ–äº†æ€§èƒ½ã€‚</li></ul><h3 id="_2-snabbdom-æµ…æ" tabindex="-1">ï¼ˆ2ï¼‰snabbdom æµ…æ <a class="header-anchor" href="#_2-snabbdom-æµ…æ" aria-label="Permalink to &quot;ï¼ˆ2ï¼‰snabbdom æµ…æ&quot;">â€‹</a></h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹ <code>snabbdom</code> é¦–é¡µä¸Šçš„ <code>example</code> ï¼Œå…ˆç®€å•äº†è§£å…¶æ€æƒ³ã€‚<strong>ä¸‹é¢å…ˆè´´ä¸Šä»£ç ï¼š</strong></p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">init</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">classModule</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">propsModule</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">styleModule</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">eventListenersModule</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">h</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">snabbdom</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> patch </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">init</span><span style="color:#A6ACCD;">([</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// Init patch function with chosen modules</span></span>
<span class="line"><span style="color:#A6ACCD;">  classModule</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// makes it easy to toggle classes</span></span>
<span class="line"><span style="color:#A6ACCD;">  propsModule</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// for setting properties on DOM elements</span></span>
<span class="line"><span style="color:#A6ACCD;">  styleModule</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// handles styling on elements with support for animations</span></span>
<span class="line"><span style="color:#A6ACCD;">  eventListenersModule</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// attaches event listeners</span></span>
<span class="line"><span style="color:#A6ACCD;">])</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> container </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> document</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getElementById</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">container</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//hå‡½æ•°è¾“å…¥ä¸€ä¸ªæ ‡ç­¾ï¼Œä¹‹åå†è¾“å…¥ä¸€ä¸ªdataï¼Œæœ€å‘¨è¾“å…¥ä¸€ä¸ªå­å…ƒç´ </span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> vnode </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">h</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">div#container.two.classes</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">on</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">click</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> someFn </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">},</span><span style="color:#A6ACCD;"> [</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#82AAFF;">h</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">span</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">style</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">fontWeight</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">bold</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">},</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">This is bold</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;"> and this is just normal text</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#82AAFF;">h</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">a</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">props</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">href</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">/foo</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">},</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">I&#39;ll take you places!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">])</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//ç¬¬ä¸€ä¸ªpatchå‡½æ•°</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// Patch into empty DOM element â€“ this modifies the DOM as a side effect</span></span>
<span class="line"><span style="color:#82AAFF;">patch</span><span style="color:#A6ACCD;">(container</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> vnode)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> newVnode </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">h</span><span style="color:#A6ACCD;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">div#container.two.classes</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">on</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">click</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> anotherEventHandler </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#A6ACCD;">  [</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">h</span><span style="color:#A6ACCD;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">span</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">style</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">fontWeight</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">normal</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">fontStyle</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">italic</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">This is now italic type</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">    )</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;"> and this is still just normal text</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">h</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">a</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">props</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">href</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">/bar</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">},</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">I&#39;ll take you places!</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  ]</span></span>
<span class="line"><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//ç¬¬äºŒä¸ªpatchå‡½æ•°</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// Second \`patch\` invocation</span></span>
<span class="line"><span style="color:#82AAFF;">patch</span><span style="color:#A6ACCD;">(vnode</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> newVnode)</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// Snabbdom efficiently updates the old view to the new state</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>é€šè¿‡å®˜æ–¹çš„ä¾‹å­æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œ <code>h</code> å‡½æ•°è¾“å…¥ä¸€ä¸ªæ ‡ç­¾ï¼Œä¹‹åè¾“å…¥ä¸€ä¸ª <code>data</code> ï¼Œæœ€åè¾“å…¥ä¸€ä¸ªå­å…ƒç´ ã€‚å¹¶ä¸” h å‡½æ•°æ˜¯ä¸€ä¸ª <code>vnode</code> çš„ç»“æ„ï¼ˆ <code>vnode</code> ç»“æ„è§ä¸Šè¿°ç¬¬ 5 ç‚¹ï¼‰ï¼Œå±‚çº§èˆ¬çš„ä¸€å±‚ä¸€å±‚é€’è¿›ã€‚æœ€åå°±æ˜¯ <code>patch</code> å‡½æ•°ï¼Œç¬¬ä¸€ä¸ª<code>patch</code> å‡½æ•°ç”¨æ¥å¯¹å…ƒç´ è¿›è¡Œæ¸²æŸ“ï¼Œç¬¬äºŒä¸ª <code>patch</code> å‡½æ•°ç”¨æ¥<strong>æ¯”è¾ƒæ–°æ—§èŠ‚ç‚¹</strong>ã€‚</p><h3 id="_2-snabbdom-æ¼”ç¤º" tabindex="-1">ï¼ˆ2ï¼‰snabbdom æ¼”ç¤º <a class="header-anchor" href="#_2-snabbdom-æ¼”ç¤º" aria-label="Permalink to &quot;ï¼ˆ2ï¼‰snabbdom æ¼”ç¤º&quot;">â€‹</a></h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬ç”¨ <code>cdn</code> çš„æ–¹å¼å¼•å…¥ <code>snabbdom</code> çš„åº“ï¼Œæ¥æ¼”ç¤ºä¸€é <code>snabbdom</code> æ˜¯å¦‚ä½•æ“ä½œ <code>vdom</code> çš„ã€‚<strong>é™„ä¸Šä»£ç ï¼š</strong></p><div class="language-html line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">&lt;!</span><span style="color:#F07178;">DOCTYPE</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">html</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">html</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">head</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">meta</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">charset</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">UTF-8</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> /&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">title</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">Document</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">title</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">head</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">body</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">id</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">container</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;&lt;/</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">button</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">id</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">btn-change</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">change</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">button</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    &lt;</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">src</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">https://cdn.bootcss.com/snabbdom/0.7.3/snabbdom.js</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;&lt;/</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">    &lt;</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">src</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">https://cdn.bootcss.com/snabbdom/0.7.3/snabbdom-class.js</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;&lt;/</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">    &lt;</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">src</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">https://cdn.bootcss.com/snabbdom/0.7.3/snabbdom-props.js</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;&lt;/</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">    &lt;</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">src</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">https://cdn.bootcss.com/snabbdom/0.7.3/snabbdom-style.js</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;&lt;/</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">    &lt;</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">src</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">https://cdn.bootcss.com/snabbdom/0.7.3/snabbdom-eventlisteners.js</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;&lt;/</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">    &lt;</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">src</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">https://cdn.bootcss.com/snabbdom/0.7.3/h.js</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;&lt;/</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    &lt;</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> snabbdom </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> window</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">snabbdom</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// å®šä¹‰ patch</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> patch </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> snabbdom</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">init</span><span style="color:#A6ACCD;">([</span></span>
<span class="line"><span style="color:#A6ACCD;">        snabbdom_class</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        snabbdom_props</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        snabbdom_style</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        snabbdom_eventlisteners</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">      ])</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// å®šä¹‰ h</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> h </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> snabbdom</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">h</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> container </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> document</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getElementById</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">container</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// ç”Ÿæˆ vnode</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> vnode </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">h</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">ul#list</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{},</span><span style="color:#A6ACCD;"> [</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">h</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">li.item</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{},</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Item 1</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">h</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">li.item</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{},</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Item 2</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">      ])</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#82AAFF;">patch</span><span style="color:#A6ACCD;">(container</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> vnode)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">      document</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getElementById</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">btn-change</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">addEventListener</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">click</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// ç”Ÿæˆ newVnode</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newVnode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">h</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">ul#list</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{},</span><span style="color:#F07178;"> [</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#82AAFF;">h</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">li.item</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{},</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Item 1</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#82AAFF;">h</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">li.item</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{},</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Item B</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#82AAFF;">h</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">li.item</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{},</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Item 3</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">        ])</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">patch</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">vnode</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newVnode</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// vnode = newVnode â†’ patch ä¹‹åï¼Œåº”è¯¥ç”¨æ–°çš„è¦†ç›–ç°æœ‰çš„ vnode ï¼Œå¦åˆ™æ¯æ¬¡ change éƒ½æ˜¯æ–°æ—§å¯¹æ¯”</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">body</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">html</span><span style="color:#89DDFF;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p><strong>æ­¤æ—¶æˆ‘ä»¬æ¥çœ‹æµè§ˆå™¨çš„æ˜¾ç¤ºæ•ˆæœï¼š</strong></p><p><img src="https://mondaylab-1309616765.cos.ap-shanghai.myqcloud.com/images/202305270739372.gif" alt="snabbdomæ¼”ç¤º"></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæœ€ç»ˆçš„æ•ˆæœæ˜¯å½“æˆ‘ä»¬ç‚¹å‡»æ—¶ï¼Œ <code>DOM</code> æ ‘<strong>ä¸ä¼šä¸€æ•´æ£µæ ‘é‡æ–°æ¸²æŸ“</strong>ï¼Œè€Œæ˜¯åªé’ˆå¯¹<strong>æ”¹å˜çš„å€¼</strong>è¿›è¡Œé‡æ–°æ¯”è¾ƒï¼Œæœ€ç»ˆåªå°†æ”¹å˜çš„èŠ‚ç‚¹è¿›è¡Œæ¸²æŸ“ã€‚</p><p>é€šè¿‡è¿™æ ·çš„æ¼”ç¤ºï¼Œç›¸ä¿¡å¤§å®¶å¯¹çœŸå® <code>DOM</code> å’Œè™šæ‹Ÿ <code>DOM</code> çš„åŒºåˆ«æœ‰äº†ä¸€å®šçš„äº†è§£ã€‚</p><h2 id="_7ã€vdom-æ€»ç»“" tabindex="-1">7ã€vdom æ€»ç»“ <a class="header-anchor" href="#_7ã€vdom-æ€»ç»“" aria-label="Permalink to &quot;7ã€vdom æ€»ç»“&quot;">â€‹</a></h2><p><strong>è®²åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬æ¥å¯¹ vdom åšä¸€ä¸ªæ€»ç»“ï¼š</strong></p><ul><li>å¯ä»¥é€šè¿‡ <code>JS</code> æ¥æ¨¡æ‹Ÿ <code>DOM</code> ç»“æ„ï¼ˆvnodeï¼‰ï¼›</li><li>æ–°æ—§ <code>vnode</code> å¯¹æ¯”ï¼Œå¾—å‡º<strong>æœ€å°çš„æ›´æ–°èŒƒå›´</strong>ï¼Œæœ€å<strong>æ›´æ–° DOM</strong>ï¼›</li><li>æ•°æ®é©±åŠ¨è§†å›¾çš„æ¨¡å¼ä¸‹ï¼Œå¯ä»¥æœ‰æ•ˆåœ°æ§åˆ¶<strong>DOM æ“ä½œ</strong>ã€‚</li></ul><h1 id="äºŒã€diff-ç®—æ³•" tabindex="-1">äºŒã€diff ç®—æ³• <a class="header-anchor" href="#äºŒã€diff-ç®—æ³•" aria-label="Permalink to &quot;äºŒã€diff ç®—æ³•&quot;">â€‹</a></h1><p>æˆ‘ä»¬åœ¨ä¸Šè¿°è®² <code>vdom</code> çš„æ—¶å€™è¯´è¿‡ï¼Œ <code>vdom</code> çš„æ ¸å¿ƒä»·å€¼å°±åœ¨äºæœ€å¤§ç¨‹åº¦çš„<strong>å‡å°‘ DOM çš„ä½¿ç”¨èŒƒå›´</strong>ã€‚é‚£ <code>vdom</code> æ˜¯é€šè¿‡ä»€ä¹ˆæ–¹å¼å‘¢ï¼Œå®ƒæ˜¯é€šè¿‡æŠŠ <code>DOM</code> ç”¨ <code>JS</code> æ¥å»æ¨¡æ‹Ÿï¼Œä¹‹åè¿›è¡Œè®¡ç®—å’Œè¿›è¡Œå¯¹æ¯”ï¼Œæœ€åæ‰¾å‡ºæœ€å°çš„æ›´æ–°èŒƒå›´å»æ›´æ–°ã€‚é‚£ä¹ˆè¿™ä¸ªå¯¹æ¯”çš„è¿‡ç¨‹å¯¹åº”çš„å°±æ˜¯æˆ‘ä»¬ç»å¸¸å¬åˆ°çš„ <code>diff</code> ç®—æ³•ã€‚</p><p>æ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬ä¸€èµ·æ¥äº†è§£ <code>vdom</code> çš„å¦å¤–ä¸€ä¸ªå†…å®¹ï¼Œ <code>diff</code> ç®—æ³•ã€‚</p><h2 id="_1ã€diff-ç®—æ³•" tabindex="-1">1ã€diff ç®—æ³• <a class="header-anchor" href="#_1ã€diff-ç®—æ³•" aria-label="Permalink to &quot;1ã€diff ç®—æ³•&quot;">â€‹</a></h2><ul><li><p>diff ç®—æ³•æ˜¯å‰ç«¯çš„ä¸€ä¸ªçƒ­é—¨è¯é¢˜ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ <code>vdom</code> ä¸­æœ€æ ¸å¿ƒã€æœ€å…³é”®çš„éƒ¨åˆ†ã€‚</p></li><li><p>diff ç®—æ³•åœ¨æ—¥å¸¸ä½¿ç”¨ <code>vue</code> å’Œ <code>react</code> ä¸­ç»å¸¸å‡ºç°ï¼ˆå¦‚<strong>key</strong>ï¼‰ã€‚</p></li></ul><h2 id="_2ã€diff-ç®—æ³•æ¦‚è¿°" tabindex="-1">2ã€diff ç®—æ³•æ¦‚è¿° <a class="header-anchor" href="#_2ã€diff-ç®—æ³•æ¦‚è¿°" aria-label="Permalink to &quot;2ã€diff ç®—æ³•æ¦‚è¿°&quot;">â€‹</a></h2><ul><li><code>diff</code> å³<strong>å¯¹æ¯”</strong>ï¼Œæ˜¯ä¸€ä¸ª<strong>å¹¿æ³›çš„</strong>æ¦‚å¿µï¼Œå¦‚<strong>linux diff å‘½ä»¤</strong>ã€<strong>git diff å‘½ä»¤</strong>ç­‰ã€‚</li><li>ä¸¤ä¸ª js å¯¹è±¡ä¹Ÿå¯ä»¥åš <code>diff</code> ï¼Œå¦‚ <code>github</code> ä¸Šçš„<a href="https://github.com/cujojs/jiff" target="_blank" rel="noreferrer">jiff åº“</a>ï¼Œè¿™ä¸ªåº“å¯ä»¥ç›´æ¥ç”¨æ¥ç»™ä¸¤ä¸ª js å¯¹è±¡åš diffã€‚</li><li>ä¸¤æ£µæ ‘åš <code>diff</code> ï¼Œå¦‚ä¸Šè¿°æ‰€è¯´çš„ <code>vdom</code> å’Œ <code>diff</code> ã€‚</li></ul><p><strong>æˆ‘ä»¬æ¥çœ‹ä¸ªä¾‹å­ ğŸŒ°ï¼š</strong></p><p><img src="https://mondaylab-1309616765.cos.ap-shanghai.myqcloud.com/images/202305270740884.png" alt="æ ‘çš„å¯¹æ¯”"></p><p>çœ‹åˆ°ä¸Šé¢ä¸¤æ£µæ ‘ï¼Œæˆ‘ä»¬å¯ä»¥æƒ³è±¡ä¸‹å®ƒæ˜¯å¦‚ä½•è¿›è¡Œ <code>diff</code> ç®—æ³•çš„ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå³è¾¹è¿™æ£µæ ‘è¦æŠŠå·¦è¾¹çš„ <code>E</code> æ”¹ä¸º <code>X</code> ï¼ŒåŒæ—¶è¦æ–°å¢ä¸€ä¸ªèŠ‚ç‚¹ <code>H</code> ã€‚å› æ­¤å¦‚æœé€šè¿‡ <code>diff</code> æ¥å®ç°çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹å…¶è¿›è¡Œ<strong>æ–°æ—§èŠ‚ç‚¹çš„æ¯”è¾ƒ</strong>ï¼Œå¦‚æœæ¯”è¾ƒå®Œä¸€æ ·ï¼Œåˆ™ä¸åŠ¨å®ƒï¼›å¦‚æœæ¯”è¾ƒå®Œä¸ä¸€æ ·ï¼Œåˆ™å¯¹å®ƒè¿›è¡Œä¿®æ”¹ã€‚è¿™æ ·å¤„ç†çš„è¯ï¼Œ<strong>5 ä¸ªèŠ‚ç‚¹åªéœ€è¦ä¿®æ”¹ 2 æ¬¡</strong>ï¼Œè€Œä¸ç”¨ä¿®æ”¹ 5 æ¬¡ï¼Œæ•ˆç‡å¾ˆæ˜¯ UpUpã€‚</p><h2 id="_3ã€æ ‘-diff-çš„æ—¶é—´å¤æ‚åº¦-o-n3" tabindex="-1">3ã€æ ‘ diff çš„æ—¶é—´å¤æ‚åº¦ O(n<sup>3</sup>) <a class="header-anchor" href="#_3ã€æ ‘-diff-çš„æ—¶é—´å¤æ‚åº¦-o-n3" aria-label="Permalink to &quot;3ã€æ ‘ diff çš„æ—¶é—´å¤æ‚åº¦ O(n&lt;sup&gt;3&lt;/sup&gt;)&quot;">â€‹</a></h2><p>å¯¹äºæ ‘æ¥è¯´ï¼ŒåŸå§‹çš„æ—¶é—´å¤æ‚åº¦æœ‰<strong>O(n<sup>3</sup>)</strong>ã€‚é‚£ä¹ˆè¿™ä¸ª <strong>O(n<sup>3</sup>)</strong> æ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿ</p><p><strong>é¦–å…ˆ</strong>ï¼Œéå† tree1ï¼›<strong>å…¶æ¬¡</strong>ï¼Œéå† tree2ï¼›<strong>æœ€å</strong>ï¼Œå¯¹æ ‘è¿›è¡Œæ’åºã€‚è¿™æ · <code>n*n*n</code> ï¼Œå°±è¾¾åˆ°äº†<strong>O(n<sup>3</sup>)</strong>ã€‚</p><p>å‡è®¾ç°åœ¨æœ‰ 1000 ä¸ªèŠ‚ç‚¹è¦æ“ä½œï¼Œé‚£ 1000 çš„ 3 æ¬¡æ–¹å°±<strong>1 äº¿æ¬¡</strong>äº†ï¼Œå› æ­¤ï¼Œæ ‘çš„è¿™ä¸ªç®—æ³•ä¸å¯ç”¨ã€‚é‚£æˆ‘ä»¬æ€ä¹ˆè§£å†³å‘¢ï¼Ÿç»§ç»­çœ‹ä¸‹é¢ã€‚</p><h2 id="_4ã€ä¼˜åŒ–æ—¶é—´å¤æ‚åº¦åˆ°-o-n" tabindex="-1">4ã€ä¼˜åŒ–æ—¶é—´å¤æ‚åº¦åˆ° O(n) <a class="header-anchor" href="#_4ã€ä¼˜åŒ–æ—¶é—´å¤æ‚åº¦åˆ°-o-n" aria-label="Permalink to &quot;4ã€ä¼˜åŒ–æ—¶é—´å¤æ‚åº¦åˆ° O(n)&quot;">â€‹</a></h2><p>å› ä¸ºæ ‘çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(n<sup>3</sup>)ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å°±æƒ³åŠæ³•ï¼Œä¼˜åŒ–å…¶æ—¶é—´å¤æ‚åº¦<strong>ä» O(n<sup>3</sup>)åˆ° O(n)</strong>ï¼Œä»¥è¾¾åˆ°æ“ä½œ <code>vdom</code> èŠ‚ç‚¹ï¼Œé‚£è¿™ä¸ªä¼˜åŒ–è¿‡ç¨‹å…¶å®æˆ‘ä»¬æ‰€è¯´çš„ <code>diff</code> ç®—æ³•ã€‚é€šè¿‡ <code>diff</code> ç®—æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ—¶é—´å¤æ‚åº¦<strong>ä» O(n<sup>3</sup>)ä¼˜åŒ–åˆ° O(n)</strong>ã€‚<strong>diff ç®—æ³•çš„å…·ä½“æ€æƒ³å¦‚ä¸‹ï¼š</strong></p><ul><li>åªæ¯”è¾ƒ<strong>åŒä¸€å±‚çº§</strong>ï¼Œ<strong>ä¸è·¨çº§æ¯”è¾ƒ</strong>ï¼›</li><li><code>tag</code> ä¸ç›¸åŒï¼Œåˆ™ç›´æ¥åˆ æ‰é‡å»ºï¼Œä¸å†æ·±åº¦æ¯”è¾ƒï¼›</li><li><code>tag</code> å’Œ <code>key</code> ï¼Œä¸¤è€…éƒ½ç›¸åŒï¼Œåˆ™è®¤ä¸ºæ˜¯<strong>ç›¸åŒèŠ‚ç‚¹</strong>ï¼Œä¸å†æ·±åº¦æ¯”è¾ƒã€‚</li></ul><h1 id="ä¸‰ã€æ·±å…¥-diff-ç®—æ³•æºç " tabindex="-1">ä¸‰ã€æ·±å…¥ diff ç®—æ³•æºç  <a class="header-anchor" href="#ä¸‰ã€æ·±å…¥-diff-ç®—æ³•æºç " aria-label="Permalink to &quot;ä¸‰ã€æ·±å…¥ diff ç®—æ³•æºç &quot;">â€‹</a></h1><h2 id="_1ã€ç”Ÿæˆ-vnode" tabindex="-1">1ã€ç”Ÿæˆ vnode <a class="header-anchor" href="#_1ã€ç”Ÿæˆ-vnode" aria-label="Permalink to &quot;1ã€ç”Ÿæˆ vnode&quot;">â€‹</a></h2><p>æˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸‹ä¸Šé¢è®²çš„ <code>snabbdom</code> ï¼Œ <code>diff</code> æ¯”è¾ƒå…ˆæ˜¯åœ¨ <code>h</code> å‡½æ•°é‡Œé¢è¿›è¡Œï¼Œè¿™ä¸ª <code>h</code> å‡½æ•°è¾“å…¥ä¸€ä¸ªæ ‡ç­¾ï¼Œä¹‹åè¾“å…¥ä¸€ä¸ª <code>data</code> ï¼Œæœ€åè¾“å…¥ä¸€ä¸ªå­å…ƒç´ ã€‚å¹¶ä¸” <code>h</code> å‡½æ•°æ˜¯ä¸€ä¸ª <code>vnode</code> çš„ç»“æ„ï¼Œå±‚çº§èˆ¬çš„ä¸€å±‚ä¸€å±‚é€’è¿›ã€‚æœ€åå°±æ˜¯ <code>patch</code> å‡½æ•°ï¼Œ ç¬¬ä¸€ä¸ª<code>patch</code> å‡½æ•°ç”¨æ¥å¯¹å…ƒç´ è¿›è¡Œæ¸²æŸ“ï¼Œç¬¬äºŒä¸ª <code>patch</code> å‡½æ•°ç”¨æ¥<strong>æ¯”è¾ƒæ–°æ—§èŠ‚ç‚¹</strong>ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒæ˜¯å¦‚ä½•ç”Ÿæˆ vnode çš„ã€‚</p><p>å…ˆå…‹éš†ä¸€ä»½<a href="https://github.com/snabbdom/snabbdom" target="_blank" rel="noreferrer">snabbdom</a>çš„ä»£ç ä¸‹æ¥ï¼Œæ‰“å¼€ <code>src|h.ts</code> æ–‡ä»¶ï¼Œç›´æ¥æ¥çœ‹ <code>h</code> å‡½æ•°ï¼Œ<strong>å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</strong></p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">h</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">sel</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">VNode</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">h</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">sel</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">VNodeData</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">null</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">VNode</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">h</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">sel</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">children</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">VNodeChildren</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">VNode</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">h</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#A6ACCD;font-style:italic;">sel</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">VNodeData</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">null</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#A6ACCD;font-style:italic;">children</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">VNodeChildren</span></span>
<span class="line"><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">VNode</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">h</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">sel</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">b</span><span style="color:#89DDFF;">?:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">c</span><span style="color:#89DDFF;">?:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">VNode</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">data</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">VNodeData</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{};</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">children</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">text</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">number</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">c</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">undefined</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">b</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">data</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">b</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">is</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">array</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">c</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">children</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">c</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">is</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">primitive</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">c</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">text</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">c</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">c</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">c</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">sel</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">children</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> [</span><span style="color:#A6ACCD;">c</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">b</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">undefined</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">b</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">is</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">array</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">b</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">children</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">b</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">is</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">primitive</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">b</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">text</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">b</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">b</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">b</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">sel</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">children</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> [</span><span style="color:#A6ACCD;">b</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">data</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">b</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">children</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">undefined</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">i</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">i</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">children</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">++</span><span style="color:#A6ACCD;">i</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">is</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">primitive</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">children</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">i</span><span style="color:#F07178;">]))</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">children</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">i</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">vnode</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#89DDFF;">undefined,</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#89DDFF;">undefined,</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#89DDFF;">undefined,</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#A6ACCD;">children</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">i</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#89DDFF;">undefined</span></span>
<span class="line"><span style="color:#F07178;">        )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">sel</span><span style="color:#F07178;">[</span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">s</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">sel</span><span style="color:#F07178;">[</span><span style="color:#F78C6C;">1</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">v</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">sel</span><span style="color:#F07178;">[</span><span style="color:#F78C6C;">2</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">g</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span></span>
<span class="line"><span style="color:#F07178;">    (</span><span style="color:#A6ACCD;">sel</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">3</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">sel</span><span style="color:#F07178;">[</span><span style="color:#F78C6C;">3</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">sel</span><span style="color:#F07178;">[</span><span style="color:#F78C6C;">3</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">#</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  ) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">addNS</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">data</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">children</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">sel</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// è¿”å›vnodeï¼Œè¿™ä¸ªvnodeå¯¹åº”patchä¸‹çš„vnode</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">vnode</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">sel</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">data</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">children</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">text</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">undefined</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><p>æˆ‘ä»¬çœ‹åˆ°æœ€åä¸€è¡Œï¼Œ <code>h</code> å‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ª <code>vnode</code> å‡½æ•°ã€‚ä¹‹åæˆ‘ä»¬ç»§ç»­æ‰¾ <code>vnode</code> çš„æ–‡ä»¶ï¼Œåœ¨ <code>src|vnode.ts</code> æ–‡ä»¶ä¸­ã€‚<strong>é™„ä¸Šæœ€å…³é”®éƒ¨åˆ†ä»£ç ï¼š</strong></p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">vnode</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#A6ACCD;font-style:italic;">sel</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">undefined</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">undefined</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#A6ACCD;font-style:italic;">children</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Array</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">VNode</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">undefined</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#A6ACCD;font-style:italic;">text</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">undefined</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#A6ACCD;font-style:italic;">elm</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Element</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Text</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">undefined</span></span>
<span class="line"><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">VNode</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">key</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">data</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">undefined</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">undefined</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">key</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// è¿”å›ä¸€ä¸ªå¯¹è±¡</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// elmè¡¨ç¤ºvnodeç»“æ„å¯¹åº”çš„æ˜¯å“ªä¸€ä¸ªDOMå…ƒç´ </span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// keyå¯ä»¥ç†è§£ä¸ºv-foræ—¶æˆ‘ä»¬ä½¿ç”¨çš„key</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">sel</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">data</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">children</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">text</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">elm</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">key</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>åŒæ ·å®šä½åˆ°æœ€åä¸€è¡Œï¼Œå¤§å®¶å¯ä»¥å‘ç°ï¼Œ <code>vnode</code> å®é™…ä¸Šæ˜¯è¿”å›ä¸€ä¸ªå¯¹è±¡ã€‚è€Œè¿™ä¸ªå¯¹è±¡é‡Œï¼Œæœ‰ 6 ä¸ªå…ƒç´ ã€‚å…¶ä¸­ï¼Œ <code>sel, data, children, text</code> å››ä¸ªå…ƒç´ å¯¹åº”æˆ‘ä»¬ä¸Šé¢è®² <code>vnode</code> æ—¶å¯¹åº”çš„ç»“æ„ï¼ˆç¬¬ä¸€ç‚¹çš„ç¬¬ 5 ç‚¹ï¼‰ã€‚è€Œ <code>elm</code> è¡¨ç¤º <code>vnode</code> ç»“æ„å¯¹åº”çš„æ˜¯å“ªä¸€ä¸ª <code>DOM</code> å…ƒç´ ï¼Œæœ€åçš„ <code>key</code> å¤§å®¶å¯ä»¥ç†è§£ä¸ºæ˜¯æˆ‘ä»¬ä½¿ç”¨ <code>v-for</code> æ—¶ç”¨çš„ <code>key</code> ï¼ŒåŒæ—¶éœ€è¦æ³¨æ„æ˜¯ï¼Œ <code>key</code> ä¸ä¸€å®šåªæœ‰åœ¨ <code>v-for</code> æ—¶å¯ä»¥ä½¿ç”¨ï¼Œåœ¨å®šä¹‰ç»„ä»¶ç­‰å„ç§åœºæ™¯æ—¶å‡å¯ä½¿ç”¨ã€‚</p><h2 id="_2ã€patch-å‡½æ•°" tabindex="-1">2ã€patch å‡½æ•° <a class="header-anchor" href="#_2ã€patch-å‡½æ•°" aria-label="Permalink to &quot;2ã€patch å‡½æ•°&quot;">â€‹</a></h2><p>çœ‹å®Œ <code>vnode</code> ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å¦‚ä½•ç”¨ patch å‡½æ•°æ¥å¯¹æ¯” <code>vnode</code> ã€‚ä»å®˜æ–¹æ–‡æ¡£ä¸­æˆ‘ä»¬å¯ä»¥å®šä½åˆ°ï¼Œ <code>patch</code> å‡½æ•°åœ¨ <code>src|init.ts</code> æ–‡ä»¶ä¸‹ï¼Œæˆ‘ä»¬æ‰¾åˆ° <code>init.ts</code> æ–‡ä»¶ã€‚åŒæ ·ï¼Œæˆ‘ä»¬å®šä½åˆ° <code>patch</code> å‡½æ•°éƒ¨åˆ†ï¼Œ<strong>å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</strong></p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// è¿”å›ä¸€ä¸ªpatchå‡½æ•°</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">patch</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">oldVnode</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">VNode</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Element</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">vnode</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">VNode</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">VNode</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">number</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">elm</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">Node</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">parent</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">Node</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">insertedVnodeQueue</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">VNodeQueue</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> []</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// æ‰§è¡Œpre hookï¼Œhook å³ DOM èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸ</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">i</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">i</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">cbs</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">pre</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">++</span><span style="color:#A6ACCD;">i</span><span style="color:#F07178;">) </span><span style="color:#A6ACCD;">cbs</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">pre</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">i</span><span style="color:#F07178;">]()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// ç¬¬ä¸€ä¸ªå‚æ•°ä¸æ˜¯vnodeï¼Œæ˜¯ä¸€ä¸ªDOMå…ƒç´ </span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#82AAFF;">isVnode</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">oldVnode</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// åˆ›å»ºä¸€ä¸ªç©ºçš„ vnodeï¼Œå…³è”åˆ°è¿™ä¸ªDOMå…ƒç´ </span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">oldVnode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">emptyNodeAt</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">oldVnode</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// ç›¸åŒçš„vnodeï¼ˆkey å’Œ sel éƒ½ç›¸ç­‰ï¼‰</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">sameVnode</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">oldVnode</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">vnode</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// vnodeè¿›è¡Œå¯¹æ¯”</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#82AAFF;">patchVnode</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">oldVnode</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">vnode</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">insertedVnodeQueue</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// ä¸åŒçš„ vnode ï¼Œ ç›´æ¥åˆ æ‰é‡å»º</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">elm</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldVnode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">elm</span><span style="color:#89DDFF;">!;</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">parent</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">api</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">parentNode</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">elm</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">Node</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// é‡å»º</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#82AAFF;">createElm</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">vnode</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">insertedVnodeQueue</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">parent</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">api</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">insertBefore</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">parent</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">vnode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">elm</span><span style="color:#89DDFF;">!,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">api</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">nextSibling</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">elm</span><span style="color:#F07178;">))</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">removeVnodes</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">parent</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> [</span><span style="color:#A6ACCD;">oldVnode</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">i</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">i</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">insertedVnodeQueue</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">++</span><span style="color:#A6ACCD;">i</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">insertedVnodeQueue</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">i</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">data</span><span style="color:#89DDFF;">!.</span><span style="color:#A6ACCD;">hook</span><span style="color:#89DDFF;">!.</span><span style="color:#82AAFF;">insert</span><span style="color:#89DDFF;">!</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">insertedVnodeQueue</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">i</span><span style="color:#F07178;">])</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">i</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">i</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">cbs</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">post</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">++</span><span style="color:#A6ACCD;">i</span><span style="color:#F07178;">) </span><span style="color:#A6ACCD;">cbs</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">post</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">i</span><span style="color:#F07178;">]()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">vnode</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>é˜…è¯»ä»¥ä¸Šä»£ç æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œæˆ‘ä»¬åˆšå¼€å§‹åˆ›å»ºæ—¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸æ˜¯ <code>vnode</code> ï¼Œè€Œæ˜¯ä¸€ä¸ª <code>DOM</code> å…ƒç´ ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªç©ºçš„ <code>vnode</code> ï¼Œæ¥å…³è”åˆ°è¿™ä¸ª <code>DOM</code> å…ƒç´ ä¸Šã€‚</p><p>æœ‰äº†ç¬¬ä¸€ä¸ª <code>vnode</code> ä¹‹åï¼Œæˆ‘ä»¬åœ¨ç¬¬äºŒæ¬¡ <code>patch</code> æ—¶ï¼Œå°±å¯ä»¥å¯¹æ–°æ—§èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒã€‚è€Œæ–°æ—§èŠ‚ç‚¹çš„æ¯”è¾ƒæ˜¯å…ˆåˆ¤æ–­ <code>key</code> å’Œ <code>sel</code> æ˜¯å¦ç›¸åŒï¼Œå¦‚æœç›¸åŒï¼Œåˆ™ç”¨ <code>pathVNode</code> å‡½æ•°å¯¹æ–°æ—§èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœæ˜¯ä¸åŒçš„ <code>vnode</code> ï¼Œåˆ™ç›´æ¥åˆ æ‰é‡å»ºã€‚</p><h2 id="_3ã€patchvnode-å‡½æ•°" tabindex="-1">3ã€patchVnode å‡½æ•° <a class="header-anchor" href="#_3ã€patchvnode-å‡½æ•°" aria-label="Permalink to &quot;3ã€patchVnode å‡½æ•°&quot;">â€‹</a></h2><p>ä¸Šé¢æˆ‘ä»¬è¯´åˆ°äº† <code>patchVnode</code> å‡½æ•°è¿›è¡Œæ–°æ—§èŠ‚ç‚¹çš„æ¯”è¾ƒï¼Œä¸‹é¢æ¥å¯¹ <code>patchVnode</code> è¿›è¡Œè¯¦ç»†å‰–æã€‚åŒæ ·åœ¨ <code>src|init.ts</code> æ–‡ä»¶ä¸­ï¼Œ<strong>é™„ä¸Š patchVnode å‡½æ•°çš„ä»£ç ï¼š</strong></p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">patchVnode</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#A6ACCD;font-style:italic;">oldVnode</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">VNode</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#A6ACCD;font-style:italic;">vnode</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">VNode</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#A6ACCD;font-style:italic;">insertedVnodeQueue</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">VNodeQueue</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// æ‰§è¡Œprepatch hook</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">hook</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">vnode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">data</span><span style="color:#89DDFF;">?.</span><span style="color:#A6ACCD;">hook</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">hook</span><span style="color:#89DDFF;">?.</span><span style="color:#82AAFF;">prepatch</span><span style="color:#89DDFF;">?.</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">oldVnode</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">vnode</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// è®¾ç½®vnode.elem</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">elm</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">vnode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">elm</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldVnode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">elm</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">!;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// æ—§çš„ children</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldCh</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldVnode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">children</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">VNode</span><span style="color:#F07178;">[]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// æ–°çš„children</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ch</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">vnode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">children</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">VNode</span><span style="color:#F07178;">[]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// å½“æ–°æ—§èŠ‚ç‚¹ç›¸ç­‰æ—¶åˆ™è¿”å›</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">oldVnode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">vnode</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// hook ç›¸å…³</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">vnode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">data</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">undefined</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#F07178;"> (</span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">i</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">i</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">cbs</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">update</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">++</span><span style="color:#A6ACCD;">i</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">cbs</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">update</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">i</span><span style="color:#F07178;">](</span><span style="color:#A6ACCD;">oldVnode</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">vnode</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">vnode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">data</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">hook</span><span style="color:#89DDFF;">?.</span><span style="color:#82AAFF;">update</span><span style="color:#89DDFF;">?.</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">oldVnode</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">vnode</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// vnode.text === undefined (vnode.children ä¸€èˆ¬æœ‰å€¼ï¼›childrenå’Œtextåªèƒ½å­˜åœ¨ä¸€ä¸ªï¼Œä¸èƒ½å…±å­˜)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">isUndef</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">vnode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">text</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// æ–°æ—§vnodeéƒ½æœ‰children</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">isDef</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">oldCh</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">isDef</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">ch</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// updateChildren ä¸¤è€…éƒ½æœ‰childrenæ—¶è¦è¿›è¡Œå¯¹æ¯”</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">oldCh</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ch</span><span style="color:#F07178;">) </span><span style="color:#82AAFF;">updateChildren</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">elm</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldCh</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ch</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">insertedVnodeQueue</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// æ–°çš„vnodeæœ‰chindrenï¼Œæ—§çš„vnodeæ²¡æœ‰children ï¼ˆæ—§çš„vnodeæœ‰textï¼‰</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">isDef</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">ch</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// æ¸…ç©ºæ—§çš„vnodeçš„text</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">isDef</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">oldVnode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">text</span><span style="color:#F07178;">)) </span><span style="color:#A6ACCD;">api</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setTextContent</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">elm</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// æ·»åŠ children</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">addVnodes</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">elm</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ch</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ch</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">insertedVnodeQueue</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// æ—§çš„vnodeæœ‰childrenï¼Œæ–°çš„vnodeæ²¡æœ‰children</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">isDef</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">oldCh</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// ç§»é™¤æ—§vnodeçš„children</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">removeVnodes</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">elm</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldCh</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldCh</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// æ—§çš„vnodeæœ‰text</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">isDef</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">oldVnode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">text</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">api</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setTextContent</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">elm</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// else: vnode.text != undefined (è¯´æ˜ vnode.text æœ‰å€¼ï¼Œæ—§çš„vnode.children æ²¡æœ‰å€¼)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">oldVnode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">text</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">vnode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">text</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// ç§»é™¤æ—§vnodeçš„children</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">isDef</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">oldCh</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">removeVnodes</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">elm</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldCh</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldCh</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// è®¾ç½®æ–°çš„text</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">api</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setTextContent</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">elm</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">vnode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">text</span><span style="color:#89DDFF;">!</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">hook</span><span style="color:#89DDFF;">?.</span><span style="color:#82AAFF;">postpatch</span><span style="color:#89DDFF;">?.</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">oldVnode</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">vnode</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><p><strong>é˜…è¯»ä»¥ä¸Šæºç æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼š</strong></p><p><strong>ï¼ˆ1ï¼‰</strong> å½“æ—§çš„ <code>vnode</code> æœ‰ <code>text</code> æ—¶ï¼Œåˆ™è¯´æ˜æ—§çš„ <code>children</code> æ²¡æœ‰å€¼ï¼Œä¸”æ–°çš„ <code>vnode</code> çš„ <code>text</code> æœ‰å€¼ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±æŠŠæ—§çš„ <code>vnode</code> çš„ <code>children</code> è¿›è¡Œåˆ é™¤ï¼Œåˆ é™¤ç»“æŸç»™æ–°çš„ <code>vnode</code> è®¾ç½® <code>text</code> ï¼›</p><p><strong>ï¼ˆ2ï¼‰</strong> å½“æ–°æ—§èŠ‚ç‚¹éƒ½æœ‰ <code>children</code> æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å…¶è¿›è¡Œæ›´æ–°æ“ä½œï¼Œä¹Ÿå°±æ˜¯æ“ä½œ <code>updateChildren</code> å‡½æ•°ã€‚è¿™ä¸ªæˆ‘ä»¬å°†åœ¨ä¸‹é¢è¿›è¡Œè®²è§£ã€‚</p><p><strong>ï¼ˆ3ï¼‰</strong> å¦‚æœæ–°çš„ <code>vnode</code> æœ‰ <code>children</code> ï¼Œæ—§çš„ <code>vnode</code> æ²¡æœ‰ <code>children</code> ï¼Œåˆ™è¯´æ˜æ—§çš„ <code>vnode</code> æœ‰ <code>text</code> ï¼Œæ‰€ä»¥æ­¤æ—¶éœ€è¦æ¸…ç©ºæ—§çš„ <code>vnode</code> çš„ <code>text</code> ï¼Œå¹¶æ·»åŠ æ–°çš„ <code>children</code> ä¸Šå»ã€‚</p><p><strong>ï¼ˆ4ï¼‰</strong> å¦‚æœæ—§çš„ <code>vnode </code>æœ‰ <code>children</code> ï¼Œæ–°çš„ <code>vnode</code> æ²¡æœ‰ <code>children</code> ï¼Œåˆ™ç§»é™¤æ—§çš„ <code>vnode</code> çš„ <code>children</code> ã€‚</p><p><strong>ï¼ˆ5ï¼‰</strong> å¦‚æœæ–°æ—§èŠ‚ç‚¹éƒ½æœ‰ <code>text </code> ï¼Œåˆ™ç›´æ¥æŠŠæ–°çš„ <code>vnode</code> çš„ <code>text</code> å€¼èµ‹å€¼ç»™æ—§çš„ <code>vnode</code> çš„ <code>text</code> ã€‚</p><p><strong>æ¥çœ‹ä¸‹å›¾çš„å‘ˆç°ï¼š</strong></p><p><img src="https://mondaylab-1309616765.cos.ap-shanghai.myqcloud.com/images/202305270740437.png" alt=" æ–°æ—§èŠ‚ç‚¹çš„å¯¹æ¯”"></p><h2 id="_4ã€updatechildren-å‡½æ•°" tabindex="-1">4ã€updateChildren å‡½æ•° <a class="header-anchor" href="#_4ã€updatechildren-å‡½æ•°" aria-label="Permalink to &quot;4ã€updateChildren å‡½æ•°&quot;">â€‹</a></h2><p>ä¸Šé¢åˆ†æ <code>pathVnode</code> æ—¶æˆ‘ä»¬è®²åˆ°äº†ç”¨ <code>updateChildren</code> å‡½æ•°æ¥æ›´æ–°æ–°æ—§èŠ‚ç‚¹çš„ <code>children</code> ã€‚<strong>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸ªå‡½æ•°ï¼š</strong></p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">updateChildren</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#A6ACCD;font-style:italic;">parentElm</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Node</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#A6ACCD;font-style:italic;">oldCh</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">VNode</span><span style="color:#A6ACCD;">[]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#A6ACCD;font-style:italic;">newCh</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">VNode</span><span style="color:#A6ACCD;">[]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#A6ACCD;font-style:italic;">insertedVnodeQueue</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">VNodeQueue</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldStartIdx</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newStartIdx</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldEndIdx</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldCh</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldStartVnode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldCh</span><span style="color:#F07178;">[</span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldEndVnode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldCh</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">oldEndIdx</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newEndIdx</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newCh</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newStartVnode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newCh</span><span style="color:#F07178;">[</span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newEndVnode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newCh</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">newEndIdx</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldKeyToIdx</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">KeyToIndexMap</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">|</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">undefined</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">idxInOld</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">number</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">elmToMove</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">VNode</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">before</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">oldStartIdx</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldEndIdx</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newStartIdx</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newEndIdx</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">oldStartVnode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">oldStartVnode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldCh</span><span style="color:#F07178;">[</span><span style="color:#89DDFF;">++</span><span style="color:#A6ACCD;">oldStartIdx</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// Vnode might have been moved left</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">oldEndVnode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">oldEndVnode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldCh</span><span style="color:#F07178;">[</span><span style="color:#89DDFF;">--</span><span style="color:#A6ACCD;">oldEndIdx</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">newStartVnode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">newStartVnode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newCh</span><span style="color:#F07178;">[</span><span style="color:#89DDFF;">++</span><span style="color:#A6ACCD;">newStartIdx</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">newEndVnode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">newEndVnode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newCh</span><span style="color:#F07178;">[</span><span style="color:#89DDFF;">--</span><span style="color:#A6ACCD;">newEndIdx</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// å¼€å§‹å’Œå¼€å§‹è¿›è¡Œå¯¹æ¯”</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">sameVnode</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">oldStartVnode</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newStartVnode</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">patchVnode</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">oldStartVnode</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newStartVnode</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">insertedVnodeQueue</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">oldStartVnode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldCh</span><span style="color:#F07178;">[</span><span style="color:#89DDFF;">++</span><span style="color:#A6ACCD;">oldStartIdx</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">newStartVnode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newCh</span><span style="color:#F07178;">[</span><span style="color:#89DDFF;">++</span><span style="color:#A6ACCD;">newStartIdx</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// ç»“æŸå’Œç»“æŸè¿›è¡Œå¯¹æ¯”</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">sameVnode</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">oldEndVnode</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newEndVnode</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">patchVnode</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">oldEndVnode</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newEndVnode</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">insertedVnodeQueue</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">oldEndVnode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldCh</span><span style="color:#F07178;">[</span><span style="color:#89DDFF;">--</span><span style="color:#A6ACCD;">oldEndIdx</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">newEndVnode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newCh</span><span style="color:#F07178;">[</span><span style="color:#89DDFF;">--</span><span style="color:#A6ACCD;">newEndIdx</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// å¼€å§‹å’Œç»“æŸåšå¯¹æ¯”</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">sameVnode</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">oldStartVnode</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newEndVnode</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// Vnode moved right</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">patchVnode</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">oldStartVnode</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newEndVnode</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">insertedVnodeQueue</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">api</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">insertBefore</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#A6ACCD;">parentElm</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#A6ACCD;">oldStartVnode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">elm</span><span style="color:#89DDFF;">!,</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#A6ACCD;">api</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">nextSibling</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">oldEndVnode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">elm</span><span style="color:#89DDFF;">!</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">        )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">oldStartVnode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldCh</span><span style="color:#F07178;">[</span><span style="color:#89DDFF;">++</span><span style="color:#A6ACCD;">oldStartIdx</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">newEndVnode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newCh</span><span style="color:#F07178;">[</span><span style="color:#89DDFF;">--</span><span style="color:#A6ACCD;">newEndIdx</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// ç»“æŸå’Œå¼€å§‹åšå¯¹æ¯”</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">sameVnode</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">oldEndVnode</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newStartVnode</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// Vnode moved left</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">patchVnode</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">oldEndVnode</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newStartVnode</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">insertedVnodeQueue</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">api</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">insertBefore</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">parentElm</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldEndVnode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">elm</span><span style="color:#89DDFF;">!,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldStartVnode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">elm</span><span style="color:#89DDFF;">!</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">oldEndVnode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldCh</span><span style="color:#F07178;">[</span><span style="color:#89DDFF;">--</span><span style="color:#A6ACCD;">oldEndIdx</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">newStartVnode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newCh</span><span style="color:#F07178;">[</span><span style="color:#89DDFF;">++</span><span style="color:#A6ACCD;">newStartIdx</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// ä»¥ä¸Šå››ä¸ªéƒ½æœªå‘½ä¸­</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">oldKeyToIdx</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">undefined</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#A6ACCD;">oldKeyToIdx</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">createKeyToOldIdx</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">oldCh</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldStartIdx</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldEndIdx</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// æ‹¿æ–°èŠ‚ç‚¹çš„keyï¼Œèƒ½å¦å¯¹åº”ä¸ŠoldChä¸­çš„æŸä¸ªèŠ‚ç‚¹çš„key</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">idxInOld</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldKeyToIdx</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">newStartVnode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">key</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">string</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// æ²¡æœ‰å¯¹åº”ä¸Š</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">isUndef</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">idxInOld</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;">// New element</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#A6ACCD;">api</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">insertBefore</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#A6ACCD;">parentElm</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#82AAFF;">createElm</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">newStartVnode</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">insertedVnodeQueue</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#A6ACCD;">oldStartVnode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">elm</span><span style="color:#89DDFF;">!</span></span>
<span class="line"><span style="color:#F07178;">          )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;">// å¯¹åº”ä¸Šäº†</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;">// å¯¹åº”ä¸Škeyçš„èŠ‚ç‚¹</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#A6ACCD;">elmToMove</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldCh</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">idxInOld</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;">// selæ˜¯å¦ç›¸ç­‰ï¼ˆsameVnodeçš„æ¡ä»¶ï¼‰</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">elmToMove</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">sel</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newStartVnode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">sel</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;font-style:italic;">// selä¸ç›¸ç­‰ï¼Œå¯èƒ½åªæ˜¯keyç›¸ç­‰ï¼›é‚£ä¹Ÿæ²¡æœ‰ç”¨ï¼Œåªèƒ½é‡å»º New Element</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#A6ACCD;">api</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">insertBefore</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">              </span><span style="color:#A6ACCD;">parentElm</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">              </span><span style="color:#82AAFF;">createElm</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">newStartVnode</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">insertedVnodeQueue</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">              </span><span style="color:#A6ACCD;">oldStartVnode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">elm</span><span style="color:#89DDFF;">!</span></span>
<span class="line"><span style="color:#F07178;">            )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;font-style:italic;">// sel ç›¸ç­‰ï¼Œkey ç›¸ç­‰ï¼›æ‰§è¡ŒpatchVnodeå‡½æ•°</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#82AAFF;">patchVnode</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">elmToMove</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newStartVnode</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">insertedVnodeQueue</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#A6ACCD;">oldCh</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">idxInOld</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">undefined</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#A6ACCD;">api</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">insertBefore</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">parentElm</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">elmToMove</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">elm</span><span style="color:#89DDFF;">!,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldStartVnode</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">elm</span><span style="color:#89DDFF;">!</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">newStartVnode</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newCh</span><span style="color:#F07178;">[</span><span style="color:#89DDFF;">++</span><span style="color:#A6ACCD;">newStartIdx</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">oldStartIdx</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldEndIdx</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newStartIdx</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newEndIdx</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">oldStartIdx</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldEndIdx</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#A6ACCD;">before</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newCh</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">newEndIdx</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newCh</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">newEndIdx</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">elm</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">addVnodes</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#A6ACCD;">parentElm</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#A6ACCD;">before</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#A6ACCD;">newCh</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#A6ACCD;">newStartIdx</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#A6ACCD;">newEndIdx</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">          </span><span style="color:#A6ACCD;">insertedVnodeQueue</span></span>
<span class="line"><span style="color:#F07178;">        )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">removeVnodes</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">parentElm</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldCh</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldStartIdx</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldEndIdx</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br></div></div><p><strong>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸¤å¼ å›¾ï¼š</strong></p><p><img src="https://mondaylab-1309616765.cos.ap-shanghai.myqcloud.com/images/202305270740121.png" alt="updateChildrenå›¾ç¤º1"></p><p><img src="https://mondaylab-1309616765.cos.ap-shanghai.myqcloud.com/images/202305270741837.png" alt="updateChildrenå›¾ç¤º2"></p><p>å¤§å®¶å…ˆçœ‹å›¾ 1ï¼Œ <code>updateChildren</code> è¦åšå¾—äº‹æƒ…å°±æ˜¯ï¼Œå°†æ–°æ—§èŠ‚ç‚¹è¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœç›¸åŒåˆ™ä¸è¿›è¡Œæ›´æ–°ï¼Œå¦‚æœä¸åŒåˆ™å¯¹å…¶è¿›è¡Œæ›´æ–°æ“ä½œã€‚</p><p>å†çœ‹å›¾ 2ï¼Œè€Œæ›´æ–°çš„æ–¹å¼å°±æ˜¯ï¼Œé€šè¿‡å¯¹<strong>oldStartIdx</strong>ï¼Œ<strong>newStartIdx</strong>ï¼Œ<strong>oldEndIdx</strong>å’Œ<strong>newEndIdx</strong>è¿™å››ä¸ªå€¼è¿›è¡Œæ¯”è¾ƒï¼Œæ¥å¾—å‡ºæ˜¯å¦éœ€è¦æ›´æ–°æ“ä½œã€‚</p><p>é‚£è¿™å››ä¸ªå€¼å¦‚ä½•è¿›è¡Œæ¯”è¾ƒå‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­çœ‹ã€‚</p><p>é˜…è¯»æºç æˆ‘ä»¬å¯ä»¥åˆ†æå‡ºï¼Œé€šè¿‡å¯¹<strong>4 ç§ç±»å‹</strong>çš„èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒï¼Œæ¥<strong>åˆ¤æ–­å¦‚ä½•æ›´æ–°èŠ‚ç‚¹</strong>ã€‚</p><p><strong>ç¬¬ä¸€ç§</strong>ï¼Œæ—§çš„å¼€å§‹èŠ‚ç‚¹ <code>oldStartIdx</code> å’Œæ–°çš„å¼€å§‹èŠ‚ç‚¹ <code>newStartIdx</code> æ¯”è¾ƒã€‚<strong>ç¬¬äºŒç§</strong>ï¼Œæ—§çš„å¼€å§‹èŠ‚ç‚¹ <code>oldStartIdx</code> å’Œæ–°çš„ç»“æŸèŠ‚ç‚¹ <code>newEndIdx</code> æ¯”è¾ƒã€‚<strong>ç¬¬ä¸‰ç§</strong>ï¼Œæ—§çš„ç»“æŸèŠ‚ç‚¹ <code>oldEndIdx</code> å’Œæ–°çš„å¼€å§‹èŠ‚ç‚¹ <code>newStartIdx</code> æ¯”è¾ƒã€‚<strong>ç¬¬å››ç§</strong>ï¼Œæ—§çš„ç»“æŸèŠ‚ç‚¹ <code>oldEndIdx</code> å’Œæ–°çš„ç»“æŸèŠ‚ç‚¹ <code>newEndIdx</code> æ¯”è¾ƒã€‚</p><p>å¦‚æœä»¥ä¸Šè¿™å››ç§æ¯”è¾ƒéƒ½æ²¡æœ‰å‘½ä¸­ï¼Œåˆ™æ‹¿å–æ–°èŠ‚ç‚¹çš„<code>key</code> ï¼Œä¹‹åå°†è¿™ä¸ª <code>key</code> æŸ¥çœ‹æ˜¯å¦å¯¹åº”ä¸Š <code>oldCh</code> ä¸­æŸä¸ªèŠ‚ç‚¹çš„ <code>key</code> ã€‚<strong>å¦‚æœæ²¡æœ‰å¯¹åº”ä¸Š</strong>ï¼Œåˆ™ç›´æ¥<strong>é‡å»ºå…ƒç´ </strong>ã€‚<strong>å¦‚æœå¯¹åº”ä¸Šäº†</strong>ï¼Œè¿˜è¦å†åˆ¤æ–­ <code>sel</code> å’Œ <code>key</code> æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰ï¼Œåˆ™<strong>æ‰§è¡Œ patchVnode å‡½æ•°</strong>ï¼Œå¦‚æœä¸ç›¸ç­‰ï¼Œé‚£è·Ÿå‰é¢ä¸€æ ·ï¼Œä¹Ÿåªèƒ½<strong>é‡å»ºå…ƒç´ </strong>ã€‚</p><h1 id="å››ã€ç»“æŸè¯­" tabindex="-1">å››ã€ç»“æŸè¯­ <a class="header-anchor" href="#å››ã€ç»“æŸè¯­" aria-label="Permalink to &quot;å››ã€ç»“æŸè¯­&quot;">â€‹</a></h1><p>vdom çš„æ ¸å¿ƒæ¦‚å¿µä¸»è¦åœ¨ <code>h</code> ã€ <code>vnode</code> ã€ <code>patch</code> ã€ <code>diff</code> ã€ <code>key</code> è¿™å‡ ä¸ªå†…å®¹ï¼Œä¸ªäººè§‰å¾—ï¼Œæ•´ä¸ª <code>diff</code> çš„æ¯”è¾ƒéƒ½åœ¨å›´ç»•ç€è¿™å‡ ä¸ªå‡½æ•°è¿›è¡Œï¼Œæ‰€ä»¥äº†è§£è¿™å‡ ä¸ªæ ¸å¿ƒæ¦‚å¿µå¾ˆé‡è¦ã€‚åŒæ—¶ï¼Œvdom å­˜åœ¨çš„å¦ä¸€ä¸ªæ›´é‡è¦çš„ä»·å€¼è«è¿‡äºæ•°æ®é©±åŠ¨è§†å›¾äº†ï¼Œ <code>vdom</code> é€šè¿‡æ§åˆ¶ <code>DOM</code> çš„æ“ä½œæ¥<strong>ä½¿å¾—æ•°æ®å¯ä»¥å»é©±åŠ¨è§†å›¾</strong>ã€‚</p><p>å…³äºè™šæ‹Ÿ DOM å’Œ diff çš„è®²è§£åˆ°æ­¤å°±ç»“æŸå•¦ï¼å¸Œæœ›å¯¹å¤§å®¶æœ‰å¸®åŠ©~</p>`,122),e=[o];function c(t,r,F,y,D,i){return a(),n("div",null,e)}const A=s(p,[["render",c]]);export{d as __pageData,A as default};
