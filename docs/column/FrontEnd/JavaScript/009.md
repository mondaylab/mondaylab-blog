---
title: è¶…ä¿å§†çº§æ•™ç¨‹å¸¦ä½ å®ç°Promiseçš„æ ¸å¿ƒåŠŸèƒ½
author: å‘¨ä¸€
date: '2021-08-17'
categories:
  - å‰ç«¯å¼€å‘
tags:
  - JavaScript
sidebar: 'auto'
---

# ğŸ“š åºè¨€

ä¼—æ‰€å‘¨çŸ¥ï¼Œ `promise` æ˜¯å‰ç«¯é¢è¯•ä¸­é›·æ‰“ä¸åŠ¨çš„é¢è¯•é¢˜äº†ï¼Œé¢è¯•å®˜éƒ½å¾ˆçˆ±è€ƒã€‚å‘¨ä¸€ä¹‹å‰ä¹Ÿæ˜¯çŸ¥è¯†æ¯”è¾ƒæµ®äºè¡¨é¢ï¼Œåœ¨ä¸€äº›é¢ç»ä¸Šçœ‹åˆ°äº† `promise` çš„å®ç°æ–¹å¼ï¼Œå°±åªåœç•™åœ¨é‚£ä¸ªå±‚é¢ä¸Šã€‚ä½†å®é™…ä¸Šæˆ‘å‘ç°ï¼Œå¦‚æœæ²¡æœ‰æ·±å…¥å…¶åŸç†å»ç†è§£ï¼Œé¢è¯•å®˜ç¨å¾®å˜ä¸ªæ³•å­æ¥è€ƒï¼Œè¿™é“é¢˜å¾ˆå®¹æ˜“å°±æŠŠæˆ‘ç»™é—®å€’äº†ã€‚æ‰€ä»¥å‘€ï¼Œè¿˜æ˜¯è€è€å®å®ä»å¤´åˆ°å°¾ç ”ç©¶ä¸€éï¼Œè¿™æ ·ç­‰é‡åˆ°äº†ï¼Œä¸ç®¡æ€ä¹ˆè€ƒï¼Œä¸‡å®—ä¸å˜å…¶ä¸€ï¼ŒæŠŠåŸç†ç†è§£äº†ï¼Œå°±æ²¡æœ‰é‚£ä¹ˆå®¹æ˜“è¢«é—®å€’äº†ã€‚

ä¸‹é¢å¼€å§‹è¿›å…¥æœ¬æ–‡çš„è®²è§£~ğŸ·ï¸

# ğŸ“‹ æ–‡ç« å†…å®¹æŠ¢å…ˆçœ‹

![promiseå®ç°æ€ç»´å¯¼å›¾](https://mondaylab-1309616765.cos.ap-shanghai.myqcloud.com/images/202305270700013.png)

# ğŸ“° ä¸€ã€js çš„åŒæ­¥æ¨¡å¼å’Œå¼‚æ­¥æ¨¡å¼

## 1. å•çº¿ç¨‹ ğŸ’¡

å¤§å®¶éƒ½çŸ¥é“ï¼Œ `js` çš„è®¾è®¡æ˜¯åŸºäº**å•çº¿ç¨‹**è¿›è¡Œå¼€å‘çš„ï¼Œå®ƒåŸå…ˆçš„ç›®çš„åœ¨äºåªå‚ä¸æµè§ˆå™¨ä¸­**DOM èŠ‚ç‚¹**çš„æ“ä½œã€‚

è€Œå¯¹äºå•çº¿ç¨‹æ¥è¯´ï¼Œå…¶æ„å‘³ç€**åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡**ï¼Œä¸”æ‰€æœ‰çš„ä»»åŠ¡éƒ½ä¼š**æŒ‰ç…§é˜Ÿåˆ—çš„æ¨¡å¼**è¿›è¡Œæ’é˜Ÿã€‚

æ‰€ä»¥ï¼Œå•çº¿ç¨‹çš„ç¼ºç‚¹å°±åœ¨äºï¼Œå½“ `js` è¿è¡Œçš„æ—¶å€™ï¼Œ `html` æ˜¯ä¸ä¼šè¿›è¡Œæ¸²æŸ“çš„ã€‚å› æ­¤ï¼Œå¦‚æœä¸€ä¸ªä»»åŠ¡ç‰¹åˆ«è€—æ—¶ï¼Œé‚£ä¹ˆå°†ä¼šå¾ˆå®¹æ˜“é€ æˆ**é¡µé¢é˜»å¡**çš„å±€é¢ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ `js` æå‡ºäº†**åŒæ­¥æ¨¡å¼**å’Œ**å¼‚æ­¥æ¨¡å¼**çš„è§£å†³æ–¹æ¡ˆã€‚

## 2. åŒæ­¥æ¨¡å¼ ğŸ’¡

### ï¼ˆ1ï¼‰å®šä¹‰

æ‰€è°“åŒæ­¥æ¨¡å¼ï¼ŒæŒ‡çš„å°±æ˜¯å‡½æ•°ä¸­çš„è°ƒç”¨å †æ ˆï¼ŒæŒ‰ç…§ä»£ç å®ç°çš„é¡ºåºï¼Œä¸€æ­¥æ­¥è¿›è¡Œã€‚

### ï¼ˆ2ï¼‰å›¾ä¾‹

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ç”¨ä¸€æ®µä»£ç ï¼Œæ¼”ç¤º `js` ä¸­**å‡½æ•°è°ƒç”¨å †æ ˆ**çš„æ‰§è¡Œæƒ…å†µã€‚**å…·ä½“ä»£ç å¦‚ä¸‹ï¼š**

```js
const func1 = () => {
  func2();
  console.log(3);
};

const func2 = () => {
  func3();
  console.log(4);
};

const func3 = () => {
  console.log(5);
};

func1(); //5 4 3
```

çœ‹åˆ°è¿™é‡Œï¼Œç›¸ä¿¡å¾ˆå¤šå°ä¼™ä¼´å·²ç»åœ¨æ„æ€å…¶å…·ä½“çš„æ‰§è¡Œé¡ºåºã€‚ä¸‹é¢ç”¨ä¸€å¼ å›¾æ¥**å±•ç¤ºæ‰§è¡Œæ•ˆæœï¼š**

![è°ƒç”¨å †æ ˆ](https://mondaylab-1309616765.cos.ap-shanghai.myqcloud.com/images/202305270700097.png)

å¯¹äº**æ ˆ**è¿™ä¸ªæ•°æ®ç»“æ„æ¥è¯´ï¼Œå®ƒéµå¾ª**åè¿›å…ˆå‡º**çš„åŸåˆ™ã€‚å› æ­¤ï¼Œå½“ `func1` ï¼Œ `func2` ï¼Œ `func3` ä¾æ¬¡æ”¾è¿›è°ƒç”¨æ ˆåï¼Œ **éµå¾ªåè¿›å…ˆå‡ºåŸåˆ™** ï¼Œé‚£ä¹ˆ `func3` å‡½æ•°çš„å†…å®¹ä¼šå…ˆè¢«æ‰§è¡Œï¼Œä¹‹åæ˜¯ `func2` ï¼Œæœ€åæ˜¯ `func1` ã€‚

å› æ­¤ï¼Œå¯¹äº `js` çš„**åŒæ­¥æ¨¡å¼**æ¥è¯´ï¼Œå°±æ˜¯ç±»ä¼¼äºä¸Šè¿°çš„å‡½æ•°è°ƒç”¨å †æ ˆã€‚

## 3. å¼‚æ­¥æ¨¡å¼ ğŸ’¡

### ï¼ˆ1ï¼‰ä¸¾ä¾‹

å½“ç¨‹åºé‡åˆ°ç½‘ç»œè¯·æ±‚æˆ–å®šæ—¶ä»»åŠ¡ç­‰é—®é¢˜æ—¶ï¼Œè¿™ä¸ªæ—¶å€™ä¼šæœ‰ä¸€ä¸ªç­‰å¾…æ—¶é—´ã€‚

å‡è®¾ä¸€ä¸ªå®šæ—¶å™¨è®¾ç½® `10s` ï¼Œå¦‚æœæ”¾åœ¨åŒæ­¥ä»»åŠ¡é‡Œï¼ŒåŒæ­¥ä»»åŠ¡ä¼šé˜»å¡ä»£ç æ‰§è¡Œï¼Œæˆ‘ä»¬ä¼šç­‰å¾… `10s` åæ‰èƒ½çœ‹åˆ°æˆ‘ä»¬æƒ³è¦çš„ç»“æœã€‚**1 ä¸ª**å®šæ—¶å™¨çš„ç­‰å¾…æ—¶é—´å¯èƒ½è¿˜å¥½ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™æ˜¯**100 ä¸ª**å®šæ—¶å™¨å‘¢ï¼Ÿæˆ‘ä»¬æ€»ä¸èƒ½ç­‰å¾…ç€ `1000s` çš„æ—¶é—´å°±ä¸ºäº†çœ‹åˆ°æˆ‘ä»¬æƒ³è¦çš„ç»“æœå§ï¼Œè¿™å‡ ä¹ä¸å¤ªç°å®ã€‚

é‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±éœ€è¦å¼‚æ­¥ï¼Œé€šè¿‡å¼‚æ­¥æ¥**è®©ç¨‹åºä¸é˜»å¡ä»£ç æ‰§è¡Œ**ï¼Œ**çµæ´»æ‰§è¡Œç¨‹åº**ã€‚

### ï¼ˆ2ï¼‰å®šä¹‰

å¯¹äºåŒæ­¥æ¨¡å¼æ¥è¯´ï¼Œå®ƒåªèƒ½è‡ªä¸Šè€Œä¸‹åœ°ä¸€è¡Œä¸€è¡Œæ‰§è¡Œï¼Œä¸€è¡Œä¸€è¡Œè¿›è¡Œè§£æã€‚é‚£ä¸åŒæ­¥æ¨¡å¼ä¸åŒçš„æ˜¯ï¼Œå¼‚æ­¥æ¨¡å¼æ˜¯**æŒ‰ç…§æˆ‘ä»¬æƒ³è¦çš„ç»“æœ**è¿›è¡Œè¾“å‡ºï¼Œä¸ä¼šåƒåŒæ­¥æ¨¡å¼ä¸€æ ·äº§ç”Ÿé˜»å¡ï¼Œä»¥è¾¾åˆ°è®©ç¨‹åºå¯æ§çš„æ•ˆæœã€‚

### ï¼ˆ3ï¼‰js å¦‚ä½•å®ç°å¼‚æ­¥

ç›¸å¯¹äºåŒæ­¥æ¨¡å¼æ¥è¯´ï¼Œå¼‚æ­¥æ¨¡å¼çš„ç»“æ„æ›´ä¸ºå¤æ‚ã€‚é™¤äº†**è°ƒç”¨æ ˆ**ä¹‹å¤–ï¼Œ å®ƒè¿˜æœ‰**æ¶ˆæ¯é˜Ÿåˆ—**å’Œ**äº‹ä»¶å¾ªç¯**è¿™ä¸¤ä¸ªé¢å¤–çš„æœºåˆ¶ã€‚æ‰€è°“**äº‹ä»¶å¾ªç¯**ï¼Œä¹Ÿç§°ä¸º `event loop` æˆ–**äº‹ä»¶è½®è¯¢**ã€‚å› ä¸º `js` æ˜¯å•çº¿ç¨‹çš„ï¼Œä¸”å¼‚æ­¥éœ€è¦**åŸºäºå›è°ƒ**æ¥å®ç°ï¼Œæ‰€ä»¥ï¼Œ `event loop` å°±æ˜¯**å¼‚æ­¥å›è°ƒ**çš„å®ç°åŸç†ã€‚

**JS åœ¨ç¨‹åºä¸­çš„æ‰§è¡Œéµå¾ªä»¥ä¸‹è§„åˆ™ï¼š**

- ä»å‰åˆ°åï¼Œä¸€è¡Œä¸€è¡Œæ‰§è¡Œï¼›
- å¦‚æœæŸä¸€è¡Œæ‰§è¡ŒæŠ¥é”™ï¼Œåˆ™åœæ­¢ä¸‹é¢ä»£ç çš„æ‰§è¡Œï¼›
- å…ˆæŠŠåŒæ­¥ä»£ç æ‰§è¡Œå®Œï¼Œå†æ‰§è¡Œå¼‚æ­¥ã€‚

**ä¸€èµ·æ¥çœ‹ä¸€ä¸ªå®ä¾‹ï¼š**

```js
console.log('Hi');

setTimeout(function cb1() {
  console.log('cb1'); //cb1 å³callbackå›è°ƒå‡½æ•°
}, 5000);

console.log('Bye');

//æ‰“å°é¡ºåºï¼š
//Hi
//Bye
//cb1
```

ä»ä¸Šä¾‹ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ `JS` æ˜¯å…ˆæ‰§è¡ŒåŒæ­¥ä»£ç ï¼Œæ‰€ä»¥å…ˆæ‰“å° `Hi` å’Œ `Bye` ï¼Œä¹‹åæ‰§è¡Œå¼‚æ­¥ä»£ç ï¼Œæ‰“å°å‡º `cb1` ã€‚

ä»¥æ­¤ä»£ç ä¸ºä¾‹ï¼Œä¸‹é¢å¼€å§‹è®²è§£ `event loop` çš„è¿‡ç¨‹ã€‚

### ï¼ˆ4ï¼‰event loop è¿‡ç¨‹

å¯¹äºä¸Šé¢è¿™æ®µä»£ç ï¼Œæ‰§è¡Œè¿‡ç¨‹**å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š**

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://mondaylab-1309616765.cos.ap-shanghai.myqcloud.com/images/202305270701948.gif)

ä»ä¸Šå›¾ä¸­å¯ä»¥åˆ†æå‡ºè¿™æ®µä»£ç çš„è¿è¡Œè½¨è¿¹ã€‚é¦–å…ˆ `console.log('Hi')` æ˜¯åŒæ­¥ä»£ç ï¼Œç›´æ¥æ‰§è¡Œå¹¶æ‰“å°å‡º `Hi` ã€‚æ¥ä¸‹æ¥ç»§ç»­æ‰§è¡Œå®šæ—¶å™¨ `setTimeout` ï¼Œ**å®šæ—¶å™¨æ˜¯å¼‚æ­¥ä»£ç **ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™æµè§ˆå™¨ä¼šå°†å®ƒäº¤ç»™ `Web APIs` æ¥å¤„ç†è¿™ä»¶äº‹æƒ…ï¼Œå› æ­¤å…ˆæŠŠå®ƒæ”¾åˆ° `Web APIs` ä¸­ï¼Œä¹‹åç»§ç»­æ‰§è¡Œ `console.log('Bye')` ï¼Œ `console.log('Bye')` æ˜¯åŒæ­¥ä»£ç ï¼Œåœ¨è°ƒç”¨å †æ ˆ `Call Stack` ä¸­æ‰§è¡Œï¼Œæ‰“å°å‡º `Bye` ã€‚

åˆ°è¿™é‡Œï¼Œè°ƒç”¨å †æ ˆ `Call Stack` é‡Œé¢çš„å†…å®¹å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ï¼Œå½“è°ƒç”¨å †æ ˆçš„å†…å®¹ä¸ºç©ºæ—¶ï¼Œæµè§ˆå™¨å°±ä¼šå¼€å§‹å» **æ¶ˆæ¯é˜Ÿåˆ— Callback Queue** å¯»æ‰¾ä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Œæ­¤æ—¶æ¶ˆæ¯é˜Ÿåˆ—å°±ä¼šå» `Web API` é‡Œé¢å¯»æ‰¾ä»»åŠ¡ï¼Œéµå¾ª**å…ˆè¿›å…ˆå‡º**åŸåˆ™ï¼Œæ‰¾åˆ°äº†å®šæ—¶å™¨ï¼Œä¸”å®šæ—¶å™¨é‡Œé¢æ˜¯å›è°ƒå‡½æ•° `cb1` ï¼Œäºæ˜¯æŠŠå›è°ƒå‡½æ•° `cb1` ä¼ å…¥ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œæ­¤æ—¶ `Web API` ä¹Ÿç©ºäº†ï¼Œä»»åŠ¡é˜Ÿåˆ—é‡Œé¢çš„ä»»åŠ¡å°±ä¼šä¼ å…¥åˆ°è°ƒç”¨å †æ ˆé‡Œ`Call Stack` é‡Œæ‰§è¡Œï¼Œæœ€ç»ˆæ‰“å°å‡º `cb1` ã€‚

## 4. å›è°ƒå‡½æ•° ğŸ’¡

æ—©æœŸæˆ‘ä»¬åœ¨è§£å†³å¼‚æ­¥é—®é¢˜çš„æ—¶å€™ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯ä½¿ç”¨**callback å›è°ƒå‡½æ•°çš„å½¢å¼** æ¥è°ƒç”¨çš„ã€‚**å½¢å¼å¦‚ä¸‹ï¼š**

```js
//è·å–ç¬¬ä¸€ä»½æ•°æ®
$.get(url1, (data1) => {
  console.log(data1);

  //è·å–ç¬¬äºŒä»½æ•°æ®
  $.get(url2, (data2) => {
    console.log(data2);

    //è·å–ç¬¬ä¸‰ä»½æ•°æ®
    $.get(url3, (data3) => {
      console.log(data3);

      //è¿˜å¯ä»¥è·å–æ›´å¤šæ•°æ®
    });
  });
});
```

ä»ä¸Šè¿°ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ—©æœŸåœ¨è°ƒç”¨æ•°æ®çš„æ—¶å€™ï¼Œéƒ½æ˜¯ä¸€å±‚å¥—ä¸€å±‚ï¼Œ `callback` è°ƒç”¨ `callback` ï¼Œä»¿ä½›æ·±é™·è°ƒç”¨åœ°ç‹±ä¸€æ ·ï¼Œæ•°æ®ä¹Ÿè¢«è°ƒç”¨çš„éå¸¸ä¹±ä¸ƒå…«ç³Ÿçš„ã€‚æ‰€ä»¥ï¼Œå› ä¸º `callback` å¯¹å¼€å‘å¦‚æ­¤ä¸å‹å¥½ï¼Œä¹Ÿå°±æœ‰äº†åæ¥çš„ `promise` äº§ç”Ÿã€‚

`promise` ç”± `CommonJS` ç¤¾åŒºæœ€æ—©æå‡ºï¼Œä¹‹ååœ¨**2015 å¹´**çš„æ—¶å€™ï¼Œ `ES6` å°†å…¶å†™è¿›**è¯­è¨€æ ‡å‡†**ä¸­ï¼Œç»Ÿä¸€äº†å®ƒçš„ç”¨æ³•ï¼ŒåŸç”Ÿæä¾›äº† `Promise` å¯¹è±¡ã€‚ `promise` çš„å‡ºç°ï¼Œå‘Šåˆ«äº†å›è°ƒåœ°ç‹±æ—¶ä»£ï¼Œè§£å†³äº†**å›è°ƒåœ°ç‹±** `callback hell` çš„é—®é¢˜ã€‚

é‚£ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹ `Promise` çš„å„ç§ç¥å¥‡ç”¨æ³•~

# ğŸ“ƒ äºŒã€Promise å¼‚æ­¥æ–¹æ¡ˆ

## 1. Promise çš„ä¸‰ç§çŠ¶æ€ ğŸ“‚

### ï¼ˆ1ï¼‰Promise çš„ä¸‰ç§çŠ¶æ€

|     çŠ¶æ€      |                                                         å«ä¹‰                                                          |
| :-----------: | :-------------------------------------------------------------------------------------------------------------------: |
|  **pending**  |                       ç­‰å¾…çŠ¶æ€ï¼Œå³åœ¨è¿‡ç¨‹ä¸­ï¼Œè¿˜æ²¡æœ‰ç»“æœã€‚æ¯”å¦‚æ­£åœ¨ç½‘ç»œè¯·æ±‚ï¼Œæˆ–å®šæ—¶å™¨æ²¡æœ‰åˆ°æ—¶é—´ã€‚                        |
| **fulfilled** |  æ»¡è¶³çŠ¶æ€ï¼Œå³äº‹ä»¶å·²ç»è§£å†³äº†ï¼Œå¹¶ä¸”æˆåŠŸäº†ï¼›å½“æˆ‘ä»¬ä¸»åŠ¨å›è°ƒäº† **fulfilled** æ—¶ï¼Œå°±å¤„äºè¯¥çŠ¶æ€ï¼Œå¹¶ä¸”ä¼šå›è°ƒ **then** å‡½æ•°ã€‚  |
| **rejected**  | æ‹’ç»çŠ¶æ€ï¼Œå³äº‹ä»¶å·²ç»è¢«æ‹’ç»äº†ï¼Œä¹Ÿå°±æ˜¯å¤±è´¥äº†ï¼›å½“æˆ‘ä»¬ä¸»åŠ¨å›è°ƒäº† **reject** æ—¶ï¼Œå°±å¤„äºè¯¥çŠ¶æ€ï¼Œå¹¶ä¸”ä¼šå›è°ƒ **catch** å‡½æ•°ã€‚ |

### ï¼ˆ2ï¼‰çŠ¶æ€è§£é‡Š

å¯¹äº `Promise` æ¥è¯´ï¼Œå®ƒæ˜¯ä¸€ä¸ª**å¯¹è±¡**ï¼Œç”¨æ¥è¡¨ç¤ºä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡**åœ¨æ‰§è¡Œç»“æŸä¹‹å**è¿”å›çš„ç»“æœï¼Œå®ƒæœ‰ **3 ç§çŠ¶æ€**ï¼š `pending` ï¼Œ `fulfilled` ï¼Œ `rejected` ã€‚**å…¶æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š**

![Promiseçš„æ‰§è¡Œæµç¨‹](https://mondaylab-1309616765.cos.ap-shanghai.myqcloud.com/images/202305270701759.png)

å¦‚æœä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡å¤„äº `pending` çŠ¶æ€æ—¶ï¼Œé‚£ä¹ˆè¡¨ç¤ºè¿™ä¸ª `promise` ä¸­çš„**å¼‚æ­¥å‡½æ•°è¿˜æœªæ‰§è¡Œå®Œæ¯•**ï¼Œæ­¤æ—¶å¤„äºç­‰å¾…çŠ¶æ€ã€‚ç›¸åï¼Œå¦‚æœ `promise` ä¸­çš„å¼‚æ­¥å‡½æ•°æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œé‚£ä¹ˆå®ƒ**åªä¼šèµ°å‘ä¸¤ä¸ªç»“æœï¼š**

- `fulfilled` ï¼Œè¡¨ç¤º**æˆåŠŸ**ï¼›
- `rejected` ï¼Œè¡¨ç¤º**å¤±è´¥**ã€‚

ä¸€æ—¦æœ€ç»ˆçŠ¶æ€ä» `pending` å˜åŒ–ä¸º `fulfilled` æˆ–è€… `rejected` åï¼Œ**çŠ¶æ€å°±å†ä¹Ÿä¸å¯é€†**ã€‚

æ‰€ä»¥ï¼Œæ€»ç»“æ¥è®²ï¼Œ`Promise` å¯¹è±¡æœ‰**ä»¥ä¸‹ä¸¤ä¸ªç‰¹ç‚¹ï¼š**

- `promise` å¯¹è±¡çš„çŠ¶æ€**ä¸å—å¤–ç•Œå½±å“**ï¼Œä¸€æ—¦çŠ¶æ€è¢«å”¤èµ·ä¹‹åï¼Œå‡½æ•°å°±äº¤ç”± `web API` å»å¤„ç†ï¼Œè¿™ä¸ªæ—¶å€™åœ¨å‡½æ•°ä¸»ä½“ä¸­**å†æ‰§è¡Œä»»ä½•æ“ä½œéƒ½æ˜¯æ²¡æœ‰ç”¨çš„**ï¼›
- åªä¼šå‡ºç° `pending` â†’ `fulfilled`ï¼Œæˆ–è€… `pending` â†’ `rejected` çŠ¶æ€ï¼Œå³è¦ä¹ˆæˆåŠŸè¦ä¹ˆå¤±è´¥ã€‚å³ä½¿å†å¯¹ `promise` å¯¹è±¡æ·»åŠ å›è°ƒå‡½æ•°ï¼Œä¹Ÿ**åªä¼šå¾—åˆ°åŒæ ·çš„ç»“æœ**ï¼Œå³å®ƒçš„çŠ¶æ€éƒ½**ä¸ä¼šå†å‘ç”Ÿè¢«æ”¹å˜**ã€‚

## 2. ä¸‰ç§çŠ¶æ€çš„å˜åŒ–å’Œè¡¨ç° ğŸ“‚

### ï¼ˆ1ï¼‰çŠ¶æ€çš„å˜åŒ–

`promise` ä¸»è¦æœ‰ä»¥ä¸Šä¸‰ç§çŠ¶æ€ï¼Œ `pending` ã€ `fulfilled` å’Œ `rejected` ã€‚å½“è¿”å›ä¸€ä¸ª `pending` çŠ¶æ€çš„ `promise` æ—¶ï¼Œä¸ä¼šè§¦å‘ `then` å’Œ `catch` ã€‚å½“è¿”å›ä¸€ä¸ª `fulfilled` çŠ¶æ€æ—¶ï¼Œä¼šè§¦å‘ `then` å›è°ƒå‡½æ•°ã€‚å½“è¿”å›ä¸€ä¸ª `rejected` çŠ¶æ€æ—¶ï¼Œä¼šè§¦å‘ `catch` å›è°ƒå‡½æ•°ã€‚é‚£åœ¨è¿™å‡ ä¸ªçŠ¶æ€ä¹‹é—´ï¼Œä»–ä»¬æ˜¯æ€ä¹ˆå˜åŒ–çš„å‘¢ï¼Ÿ

**1ï¼‰æ¼”ç¤º 1**

**å…ˆæ¥çœ‹ä¸€æ®µä»£ç ï¼š**

```js
const p1 = new Promise((resolved, rejected) => {});

console.log('p1', p1); //pending
```

åœ¨ä»¥ä¸Šçš„è¿™æ®µä»£ç ä¸­ï¼Œ**æ§åˆ¶å°æ‰“å°ç»“æœå¦‚ä¸‹ï¼š**

![çŠ¶æ€å˜åŒ–æ¼”ç¤º1](https://mondaylab-1309616765.cos.ap-shanghai.myqcloud.com/images/202305270701599.png)

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œ `p1` å‡½æ•°é‡Œé¢æ²¡æœ‰å†…å®¹å¯ä»¥æ‰§è¡Œï¼Œæ‰€ä»¥ä¸€ç›´åœ¨ç­‰å¾…çŠ¶æ€ï¼Œå› æ­¤æ˜¯ `pending` ã€‚

**2ï¼‰æ¼”ç¤º 2**

```js
const p2 = new Promise((resolved, rejected) => {
  setTimeout(() => {
    resolved();
  });
});

console.log('p2', p2); //pending ä¸€å¼€å§‹æ‰“å°æ—¶
setTimeout(() => console.log('p2-setTimeout', p2)); //fulfilled
```

åœ¨ä»¥ä¸Šçš„è¿™æ®µä»£ç ä¸­ï¼Œ**æ§åˆ¶å°æ‰“å°ç»“æœå¦‚ä¸‹ï¼š**

![çŠ¶æ€å˜åŒ–æ¼”ç¤º2](https://mondaylab-1309616765.cos.ap-shanghai.myqcloud.com/images/202305270701995.png)

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œ `p2` ä¸€å¼€å§‹æ‰“å°çš„æ˜¯ `pending` çŠ¶æ€ï¼Œå› ä¸ºå®ƒæ²¡æœ‰æ‰§è¡Œåˆ° `setTimeout` é‡Œé¢ã€‚ç­‰åˆ°åç»­æ‰§è¡Œ `setTimeout` æ—¶ï¼Œæ‰ä¼šè§¦å‘åˆ° `resolved` å‡½æ•°ï¼Œè§¦å‘åè¿”å›ä¸€ä¸ª `fulfilled` çŠ¶æ€ `promise` ã€‚

**3ï¼‰æ¼”ç¤º 3**

```js
const p3 = new Promise((resolved, rejected) => {
  setTimeout(() => {
    rejected();
  });
});

console.log('p3', p3);
setTimeout(() => console.log('p3-setTimeout', p3)); //rejected
```

åœ¨ä»¥ä¸Šçš„è¿™æ®µä»£ç ä¸­ï¼Œæ§åˆ¶å°æ‰“å°ç»“æœå¦‚ä¸‹ã€‚

![çŠ¶æ€å˜åŒ–æ¼”ç¤º3](https://mondaylab-1309616765.cos.ap-shanghai.myqcloud.com/images/202305270702861.png)

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œ `p3` ä¸€å¼€å§‹æ‰“å°çš„æ˜¯ `pending` çŠ¶æ€ï¼Œå› ä¸ºå®ƒæ²¡æœ‰æ‰§è¡Œåˆ° `setTimeout` é‡Œé¢ã€‚ç­‰åˆ°åç»­æ‰§è¡Œ `setTimeout` æ—¶ï¼ŒåŒæ ·åœ°ï¼Œä¼šè§¦å‘åˆ° `rejected` å‡½æ•°ï¼Œè§¦å‘åè¿”å›ä¸€ä¸ª `rejected` çŠ¶æ€çš„ `promise` ã€‚

çœ‹å®Œ `promise` çŠ¶æ€çš„å˜åŒ–åï¼Œç›¸ä¿¡å¤§å®¶å¯¹ `promise` çš„ä¸‰ç§çŠ¶æ€åˆ†åˆ«åœ¨ä»€ä¹ˆæ—¶å€™è§¦å‘ä¼šæœ‰ä¸€å®šçš„äº†è§£ã€‚é‚£ä¹ˆæˆ‘ä»¬æ¥ä¸‹æ¥ç»§ç»­çœ‹ `promise` çŠ¶æ€çš„è¡¨ç°ã€‚

### ï¼ˆ2ï¼‰çŠ¶æ€çš„è¡¨ç°

- `pending` çŠ¶æ€ï¼Œä¸ä¼šè§¦å‘ `then` å’Œ `catch` ã€‚
- `fulfilled` çŠ¶æ€ï¼Œä¼šè§¦å‘åç»­çš„ `then` å›è°ƒå‡½æ•°ã€‚
- `rejected` çŠ¶æ€ï¼Œä¼šè§¦å‘åç»­çš„ `catch` å›è°ƒå‡½æ•°ã€‚

æˆ‘ä»¬æ¥æ¼”ç¤ºä¸€ä¸‹ã€‚

**1ï¼‰æ¼”ç¤º 1**

```js
const p1 = Promise.resolve(100); //fulfilled
console.log('p1', p1);
p1.then((data) => {
  console.log('data', data);
}).catch((err) => {
  console.error('err', err);
});
```

åœ¨ä»¥ä¸Šçš„è¿™æ®µä»£ç ä¸­ï¼Œ**æ§åˆ¶å°æ‰“å°ç»“æœå¦‚ä¸‹ï¼š**

![çŠ¶æ€çš„è¡¨ç°æ¼”ç¤º1](https://mondaylab-1309616765.cos.ap-shanghai.myqcloud.com/images/202305270702626.png)

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œ `p1` è°ƒç”¨ `promise` ä¸­çš„ `resolved` å›è°ƒå‡½æ•°ï¼Œæ­¤æ—¶æ‰§è¡Œæ—¶ï¼Œ `p1` å±äº `fulfilled` çŠ¶æ€ï¼Œ `fulfilled` çŠ¶æ€ä¸‹ï¼Œåªä¼šè§¦å‘ `.then` å›è°ƒå‡½æ•°ï¼Œä¸ä¼šè§¦å‘ `.catch` ï¼Œæ‰€ä»¥æœ€ç»ˆæ‰“å°å‡º `data 100` ã€‚

**2ï¼‰æ¼”ç¤º 2**

```js
const p2 = Promise.reject('404'); //rejected
console.log('p2', p2);
p2.then((data) => {
  console.log('data2', data);
}).catch((err) => {
  console.log('err2', err);
});
```

åœ¨ä»¥ä¸Šçš„è¿™æ®µä»£ç ä¸­ï¼Œ**æ§åˆ¶å°æ‰“å°ç»“æœå¦‚ä¸‹ï¼š**

![çŠ¶æ€çš„è¡¨ç°æ¼”ç¤º2](https://mondaylab-1309616765.cos.ap-shanghai.myqcloud.com/images/202305270702549.png)

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œ `p2` è°ƒç”¨ `promise` ä¸­çš„ `reject` å›è°ƒå‡½æ•°ï¼Œæ­¤æ—¶æ‰§è¡Œæ—¶ï¼Œ `p1` å±äº `reject` çŠ¶æ€ï¼Œ `reject` çŠ¶æ€ä¸‹ï¼Œåªä¼šè§¦å‘ `.catch` å›è°ƒå‡½æ•°ï¼Œä¸ä¼šè§¦å‘ `.then` ï¼Œæ‰€ä»¥æœ€ç»ˆæ‰“å°å‡º `err2 404` ã€‚

## 3. Promise çš„ä½¿ç”¨æ¡ˆä¾‹ ğŸ“‚

å¯¹ä¸‰ç§çŠ¶æ€æœ‰äº†åŸºç¡€äº†è§£ä¹‹åï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªæ¡ˆä¾‹æ¥ç²¾è¿›å¯¹ `Promise` çš„ä½¿ç”¨ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬æƒ³è¦å®ç°çš„åŠŸèƒ½æ˜¯ï¼Œé€šè¿‡ `fs` æ¨¡å—ï¼Œå¼‚æ­¥åœ°è°ƒç”¨æœ¬åœ°çš„æ–‡ä»¶ã€‚å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œé‚£ä¹ˆåœ¨æ§åˆ¶å°ä¸Šè¾“å‡ºæ–‡ä»¶çš„å†…å®¹ï¼›å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™å°†æŠ›å‡ºå¼‚å¸¸ã€‚**å®ç°ä»£ç å¦‚ä¸‹ï¼š**

```js
const fs = require('fs');

const readFile = (filename) => {
  // è¿”å›ä¸€ä¸ª promise å®ä¾‹ï¼Œä»¥ä¾› then è°ƒç”¨
  const promise = new Promise(function (resolve, reject) {
    // ä½¿ç”¨ readFile å»å¼‚æ­¥åœ°è¯»å–æ–‡ä»¶ï¼Œå¼‚æ­¥è°ƒç”¨ä¹Ÿæ˜¯ promise å‡½æ•°çš„æ„ä¹‰
    // æ³¨æ„ï¼šä¸‹é¢è¿™ä¸ªå‡½æ•°çš„é€»è¾‘æ˜¯é”™è¯¯ä¼˜å…ˆï¼Œä¹Ÿå°±æ˜¯å…ˆerrï¼Œå†data
    fs.readFile(filename, (err, data) => {
      // å¦‚æœæ–‡ä»¶è¯»å–å¤±è´¥ï¼Œå°±è°ƒå– reject ï¼Œå¹¶æŠ›å‡ºå¼‚å¸¸
      if (err) {
        reject(err);
      } else {
        // å¦‚æœæˆåŠŸï¼Œå°±è°ƒå– resolve ï¼Œå¹¶è¿”å›è°ƒç”¨æˆåŠŸçš„æ•°æ®
        resolve(data);
      }
    });
  });
  return promise;
};

// æµ‹è¯•ä»£ç 
// æ–‡ä»¶å­˜åœ¨é€»è¾‘
const existedFile = readFile('./test.txt');
existedFile.then(
  (data) => {
    // Buffer.from()æ–¹æ³•ç”¨äºåˆ›å»ºåŒ…å«æŒ‡å®šå­—ç¬¦ä¸²ï¼Œæ•°ç»„æˆ–ç¼“å†²åŒºçš„æ–°ç¼“å†²åŒºã€‚
    // Buffer.from(data).toString()è¯»å‡ºæ–‡ä»¶é‡Œé¢çš„å†…å®¹ã€‚æ–‡ä»¶é‡Œé¢è®°å¾—å†™å†…å®¹ï¼ï¼
    console.log('content: ', Buffer.from(data).toString());
  },
  (error) => {
    console.log(error);
  }
);

// æ–‡ä»¶ä¸å­˜åœ¨é€»è¾‘
const failFile = readFile('./fail.txt');
failFile.then(
  (data) => {
    console.log(Buffer.from(data).toString());
  },
  (err) => {
    console.log(err);
  }
);
```

**æœ€ç»ˆæ§åˆ¶å°çš„æ‰“å°ç»“æœå¦‚ä¸‹ï¼š**

```js
[Error: ENOENT: no such file or directory, open 'C:\\promise\\fail.txt'] {
  errno: -4058,
  code: 'ENOENT',
  syscall: 'open',
  path: 'C:\\promise\\fail.txt'
}
content:  è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ï¼
```

å¤§å®¶å¯ä»¥çœ‹åˆ°ï¼Œå½“ `./test.txt` æ–‡ä»¶å­˜åœ¨æ—¶ï¼Œé‚£ä¹ˆ `existedFile` ä¼šå»è°ƒç”¨åç»­çš„ `.then` å›è°ƒå‡½æ•°ï¼Œå› æ­¤æœ€ç»ˆè¿”å›è°ƒç”¨æˆåŠŸçš„ç»“æœã€‚æ³¨æ„ï¼Œ`è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ï¼` è¿™è¡Œå­—å°±æ˜¯ `test` æ–‡ä»¶é‡Œé¢çš„å†…å®¹ã€‚

åŒæ—¶ï¼Œ `./fail.txt` æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå› æ­¤ `failFile` ä¼šè°ƒç”¨åç»­çš„ `.catch` æ–‡ä»¶ï¼ŒåŒæ—¶å°†å¼‚å¸¸æŠ›å‡ºã€‚

ç°åœ¨ï¼Œå¤§å®¶åº”è¯¥å¯¹ `promise` çš„ä½¿ç”¨æœ‰äº†ä¸€å®šçš„äº†è§£ï¼Œä¸‹é¢æˆ‘ä»¬ç»§ç»­çœ‹ `promise` ä¸­ `then` å’Œ `catch` å¯¹çŠ¶æ€çš„å½±å“ã€‚

## 4. then å’Œ catch å¯¹çŠ¶æ€çš„å½±å“ ğŸ“‚

- `then` æ­£å¸¸è¿”å› `fulfilled` ï¼Œé‡Œé¢æœ‰æŠ¥é”™åˆ™è¿”å› `rejected` ï¼›
- `catch` æ­£å¸¸è¿”å› `fulfilled` ï¼Œé‡Œé¢æœ‰æŠ¥é”™åˆ™è¿”å› `rejected` ã€‚

**æˆ‘ä»¬å…ˆæ¥çœ‹ç¬¬ä¸€æ¡è§„åˆ™ï¼š** `then` æ­£å¸¸è¿”å› `fulfilled` ï¼Œé‡Œé¢æœ‰æŠ¥é”™åˆ™è¿”å› `rejected` ã€‚

**1ï¼‰æ¼”ç¤º 1**

```js
const p1 = Promise.resolve().then(() => {
  return 100;
});
console.log('p1', p1); //fulfilledçŠ¶æ€ï¼Œä¼šè§¦å‘åç»­çš„.thenå›è°ƒ
p1.then(() => {
  console.log('123');
});
```

åœ¨ä»¥ä¸Šçš„è¿™æ®µä»£ç ä¸­ï¼Œæ§åˆ¶å°æ‰“å°ç»“æœå¦‚ä¸‹ã€‚

![thenå’Œcatchå¯¹çŠ¶æ€çš„å½±å“æ¼”ç¤º1](https://mondaylab-1309616765.cos.ap-shanghai.myqcloud.com/images/202305270702096.png)

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œ `p1` è°ƒç”¨ `promise` ä¸­çš„ `resolve` å›è°ƒå‡½æ•°ï¼Œæ­¤æ—¶æ‰§è¡Œæ—¶ï¼Œ `p1` æ­£å¸¸è¿”å› `fulfilled` ï¼Œ ä¸æŠ¥é”™ï¼Œæ‰€ä»¥æœ€ç»ˆæ‰“å°å‡º `123` ã€‚

**2ï¼‰æ¼”ç¤º 2**

```js
const p2 = Promise.resolve().then(() => {
  throw new Error('then error');
});
console.log('p2', p2); //rejectedçŠ¶æ€ï¼Œè§¦å‘åç»­.catchå›è°ƒ
p2.then(() => {
  console.log('456');
}).catch((err) => {
  console.error('err404', err);
});
```

åœ¨ä»¥ä¸Šçš„è¿™æ®µä»£ç ä¸­ï¼Œæ§åˆ¶å°æ‰“å°ç»“æœå¦‚ä¸‹ã€‚

![thenå’Œcatchå¯¹çŠ¶æ€çš„å½±å“æ¼”ç¤º2](https://mondaylab-1309616765.cos.ap-shanghai.myqcloud.com/images/202305270702874.png)

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œ `p2` è°ƒç”¨ `promise` ä¸­çš„ `resolve` å›è°ƒå‡½æ•°ï¼Œæ­¤æ—¶æ‰§è¡Œæ—¶ï¼Œ `p2` åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼ŒæŠ›å‡ºäº†ä¸€ä¸ª `Error` ï¼Œæ‰€ä»¥ï¼Œé‡Œé¢æœ‰æŠ¥é”™åˆ™è¿”å› `rejected` çŠ¶æ€ ï¼Œ æ‰€ä»¥æœ€ç»ˆæ‰“å°å‡º `err404 Error: then error` çš„ç»“æœã€‚

**æˆ‘ä»¬å†æ¥çœ‹ç¬¬äºŒæ¡è§„åˆ™**ï¼š `catch` æ­£å¸¸è¿”å› `fulfilled` ï¼Œé‡Œé¢æœ‰æŠ¥é”™åˆ™è¿”å› `rejected` ã€‚

**1ï¼‰æ¼”ç¤º 1ï¼ˆéœ€ç‰¹åˆ«è°¨æ…! !ï¼‰**

```js
const p3 = Promise.reject('my error').catch((err) => {
  console.error(err);
});
console.log('p3', p3); //fulfilledçŠ¶æ€ï¼Œæ³¨æ„ï¼è§¦å‘åç»­.thenå›è°ƒ
p3.then(() => {
  console.log(100);
});
```

åœ¨ä»¥ä¸Šçš„è¿™æ®µä»£ç ä¸­ï¼Œæ§åˆ¶å°æ‰“å°ç»“æœå¦‚ä¸‹ã€‚

![thenå’Œcatchå¯¹çŠ¶æ€çš„å½±å“æ¼”ç¤º3](https://mondaylab-1309616765.cos.ap-shanghai.myqcloud.com/images/202305270702156.png)

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œ `p3` è°ƒç”¨ `promise` ä¸­çš„ `rejected` å›è°ƒå‡½æ•°ï¼Œæ­¤æ—¶æ‰§è¡Œæ—¶ï¼Œ `p3` åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ­£å¸¸è¿”å›äº†ä¸€ä¸ª `Error` ï¼Œ**è¿™ä¸ªç‚¹éœ€è¦ç‰¹åˆ«è°¨æ…**ï¼ï¼è¿™çœ‹èµ·æ¥ä¼¼ä¹æœ‰ç‚¹è¿èƒŒå¸¸ç†ï¼Œä½†å¯¹äº `promise` æ¥è¯´ï¼Œä¸ç®¡æ—¶è°ƒç”¨ `resolved` è¿˜æ˜¯ `rejected` ï¼Œåªè¦æ˜¯æ­£å¸¸è¿”å›è€Œæ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ï¼Œéƒ½æ˜¯è¿”å› `fulfilled` çŠ¶æ€ã€‚æ‰€ä»¥ï¼Œæœ€ç»ˆ `p3` çš„çŠ¶æ€æ˜¯ `fulfilled` çŠ¶æ€ï¼Œä¸”å› ä¸ºæ˜¯ `fulfilled` çŠ¶æ€ï¼Œä¹‹åè¿˜å¯ä»¥ç»§ç»­è°ƒç”¨ `.then` å‡½æ•°ã€‚

**2ï¼‰æ¼”ç¤º 2**

```js
const p4 = Promise.reject('my error').catch((err) => {
  throw new Error('catch err');
});
console.log('p4', p4); //rejectedçŠ¶æ€ï¼Œè§¦å‘.catchå›è°ƒå‡½æ•°
p4.then(() => {
  console.log(200);
}).catch(() => {
  console.log('some err');
});
```

åœ¨ä»¥ä¸Šçš„è¿™æ®µä»£ç ä¸­ï¼Œæ§åˆ¶å°æ‰“å°ç»“æœå¦‚ä¸‹ã€‚

![thenå’Œcatchå¯¹çŠ¶æ€çš„å½±å“æ¼”ç¤º4](https://mondaylab-1309616765.cos.ap-shanghai.myqcloud.com/images/202305270702757.png)

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œ `p4` ä¾ç„¶è°ƒç”¨ `promise` ä¸­çš„ `reject` å›è°ƒå‡½æ•°ï¼Œæ­¤æ—¶æ‰§è¡Œæ—¶ï¼Œ `p4` åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼ŒæŠ›å‡ºäº†ä¸€ä¸ª `Error` ï¼Œæ‰€ä»¥ï¼Œé‡Œé¢æœ‰æŠ¥é”™åˆ™è¿”å› `rejected` çŠ¶æ€ ï¼Œ æ­¤æ—¶ `p4` çš„çŠ¶æ€ä¸º `rejected` ï¼Œä¹‹åè§¦å‘åç»­çš„ `.catch` å›è°ƒå‡½æ•°ã€‚æ‰€ä»¥æœ€ç»ˆæ‰“å°å‡º `some err` çš„ç»“æœã€‚

## 5. Promise çš„å¹¶è¡Œæ‰§è¡Œ ğŸ“‚

### ï¼ˆ1ï¼‰Promise.all

`Promise.all` æ–¹æ³•ç”¨äºå°†å¤šä¸ª `Promise` å®ä¾‹åŒ…è£…æˆä¸€ä¸ªæ–°çš„ `Promise` å®ä¾‹ã€‚**æ¯”å¦‚ï¼š**

```js
var p = Promise.all([p1, p2, p3]);
```

p çš„çŠ¶æ€ç”± `p1` ã€ `p2` ã€ `p3` å†³å®šï¼Œ**åˆ†æˆä¸¤ç§æƒ…å†µï¼š**

- åªæœ‰ `p1` ã€ `p2` ã€ `p3` çš„çŠ¶æ€éƒ½å˜ä¸º `fulfilled` ï¼Œæœ€ç»ˆ `p` çš„çŠ¶æ€æ‰ä¼šå˜ä¸º `fulfilled` ã€‚æ­¤æ—¶ `p1` ã€ `p2` ã€ `p3` çš„è¿”å›å€¼ç»„æˆä¸€ä¸ªæ•°ç»„ï¼Œå¹¶è¿”å›ç»™ `p` å›è°ƒå‡½æ•°ã€‚
- åªè¦ `p1` ã€ `p2` ã€ `p3` è¿™ä¸‰ä¸ªå‚æ•°ä¸­æœ‰ä»»ä½•ä¸€ä¸ªè¢« `rejected` ï¼Œ é‚£ä¹ˆ `p` çš„çŠ¶æ€å°±ä¼šå˜æˆ `rejected` ã€‚æ­¤æ—¶ç¬¬ä¸€ä¸ªè¢« `rejected` çš„å®ä¾‹çš„è¿”å›å€¼å°†ä¼šè¿”å›ç»™ `p` çš„å›è°ƒå‡½æ•°ã€‚

ä¸‹é¢ç”¨ä¸€ä¸ªå®ä¾‹æ¥å±•ç¤º `Promise.all` çš„ä½¿ç”¨æ–¹å¼ã€‚**å…·ä½“ä»£ç å¦‚ä¸‹ï¼š**

```js
//ç”Ÿæˆä¸€ä¸ªPromiseå¯¹è±¡çš„æ•°ç»„
var promises = [4, 8, 16, 74, 25].map(function (id) {
    return getJSON('/post/' + id + ".json");
});

Promise.all(promises).then(fucntion (posts) {
	// ...
}).catch(function (reason) {
	// ...
}}
```

å¤§å®¶å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºä»¥ä¸Šä»£ç æ¥è¯´ï¼Œ `promises` æ˜¯åŒ…å« 5 ä¸ª Promise å®ä¾‹çš„æ•°ç»„ï¼Œåªæœ‰è¿™**5 ä¸ªå®ä¾‹çš„çŠ¶æ€éƒ½å˜æˆ fulfilled** ï¼Œæˆ–è€…**å…¶ä¸­æœ‰ä¸€ä¸ªå˜ä¸º rejected** ï¼Œé‚£ä¹ˆæ‰ä¼šè°ƒç”¨ `Promise.all` æ–¹æ³•åé¢çš„å›è°ƒå‡½æ•°ã€‚

---

è¿™é‡Œæœ‰ä¸€ç§å€¼å¾—æ³¨æ„çš„ç‰¹æ®Šæƒ…å†µæ˜¯ï¼Œå¦‚æœä½œä¸ºå‚æ•°çš„ `Promise` å®ä¾‹è‡ªèº«å®šä¹‰äº† `catch` æ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒè¢« `rejected` æ—¶å¹¶ä¸ä¼šè§¦å‘ `Promise.all()` çš„ `catch` æ–¹æ³•ã€‚è¿™æ ·è¯´å¯èƒ½æ¯”è¾ƒæŠ½è±¡ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªå®ä¾‹æ¥å±•ç¤ºä¸€ä¸‹ï¼Œ**å…·ä½“ä»£ç å¦‚ä¸‹ï¼š**

```js
const p1 = new Promise((resolve, reject) => {
  resolve('hello');
})
  .then((result) => {
    return result;
  })
  .catch((e) => {
    return e;
  });

const p2 = new Promise((resolve, reject) => {
  throw new Error('æŠ¥é”™äº†');
})
  .then((result) => {
    return result;
  })
  .catch((e) => {
    return e;
  });

Promise.all([p1, p2])
  .then((result) => {
    console.log(result);
  })
  .catch((e) => {
    console.log(e);
  });
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ `p1` ä¼š `resolve` ï¼Œä¹‹åè°ƒç”¨åç»­çš„ `.then` å›è°ƒå‡½æ•°ã€‚è€Œ `p2` ä¼š `reject` ï¼Œå› æ­¤ä¹‹åä¼šè°ƒç”¨åç»­çš„ `.catch` å›è°ƒå‡½æ•°ã€‚æ³¨æ„ï¼Œè¿™é‡Œçš„ `p2` æœ‰è‡ªå·±çš„ `catch` æ–¹æ³•ï¼Œä¸”è¯¥æ–¹æ³•è¿”å›çš„æ—¶ä¸€ä¸ªæ–°çš„ `Promise` å®ä¾‹ï¼Œè€Œ `p2` å®é™…ä¸ŠæŒ‡å‘çš„å°±æ˜¯è¿™ä¸ªå®ä¾‹ã€‚

æ‰€ä»¥å‘¢ï¼Œè¿™ä¸ªå®ä¾‹æ‰§è¡Œå®Œ `catch` æ–¹æ³•åä¹Ÿä¼šå˜æˆ `resolved` ã€‚å› æ­¤ï¼Œ åœ¨ `Promise.all()` è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œå…¶å‚æ•°é‡Œé¢çš„ä¸¤ä¸ªå®ä¾‹å°±éƒ½ä¼š `resolved` ï¼Œæ‰€ä»¥ä¹‹åä¼šè°ƒç”¨ `then` æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼Œè€Œä¸ä¼šè°ƒç”¨ `catch` æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚

### ï¼ˆ2ï¼‰Promise.race

`Promise.race` æ–¹æ³•åŒæ ·æ˜¯å°†å¤šä¸ª `Promise` å®ä¾‹åŒ…è£…æˆä¸€ä¸ªæ–°çš„ `Promise` å®ä¾‹ã€‚**æ¯”å¦‚ï¼š**

```js
var p = Promise.race([p1, p2, p3]);
```

æˆ‘ä»¬åŒæ ·ç”¨ä»¥ä¸Šè¿™æ®µä»£ç æ¥è¿›è¡Œåˆ†æã€‚ä¸ `Promise.all()` ä¸åŒçš„æ˜¯ï¼Œ**åªè¦ `p1` ã€ `p2` ã€ `p3` ä¸­æœ‰ä¸€ä¸ªå®ä¾‹ç‡å…ˆæ”¹å˜çŠ¶æ€**ï¼Œé‚£ä¹ˆ** `p` çš„çŠ¶æ€å°±ä¼šè·Ÿç€æ”¹å˜**ï¼Œä¸”é‚£ä¸ª**ç‡å…ˆæ”¹å˜çš„ Promise å®ä¾‹çš„è¿”å›å€¼**å°±ä¼šä¼ é€’ç»™ `p` çš„å›è°ƒå‡½æ•°ã€‚

æ‰€ä»¥å‘€ï¼Œä¸ºä»€ä¹ˆå®ƒå« `race` ï¼Ÿ `race` ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯**ç«èµ›**çš„æ„æ€ã€‚åœ¨èµ›åœºä¸Šï¼Œç¬¬ä¸€åæ°¸è¿œåªæœ‰ä¸€ä¸ªã€‚è€Œæˆ‘ä»¬å¯ä»¥æŠŠç¬¬ä¸€åè§†ä¸ºç¬¬ä¸€ä¸ª `resolve` çŠ¶æ€çš„ `promise` ï¼Œåªè¦ç¬¬ä¸€åå‡ºç°äº†ï¼Œé‚£ä¹ˆç»“æœå°±æ˜¯ç¬¬ä¸€åèµ¢äº†ï¼Œæ‰€ä»¥è¿”å›çš„å€¼å°±æ˜¯ç¬¬ä¸€ä¸ªä¸º `resolve` çš„å€¼ã€‚å…¶ä»–äººå†æ€ä¹ˆèµ›è·‘éƒ½é€ƒä¸è¿‡æ‹¿ä¸åˆ°ç¬¬ä¸€çš„ç°å®ã€‚

## 6. ä¸¤ä¸ªæœ‰ç”¨çš„é™„åŠ æ–¹æ³• ğŸ“‚

`ES6` ä¸­ `Promise API` å¹¶æ²¡æœ‰æä¾›å¾ˆå¤šæ–¹æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥è‡ªå·±æ¥éƒ¨ç½²ä¸€äº›æœ‰ç”¨çš„æ–¹æ³•ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ¥éƒ¨ç½²ä¸¤ä¸ªä¸åœ¨ `ES6` ä¸­ä½†æ˜¯å´å¾ˆæœ‰ç”¨çš„æ–¹æ³•ã€‚

### ï¼ˆ1ï¼‰done()

æ— è®º `Promise` å¯¹è±¡çš„å›è°ƒé“¾ä»¥ `then` æ–¹æ³•è¿˜æ˜¯ `catch` æ–¹æ³•ç»“å°¾ï¼Œåªè¦æœ€åä¸€ä¸ªæ–¹æ³•æŠ›å‡ºé”™è¯¯ï¼Œé‚£ä¹ˆéƒ½æœ‰å¯èƒ½å‡ºç°æ— æ³•æ•æ‰åˆ°çš„æƒ…å†µã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼ŸåŸå› åœ¨äº `promise` å†…éƒ¨çš„é”™è¯¯**å¹¶ä¸ä¼šå†’æ³¡åˆ°å…¨å±€**ã€‚å› æ­¤ï¼Œæˆ‘ä»¬æä¾›äº†ä¸€ä¸ª `done` æ–¹æ³•ã€‚`done` æ–¹æ³•æ€»æ˜¯å¤„äºå›è°ƒé“¾çš„å°¾ç«¯ï¼Œä¿è¯æŠ›å‡º**ä»»ä½•å¯èƒ½å‡ºç°çš„é”™è¯¯**ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒçš„ä½¿ç”¨æ–¹å¼ï¼Œ**å…·ä½“ä»£ç å¦‚ä¸‹ï¼š**

```js
asyncFunc().then(f1).catch(r1).then(f2).done();
```

åŒæ—¶å‘¢ï¼Œå®ƒçš„å®ç°ä»£ç ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ã€‚**å…·ä½“ä»£ç å¦‚ä¸‹ï¼š**

```js
Promise.prototype.done = function (onFulfilled, onRejected) {
  this.then(onFulfilled, onRejected).catch(function (reason) {
    //æŠ›å‡ºä¸€ä¸ªå…¨å±€é”™è¯¯
    setTimeout(() => {
      throw reason;
    }, 0);
  });
};
```

ç”±ä»¥ä¸Šä»£ç å¯çŸ¥ï¼Œ `done` æ–¹æ³•å¯ä»¥åƒ `then` æ–¹æ³•é‚£æ ·ä½¿ç”¨ï¼Œæä¾› `fulfilled` å’Œ `rejected` çŠ¶æ€çš„å›è°ƒå‡½æ•°ï¼Œä¹Ÿå¯ä»¥ä¸æä¾›ä»»ä½•å‚æ•°ã€‚ä½†æ˜¯ä¸ç®¡å¦‚ä½•ï¼Œ `done` æ–¹æ³•éƒ½ä¼šæ•æ‰åˆ°ä»»ä½•å¯èƒ½å‡ºç°çš„é”™è¯¯ï¼Œå¹¶å‘å…¨å±€æŠ›å‡ºã€‚

### ï¼ˆ2ï¼‰finally()

`finally` æ–¹æ³•ç”¨äºæŒ‡å®šä¸ç®¡ `Promise` å¯¹è±¡æœ€åçŠ¶æ€å¦‚ä½•éƒ½ä¼šæ‰§è¡Œçš„æ“ä½œã€‚å®ƒä¸ `done` æ–¹æ³•æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼Œå®ƒæ¥å—ä¸€ä¸ªæ™®é€šçš„**å›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°**ï¼Œè¯¥å‡½æ•°ä¸ç®¡æ€æ ·éƒ½å¿…é¡»æ‰§è¡Œã€‚

ä¸‹é¢æ¥å±•ç¤ºä¸€ä¸ªä¾‹å­ã€‚å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ä¸€å°æœåŠ¡å™¨ï¼Œç°åœ¨è®©è¿™å°æœåŠ¡å™¨ä½¿ç”¨ `Promise` æ¥å¤„ç†è¯·æ±‚ï¼Œç„¶åä½¿ç”¨ `finally` æ–¹æ³•å…³æ‰æœåŠ¡å™¨ã€‚**å…·ä½“å®ç°ä»£ç å¦‚ä¸‹ï¼š**

```js
server
  .listen(0)
  .then(function () {
    // run test
  })
  .finally(server.stop);
```

åŒæ ·åœ°ï¼Œå®ƒçš„å®ç°ä»£ç ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ã€‚**å…·ä½“ä»£ç å¦‚ä¸‹ï¼š**

```js
Promise.prototype.finally = function (callback) {
  let p = this.constructor;
  return this.then(
    (value) =>
      p.resolve(callback()).then(() => {
        return value;
      }),
    (reason) =>
      p.resolve(callback()).then(() => {
        throw reason;
      })
  );
};
```

é€šè¿‡ä»¥ä¸Šä»£ç æˆ‘ä»¬å¯ä»¥äº†è§£åˆ°ï¼Œä¸ç®¡å‰é¢çš„ `promise` æ˜¯ `fulfilled` è¿˜æ˜¯ `rejected` ï¼Œæœ€ç»ˆéƒ½ä¼šæ‰§è¡Œå›è°ƒå‡½æ•° `callback` ã€‚

# ğŸ“‘ ä¸‰ã€å®ç° Promise çš„æ ¸å¿ƒåŠŸèƒ½

## 1. åŸºç¡€æ ¸å¿ƒåŠŸèƒ½å®ç° ğŸ·ï¸

### ï¼ˆ1ï¼‰ç¢ç¢å¿µ

æ¥ä¸‹æ¥æˆ‘ä»¬å…ˆæ¥å®ç° `promise` æœ€åŸºç¡€çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯ `promise.resolve()` å’Œ `promise.reject()` è¿™ä¸¤ä¸ªå‡½æ•°ã€‚

æ³¨æ„ï¼šåŸºç¡€åŠŸèƒ½é™¤äº†æ„é€ å™¨ `constructor` æ„ä»¥å¤–ï¼Œå…¶ä½™çš„å®ç°éƒ½**ä¸æ˜¯ç»‘å®šåœ¨åŸå‹é“¾ä¸Šçš„å‡½æ•°**ï¼Œå°†ä¼šä½¿ç”¨**ç®­å¤´å‡½æ•°**æ¥è¿›è¡Œå®ç°ã€‚

### ï¼ˆ2ï¼‰Promise åŸºç¡€åŠŸèƒ½çš„åˆ†æ

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ `promise` çš„åŸºæœ¬ä½¿ç”¨æ˜¯æ€ä¹ˆæ ·çš„ï¼Œ**å…·ä½“ä»£ç å¦‚ä¸‹ï¼š**

```js
/**
 * 01_promiseçš„åŸºæœ¬ä½¿ç”¨
 */
const promise = new Promise(function (resolve, reject) {
  if (success) {
    resolve(value);
  } else {
    reject(error);
  }
});
```

æ ¹æ®ä½¿ç”¨æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡º `promise` æœ‰**ä»¥ä¸‹å‡ ä¸ªç‰¹ç‚¹ï¼š**

- `promise` æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼›
- å½“æˆ‘ä»¬æ–°å»ºä¸€ä¸ª `promise` å¯¹è±¡çš„åŒæ—¶ï¼Œéœ€è¦ä¼ è¿›å»ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼›
- è¿™ä¸ªå›è°ƒå‡½æ•°åˆéœ€è¦æ¥æ”¶ä¸¤ä¸ªå›è°ƒå‡½æ•° `resolve` å’Œ `reject` ï¼Œä¸”ç”¨è¿™**ä¸¤ä¸ªå›è°ƒå‡½æ•°æ¥ä½œä¸ºå‚æ•°**ï¼Œä¹‹åå‘¢ï¼Œ å½“è°ƒç”¨æˆåŠŸæ—¶ï¼Œä½¿ç”¨ `resolve` å›è°ƒå‡½æ•°ï¼Œè€Œå½“è°ƒç”¨å¤±è´¥æ—¶ï¼Œä½¿ç”¨ `reject` å›è°ƒå‡½æ•°ã€‚
- `resolve` å’Œ `reject` è¿™ä¸¤ä¸ªå›è°ƒå‡½æ•°éƒ½å°†ä¼šè¢«ç”¨æ¥ä¿®æ”¹ `promise` çš„çŠ¶æ€ï¼Œ `resolve` ä¼šæŠŠ `pending` çŠ¶æ€ä¿®æ”¹ä¸º `fulfilled` ï¼Œè€Œ `reject` å°†ä¼šæŠŠ `pending` çŠ¶æ€ä¿®æ”¹ä¸º `rejected` ã€‚åŒæ—¶ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ**ä¸€æ—¦çŠ¶æ€ç¡®å®šåï¼Œåç»­æ‰€æœ‰æ“ä½œçš„çŠ¶æ€å°†ä¸ä¼šå†è¢«æ›´æ”¹ï¼Œå³ä¸å¯é€†**ã€‚

### ï¼ˆ3ï¼‰Promise åŸºç¡€åŠŸèƒ½çš„å®ç°

æˆ‘ä»¬ç°åœ¨æ¥å®ç° `promise` çš„åŸºæœ¬åŠŸèƒ½ï¼Œ**è¯¥åŠŸèƒ½å«æœ‰ä»¥ä¸‹å‡ ä¸ªç»„æˆè¦ç´ ï¼š**

- å®ç° `PromiseMon` çš„åŸºç¡€ç»“æ„ï¼Œå…¶ä¸­åŒ…å«æ„é€ å‡½æ•°å’ŒçŠ¶æ€ï¼›
- å®ç° `resolve` å’Œ `reject` åŠŸèƒ½ï¼Œè¿™é‡Œå…ˆå®ç°çŠ¶æ€ä» `pending` åˆ° `fulfilled` æˆ– `rejected` çš„æ”¹å˜ï¼Œå…¶ä½™çŠ¶æ€é—´çš„æ”¹å˜æš‚æœªå®ç°ã€‚

**å…·ä½“å®ç°ä»£ç å¦‚ä¸‹ï¼š**

```js
/**
 * 02_promiseåŸºç¡€åŠŸèƒ½çš„å®ç°
 */

// å®šä¹‰pendingã€fulfilledå’Œrejectedä¸‰ä¸ªå¸¸é‡
const PENDING = 'pending';
const FULFILLED = 'fulfilled';
const REJECTED = 'rejected';

class PromiseMon {
  // å®šä¹‰Promiseä¸­çš„çŠ¶æ€ï¼Œé»˜è®¤çŠ¶æ€ä¸ºpending
  status = PENDING;

  // cbå³callback,æ˜¯ä¼ ç»™promiseçš„å›è°ƒå‡½æ•°
  constructor(cb) {
    // cbè¿™ä¸ªå›è°ƒå‡½æ•°ä¼šè¢«ç«‹å³æ‰§è¡Œï¼Œä½œç”¨æ˜¯åˆ¤æ–­çŠ¶æ€æ˜¯å¦åº”è¯¥è¿›è¡Œæ›´æ”¹
    cb(this.resolve, this.reject);
  }

  // ä½¿ç”¨ç®­å¤´å‡½æ•°çš„åŸå› ï¼šç®­å¤´å‡½æ•°å¯ä»¥å‡å°‘thisæŒ‡å‘é€ æˆçš„é—®é¢˜ï¼Œå°†å…¶ç»‘å®šåœ¨promiseçš„å®ä¾‹å¯¹è±¡
  // resolveå›è°ƒå‡½æ•°
  resolve = () => {
    // åªæœ‰å½“çŠ¶æ€ä¸ºpendingæ—¶æ‰èƒ½ä¿®æ”¹
    if (this.status != PENDING) {
      return;
    } else {
      this.status = FULFILLED;
    }
  };

  // rejectå›è°ƒå‡½æ•°
  reject = () => {
    åªæœ‰å½“çŠ¶æ€ä¸ºpendingæ—¶æ‰èƒ½ä¿®æ”¹;
    if (this.status != PENDING) {
      return;
    } else {
      this.status = REJECTED;
    }
  };
}

// è°ƒç”¨resolveå’Œrejectæ¥éªŒè¯çŠ¶æ€åœ¨ç¡®å®šä¹‹åä¸å¯é€†
const promise1 = new PromiseMon((resolve, reject) => {
  resolve('resolved');
  reject('rejected');
});

const promise2 = new PromiseMon((resolve, reject) => {
  reject('rejected');
  resolve('resolved');
});

console.log(promise1.status); // fulfilled
console.log(promise2.status); // rejected
```

### ï¼ˆ4ï¼‰thenable åŠŸèƒ½çš„åˆ†æ

ä¸Šé¢æˆ‘ä»¬ç®€å•å°è£…äº† `PromiseMon` è¿™ä¸ªå‡½æ•°ï¼Œé‚£ç°åœ¨å‘¢ï¼Œæˆ‘ä»¬ç»§ç»­ç”¨å®ƒæ¥å®ç° `thenable` çš„åŠŸèƒ½ã€‚

å¤§å®¶éƒ½çŸ¥é“ï¼Œ `promise` åœ¨è°ƒç”¨äº† `resolve` å’Œ `reject` æ–¹æ³•ä¹‹åï¼Œå°±è¯¥æ¥è§¦å‘åç»­çš„ `.then` æˆ–è€… `.catch` æ–¹æ³•äº†ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸¤ä¸ªæ–¹æ³•çš„è¯ï¼Œé‚£ä¹ˆ `promise` è¿”å›çš„æ•°æ®éƒ½æ²¡å•¥ä½¿ç”¨çš„åœ°å„¿ï¼Œé‚£è¿˜è¿”å›è¿™ä¸ªæ•°æ®æ¥å¹²å˜›å¯¹å§ã€‚

æˆ‘ä»¬ç°åœ¨å…ˆæ¥çœ‹å…³äº `then` çš„åŸºæœ¬ä½¿ç”¨æ“ä½œã€‚**å…·ä½“ä»£ç å¦‚ä¸‹ï¼š**

```js
const fs = require('fs');

const readFile = (filename) => {
  const promise = new Promise(function (resolve, reject) {
    fs.readFile(filename, (err, data) => {
      if (err) {
        reject(err);
      } else {
        resolve(data);
      }
    });
  });
  return promise;
};

const existedFile = readFile('./test.txt');
existedFile.then(
  (data) => {
    console.log('content: ', Buffer.from(data).toString());
  },
  (error) => {
    console.log(error);
  }
);
```

ç»¼ä¸Šä»£ç ï¼Œæˆ‘ä»¬æ¥åˆ†æ `then` å‡½æ•°çš„**å‡ ä¸ªç‰¹ç‚¹ï¼š**

- `then` å‡½æ•°**æ¥æ”¶ä¸¤ä¸ªå‚æ•°**ï¼Œç¬¬ä¸€ä¸ªå‚æ•°åœ¨**å¼‚æ­¥æ“ä½œæˆåŠŸæ—¶**è¿›è¡Œè°ƒç”¨ï¼Œç¬¬äºŒä¸ªåˆ™æ˜¯åœ¨**æ“ä½œå¤±è´¥æ—¶**è°ƒç”¨ã€‚
- `then` å‡½æ•°éœ€è¦èƒ½å¤Ÿåˆ†æ `promise` çš„çŠ¶æ€ï¼Œåˆ†æå®Œ `promise` çš„çŠ¶æ€åå†å†³å®šå»è°ƒç”¨**æˆåŠŸæˆ–å¤±è´¥çš„å›è°ƒå‡½æ•°**ã€‚
- `then` æ–¹æ³•è¢«å®šä¹‰åœ¨**åŸå‹å¯¹è±¡**ä¸Šï¼š `Promise.prototype.then()` ã€‚
- `then` è°ƒç”¨**æˆåŠŸçš„å›è°ƒå‡½æ•°**æ—¶ä¼šæ¥æ”¶ä¸€ä¸ª**æˆåŠŸçš„æ•°æ®**ä½œä¸ºå‚æ•°ï¼ŒåŒæ ·åœ°ï¼Œå½“ä»–è°ƒç”¨å¤±è´¥çš„å›è°ƒå‡½æ•°æ—¶ï¼Œåœ¨æ­¤ä¹‹å‰å®ƒä¹Ÿä¼šæ¥æ”¶åˆ°ä¸€ä¸ªå¤±è´¥çš„åŸå› æ¥ä½œä¸ºå‚æ•°è¿›è¡Œä¼ é€’ã€‚
- `then` ä¼šå…ˆæ¥æ”¶åˆ°ä¸€ä¸ª**æˆåŠŸçŠ¶æ€çš„æ•°æ®**ï¼Œé‚£ä¹ˆè¿™ä¸ªæ•°æ®å°±ç”¨æ¥**ä½œä¸ºå‚æ•°**ï¼Œè¿™ä¸ªå‚æ•°ä¾›ç»™**å¤„ç†æˆåŠŸçŠ¶æ€çš„å›è°ƒå‡½æ•°**è¿›è¡Œè°ƒç”¨ï¼›åŒæ ·åœ°ï¼Œå½“å¤„ç†å¤±è´¥çŠ¶æ€æ—¶ï¼Œ `then` ä¼šå…ˆæ¥æ”¶åˆ°ä¸€ä¸ª**å¤±è´¥çŠ¶æ€çš„æ•°æ®**ï¼Œä¹‹åè¿™ä¸ªæ•°æ®ç”¨æ¥**ä½œä¸ºå‚æ•°**ï¼Œè¿™ä¸ªå‚æ•°ä¾›ç»™**å¤„ç†å¤±è´¥çŠ¶æ€çš„å›è°ƒå‡½æ•°**è¿›è¡Œè°ƒç”¨ã€‚è¯´çš„è¿™ä¹ˆç»•ï¼Œæ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼š**æ¥æ”¶å½“å‰çŠ¶æ€æ•°æ®**â†’**æ•°æ®ä½œä¸ºå‚æ•°**â†’**æ‹¿æ¥ç»™å›è°ƒå‡½æ•°è°ƒç”¨**ã€‚

### ï¼ˆ5ï¼‰thenable åŠŸèƒ½çš„å®ç°

æˆ‘ä»¬ç°åœ¨æ¥å®ç° `thenable` çš„åŸºæœ¬åŠŸèƒ½ï¼Œ**è¯¥åŠŸèƒ½å«æœ‰ä»¥ä¸‹å‡ ä¸ªç»„æˆè¦ç´ ï¼š**

- å°†åœ¨åŸå‹ä¸Šå®ç° `then` æ–¹æ³•ï¼›
- ä¿®æ”¹åŸå…ˆçš„ `resolve` å‡½æ•°ï¼Œå®ç°å¯¹**æˆåŠŸçŠ¶æ€çš„æ•°æ®**è¿›è¡Œç»‘å®šï¼›
- ä¿®æ”¹åŸå…ˆçš„ `reject` å‡½æ•°ï¼Œå®ç°å¯¹**å¤±è´¥çŠ¶æ€çš„åŸå› **è¿›è¡Œç»‘å®šã€‚

**å…·ä½“å®ç°ä»£ç å¦‚ä¸‹ï¼š**

```js
/**
 * 03_thenableåŠŸèƒ½çš„å®ç°
 */

const PENDING = 'pending';
const FULFILLED = 'fulfilled';
const REJECTED = 'rejected';

class PromiseMon {
  status = PENDING;
  // å®šä¹‰æˆåŠŸå’Œå¤±è´¥æ—¶çš„å€¼ï¼Œé»˜è®¤éƒ½æ˜¯æœªå®šä¹‰
  value = undefined;
  reason = undefined;

  constructor(cb) {
    // cbè¿™ä¸ªå›è°ƒå‡½æ•°ä¼šè¢«ç«‹å³æ‰§è¡Œï¼Œä½œç”¨æ˜¯åˆ¤æ–­çŠ¶æ€æ˜¯å¦åº”è¯¥è¿›è¡Œæ›´æ”¹
    cb(this.resolve, this.reject);
  }

  // ä¿®æ”¹å‚æ•°ï¼Œè®©resolveæ¥æ”¶æˆåŠŸåä¼ æ¥çš„å€¼
  resolve = (value) => {
    if (this.status != PENDING) {
      return;
    } else {
      this.status = FULFILLED;
      // å°†æˆåŠŸçš„å€¼èµ‹äºˆç»™value
      this.value = value;
    }
  };

  // ä¿®æ”¹å‚æ•°ï¼Œè®©rejectæ¥æ”¶å¤±è´¥åä¼ æ¥çš„åŸå› 
  reject = (reason) => {
    if (this.status != PENDING) {
      return;
    } else {
      this.status = REJECTED;
      // å°†å¤±è´¥çš„åŸå› èµ‹äºˆç»™reason
      this.reason = reason;
    }
  };

  /** thenè¦æ¥æ”¶ä¸¤ä¸ªå›è°ƒå‡½æ•°ï¼ŒsuccessCBè¿™ä¸ªå›è°ƒå‡½æ•°åœ¨çŠ¶æ€ä¸ºfulfilledæ—¶ä½¿ç”¨ï¼Œ
   * è€ŒfailCBè¿™ä¸ªå›è°ƒå‡½æ•°åœ¨çŠ¶æ€ä¸ºrejectedæ—¶è¿›è¡Œä½¿ç”¨
   */
  then(successCB, failCB) {
    if (this.status === FULFILLED) {
      successCB(this.value);
    } else if (this.status === REJECTED) {
      failCB(this.reason);
    }
  }
}

// æµ‹è¯•ç”¨ä¾‹
//æˆåŠŸçŠ¶æ€æµ‹è¯•
const successPromise = new PromiseMon((resolve, reject) => {
  resolve('successData');
  reject('failData');
});

console.log('æˆåŠŸçŠ¶æ€ï¼š', successPromise.status); // æˆåŠŸçŠ¶æ€ï¼šsuccessData

successPromise.then(
  (value) => {
    console.log('success:', value); // success:successData
  },
  (reason) => {
    console.log('error:', reason); // æ²¡æœ‰è¾“å‡º
  }
);

//å¤±è´¥çŠ¶æ€æµ‹è¯•
const failPromise = new PromiseMon((resolve, reject) => {
  reject('failData');
  resolve('successData');
});

console.log('å¤±è´¥çŠ¶æ€ï¼š', failPromise.status); // å¤±è´¥çŠ¶æ€ï¼šfailData

failPromise.then(
  (value) => {
    console.log('success:', value); // æ²¡æœ‰è¾“å‡º
  },
  (reason) => {
    console.log('error:', reason); // error:failData
  }
);
```

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å®ç°äº†ä¸€ä¸ªæœ€åŸºç¡€çš„ã€ä¸”åŒæ­¥æ‰§è¡Œçš„ `Promise` ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä¸ºè¿™ä¸ªåŒæ­¥çš„ `Promise` æ·»åŠ å¼‚æ­¥é€»è¾‘ã€‚

## 2. æ·»åŠ å¼‚æ­¥é€»è¾‘åŠŸèƒ½å®ç° ğŸ·ï¸

### ï¼ˆ1ï¼‰then ä¸­æ·»åŠ å¼‚æ­¥é€»è¾‘åŠŸèƒ½çš„åˆ†æ

ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬åœ¨ `promise` ä¸­è¢«è°ƒç”¨çš„å¤§éƒ¨åˆ†éƒ½æ˜¯å¼‚æ­¥å‡½æ•°ï¼Œæ¯”å¦‚ `setTimeout` ã€ `setInterval` ç­‰ç­‰ã€‚æ‰€ä»¥å‘¢ï¼Œæˆ‘ä»¬ç°åœ¨è¦åœ¨ `then` ä¸­æ·»åŠ å¼‚æ­¥çš„åŠŸèƒ½ï¼Œæ¥å®ç°å¯¹**å¼‚æ­¥é€»è¾‘**è¿›è¡Œæ“ä½œã€‚

åœ¨ä¸Šé¢çš„ `then` æ–¹æ³•ä¸­ï¼Œå¤§å®¶å®šä½åˆ° `ifâ€¦â€¦else ifâ€¦â€¦` éƒ¨åˆ†ï¼Œä¸Šé¢æ‰€å†™çš„é€»è¾‘åªæœ‰å¯¹çŠ¶æ€ä¸º `fulfilled` å’Œ `rejected` æ—¶æ‰è¿›è¡Œåˆ¤æ–­ï¼Œè€Œæ²¡æœ‰å¯¹çŠ¶æ€ä¸º `pending` æ—¶è¿›è¡Œåˆ¤æ–­ã€‚

æ‰€ä»¥ï¼Œå½“çŠ¶æ€ä¸º `pending` æ—¶ï¼Œæ„å‘³ç€ `PromiseMon` ä¸­çš„å¼‚æ­¥å‡½æ•°è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å°† `succesCB` å’Œ `failCB` è¿™ä¸¤ä¸ªå›è°ƒå‡½æ•°ç»™å…ˆå­˜åˆ°ä¸€ä¸ªå˜é‡ä¸­å»ï¼Œç­‰åˆ°åç»­å¼‚æ­¥å†…å®¹ç»“æŸåå†è¿›è¡Œè°ƒç”¨ã€‚

### ï¼ˆ2ï¼‰then ä¸­æ·»åŠ å¼‚æ­¥é€»è¾‘åŠŸèƒ½çš„å®ç°

ä¾æ®ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬æ¥å®ç°è¿™ä¸ªå¼‚æ­¥åŠŸèƒ½ã€‚**å…·ä½“ä»£ç å¦‚ä¸‹ï¼š**

```js
/**
 * 04_æ·»åŠ å¼‚æ­¥é€»è¾‘åŠŸèƒ½çš„å®ç°
 */

const PENDING = 'pending';
const FULFILLED = 'fulfilled';
const REJECTED = 'rejected';

class PromiseMon {
  status = PENDING;
  value = undefined;
  reason = undefined;
  // å®šä¹‰ä¸¤ä¸ªå˜é‡ï¼Œæ¥å­˜æ”¾æˆåŠŸå’Œå¤±è´¥æ—¶çš„å›è°ƒå‡½æ•°
  successCB = undefined;
  failCB = undefined;

  constructor(cb) {
    cb(this.resolve, this.reject);
  }

  resolve = (value) => {
    if (this.status != PENDING) {
      return;
    } else {
      this.status = FULFILLED;
      this.value = value;
      /**
       * è¡¨è¾¾å¼a && è¡¨è¾¾å¼bï¼š
       * è®¡ç®—è¡¨è¾¾å¼açš„è¿ç®—ç»“æœï¼Œ
       * å¦‚æœä¸ºtrueï¼Œæ‰§è¡Œè¡¨è¾¾å¼bï¼Œå¹¶è¿”å›bçš„ç»“æœï¼›
       * å¦‚æœä¸ºfalseï¼Œè¿”å›açš„ç»“æœã€‚
       */
      /**
       * å½“successCBé‡Œé¢æœ‰å­˜æ”¾æˆåŠŸçš„å›è°ƒå‡½æ•°æ—¶ï¼Œåˆ™è¡¨æ˜this.successCBä¸ºtrueï¼Œ
       * ç»§ç»­åˆ¤æ–­æ–°ä¼ æ¥çš„å€¼çš„çŠ¶æ€æ˜¯å¦ä¸ºæˆåŠŸçŠ¶æ€çš„å€¼ï¼Œ
       * å¦‚æœæ˜¯ï¼Œåˆ™å°†æ–°çš„å€¼ä¼ ç»™this.successCBå›è°ƒå‡½æ•°ï¼Œ
       * å¦‚æœå¦ï¼Œåˆ™è¿”å›åŸæ¥å­˜æ”¾ç€çš„this.successçš„ç»“æœ
       */
      this.successCB && this.successCB(this.value);
    }
  };

  reject = (reason) => {
    if (this.status != PENDING) {
      return;
    } else {
      this.status = REJECTED;
      this.reason = reason;
      // å­˜æ”¾è°ƒç”¨å¤±è´¥çš„å›è°ƒå‡½æ•°
      this.failCB && this.failCB(this.reason);
    }
  };

  /** thenè¦æ¥æ”¶ä¸¤ä¸ªå›è°ƒå‡½æ•°ï¼ŒsuccessCBè¿™ä¸ªå›è°ƒå‡½æ•°åœ¨çŠ¶æ€ä¸ºfulfilledæ—¶ä½¿ç”¨ï¼Œ
   * è€ŒfailCBè¿™ä¸ªå›è°ƒå‡½æ•°åœ¨çŠ¶æ€ä¸ºrejectedæ—¶è¿›è¡Œä½¿ç”¨
   */
  then(successCB, failCB) {
    if (this.status === FULFILLED) {
      successCB(this.value);
    } else if (this.status === REJECTED) {
      failCB(this.reason);
    }
    // å½“å‡½æ•°è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæ¯•æ—¶ï¼Œåªèƒ½ç­‰å¾…
    else {
      // å°†ä¸¤ä¸ªå›è°ƒå‡½æ•°çš„å€¼å­˜æ”¾èµ·æ¥
      this.successCB = successCB;
      this.failCB = failCB;
    }
  }
}

// æµ‹è¯•ç”¨ä¾‹
// æµ‹è¯•å¼‚æ­¥æˆåŠŸçŠ¶æ€
const asyncPromise1 = new PromiseMon((resolve, reject) => {
  setTimeout(() => {
    resolve('asyncSuccessData');
  }, 2000);
});

asyncPromise1.then(
  (value) => {
    console.log('å¼‚æ­¥æˆåŠŸçŠ¶æ€ï¼š', value);
  },
  (reason) => {
    console.log('å¼‚æ­¥å¤±è´¥çŠ¶æ€:', reason);
  }
);

// æµ‹è¯•å¼‚æ­¥å¤±è´¥çŠ¶æ€
const asyncPromise2 = new PromiseMon((resolve, reject) => {
  setTimeout(() => {
    reject('asyncErrorData');
  }, 1000);
});

asyncPromise2.then(
  (value) => {
    console.log('å¼‚æ­¥æˆåŠŸçŠ¶æ€ï¼š', value);
  },
  (reason) => {
    console.log('å¼‚æ­¥å¤±è´¥çŠ¶æ€:', reason);
  }
);

/**
 * æ‰“å°ç»“æœï¼š
 * å¼‚æ­¥å¤±è´¥çŠ¶æ€: asyncErrorData
 * å¼‚æ­¥æˆåŠŸçŠ¶æ€ï¼š asyncSuccessData
 */
```

åˆ°è¿™é‡Œï¼Œå¼‚æ­¥çš„åŠŸèƒ½æˆ‘ä»¬ä¹Ÿå°±å®ç°å•¦ï¼ä½†æ˜¯ä¸Šé¢çš„ `then` æˆ‘ä»¬è¿˜åªæ˜¯å®ç° `then` æ–¹æ³•çš„ä¸€æ¬¡è°ƒç”¨ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥å®ç° `then` æ–¹æ³•çš„å¤šæ¬¡è°ƒç”¨ã€‚

## 3. å®ç° then æ–¹æ³•çš„å¤šæ¬¡è°ƒç”¨ ğŸ·ï¸

### ï¼ˆ1ï¼‰å¤šæ¬¡è°ƒç”¨ then æ–¹æ³•çš„åŠŸèƒ½åˆ†æ

å¤šæ¬¡è°ƒç”¨ `then` æ–¹æ³•åˆ†ä¸º**ä¸¤ç§æƒ…å†µï¼š**

- åŒæ­¥è°ƒç”¨ `then` æ–¹æ³•ã€‚åŒæ­¥è°ƒç”¨ `then` æ–¹æ³•ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œåªè¦ç›´æ¥è°ƒç”¨ `successCB` æˆ– `failCB` å›è°ƒå‡½æ•°å³å¯ã€‚
- å¼‚æ­¥è°ƒç”¨ `then` æ–¹æ³•ã€‚ä¹‹å‰çš„å±æ€§ `successCB` å’Œ `failCB` ä¸¤ä¸ªå›è°ƒå‡½æ•°æ˜¯å­˜æ”¾ä¸ºå¯¹è±¡å½¢å¼ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å…ˆä¼˜åŒ–æˆ‘ä»¬çš„å­˜å‚¨å½¢å¼ã€‚ä¼˜åŒ–å®Œæˆä¹‹åï¼Œå°†æ‰€æœ‰çš„å›è°ƒå‡½æ•°å…¨éƒ¨å­˜æ”¾åœ¨ä¸€èµ·ï¼Œç­‰åˆ°æ‰§è¡Œå®Œæ¯•ä¹‹åå†ä¾æ¬¡è°ƒç”¨ã€‚

### ï¼ˆ2ï¼‰å¤šæ¬¡è°ƒç”¨ then æ–¹æ³•çš„åŠŸèƒ½å®ç°

ä¾æ®ä¸Šè¿°çš„åˆ†æï¼Œæˆ‘ä»¬æ¥å®ç°å¤šæ¬¡è°ƒç”¨ `then` æ–¹æ³•çš„åŠŸèƒ½ã€‚**å…·ä½“ä»£ç å¦‚ä¸‹ï¼š**

```js
/**
 * 05_å¤šæ¬¡è°ƒç”¨thenæ–¹æ³•åŠŸèƒ½çš„å®ç°
 */

const PENDING = 'pending';
const FULFILLED = 'fulfilled';
const REJECTED = 'rejected';

class PromiseMon {
  status = PENDING;
  value = undefined;
  reason = undefined;
  // å®šä¹‰ä¸¤ä¸ªæ•°ç»„å˜é‡ï¼Œæ¥å„è‡ªå­˜æ”¾æˆåŠŸå’Œå¤±è´¥æ—¶çš„æ‰€æœ‰å›è°ƒå‡½æ•°
  successCB = [];
  failCB = [];

  constructor(cb) {
    cb(this.resolve, this.reject);
  }

  resolve = (value) => {
    if (this.status != PENDING) {
      return;
    } else {
      this.status = FULFILLED;
      this.value = value;
      // ä½¿ç”¨ shift()æ–¹æ³•ï¼Œæ¥å¼¹å‡ºå¹¶è¿”å›ç¬¬ä¸€ä¸ªå…ƒç´ 
      while (this.successCB.length) {
        this.successCB.shift()(this.value);
      }
    }
  };

  reject = (reason) => {
    if (this.status != PENDING) {
      return;
    } else {
      this.status = REJECTED;
      this.reason = reason;
      // ä½¿ç”¨ shift()æ–¹æ³•ï¼Œæ¥å¼¹å‡ºå¹¶è¿”å›ç¬¬ä¸€ä¸ªå…ƒç´ 
      while (this.failCB.length) {
        this.failCB.shift()(this.reason);
      }
    }
  };

  then(successCB, failCB) {
    if (this.status === FULFILLED) {
      successCB(this.value);
    } else if (this.status === REJECTED) {
      failCB(this.reason);
    } else {
      // é€šè¿‡pushæ–¹æ³•å°†å›è°ƒå‡½æ•°çš„å€¼å­˜æ”¾åˆ°æ•°ç»„ä¸­
      this.successCB.push(successCB);
      this.failCB.push(failCB);
    }
  }
}

// æµ‹è¯•ç”¨ä¾‹
const multiplePromise1 = new PromiseMon((resolve, reject) => {
  setTimeout(() => {
    resolve('multiSuccessData');
  }, 2000);
});
multiplePromise1.then((value) => {
  console.log('ç¬¬ä¸€æ¬¡è°ƒç”¨æˆåŠŸï¼š', value); // ç¬¬ä¸€æ¬¡è°ƒç”¨æˆåŠŸï¼š multiSuccessData
});
multiplePromise1.then((value) => {
  console.log('ç¬¬äºŒæ¬¡è°ƒç”¨æˆåŠŸï¼š', value); // ç¬¬äºŒæ¬¡è°ƒç”¨æˆåŠŸï¼š multiSuccessData
});

/**
 * æ‰“å°ç»“æœï¼š
 * ç¬¬ä¸€æ¬¡è°ƒç”¨æˆåŠŸï¼š multiSuccessData
 * ç¬¬äºŒæ¬¡è°ƒç”¨æˆåŠŸï¼š multiSuccessData
 */
```

è®²åˆ°è¿™é‡Œï¼Œå…³äºå¯¹æ­¤è°ƒç”¨ `then` æ–¹æ³•çš„åŠŸèƒ½å°±å®ç°å®Œæˆäº†ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬ç»§ç»­æ¥å®ç°å…³äº `then` æ–¹æ³•çš„é“¾å¼è°ƒç”¨ã€‚

## 4. å®ç° then æ–¹æ³•çš„é“¾å¼è°ƒç”¨ ğŸ·ï¸

### ï¼ˆ1ï¼‰then æ–¹æ³•é“¾å¼è°ƒç”¨çš„åŠŸèƒ½åˆ†æ

æˆ‘ä»¬å…ˆæ¥å¯¹ `then` æ–¹æ³•çš„é“¾å¼è°ƒç”¨è¿›è¡Œ**åŠŸèƒ½åˆ†æ**ï¼Œ**å…·ä½“å¦‚ä¸‹ï¼š**

- ä¸è€ƒè™‘å…¶ä»–åŠŸèƒ½çš„å‰æä¸‹ï¼Œå…ˆå®Œæˆ**é“¾å¼è°ƒç”¨çš„åµŒå¥—**ï¼›
- å®ç°é“¾å¼è°ƒç”¨çš„**å¤§å‰æ**æ˜¯ï¼Œæ¯ä¸€ä¸ª `then` å‡½æ•°è¿”å›çš„éƒ½å¿…é¡»æ˜¯ä¸€ä¸ª `Promise` å¯¹è±¡ï¼Œå¦åˆ™å°±æ— æ³•è¡”æ¥åœ°å»ä½¿ç”¨ `then` å‡½æ•°ã€‚
- å› æ­¤ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦åœ¨ `then` å‡½æ•°ä¸­æ–°å»ºä¸€ä¸ª `Promise` å¯¹è±¡ï¼Œä¹‹åå‘¢ï¼Œåœ¨æ–°å»ºçš„ `promise` å¯¹è±¡é‡Œé¢ï¼Œå»å¤„ç†å†…éƒ¨ä½¿ç”¨çš„ `resolve` å’Œ `reject` æ‰€è¿”å›çš„å€¼ï¼Œæœ€ç»ˆ `then` å‡½æ•°ä¹Ÿå°±è¿”å›äº† `promise` å¯¹è±¡ã€‚

### ï¼ˆ2ï¼‰then æ–¹æ³•é“¾å¼è°ƒç”¨çš„åŠŸèƒ½å®ç°

ä¾æ®ä¸Šé¢çš„åŠŸèƒ½åˆ†æï¼Œæˆ‘ä»¬æ¥å®ç° `then` çš„é“¾å¼è°ƒç”¨åŠŸèƒ½ã€‚**å…·ä½“ä»£ç å¦‚ä¸‹ï¼š**

```js
/**
 * 06_thençš„é“¾å¼è°ƒç”¨åŠŸèƒ½çš„å®ç°
 */

const PENDING = 'pending';
const FULFILLED = 'fulfilled';
const REJECTED = 'rejected';

class PromiseMon {
  status = PENDING;
  value = undefined;
  reason = undefined;
  // å®šä¹‰ä¸¤ä¸ªæ•°ç»„å˜é‡ï¼Œæ¥å„è‡ªå­˜æ”¾æˆåŠŸå’Œå¤±è´¥æ—¶çš„æ‰€æœ‰å›è°ƒå‡½æ•°
  successCB = [];
  failCB = [];

  constructor(cb) {
    cb(this.resolve, this.reject);
  }

  resolve = (value) => {
    if (this.status != PENDING) {
      return;
    } else {
      this.status = FULFILLED;
      this.value = value;
      while (this.successCB.length) {
        this.successCB.shift()(this.value);
      }
    }
  };

  reject = (reason) => {
    if (this.status != PENDING) {
      return;
    } else {
      this.status = REJECTED;
      this.reason = reason;
      while (this.failCB.length) {
        this.failCB.shift()(this.reason);
      }
    }
  };

  then(successCB, failCB) {
    //
    /**
     * æ–°å»ºä¸€ä¸ªpromiseå¯¹è±¡ï¼Œæ¥ç»™ä¸‹ä¸€ä¸ªthenä½¿ç”¨ã€‚
     * ä¸‰ç§çŠ¶æ€ï¼š
     * â‘ promiseå¯¹è±¡æ‰§è¡ŒæˆåŠŸï¼Œè°ƒç”¨resolveï¼›
     * â‘¡promiseå¯¹è±¡æ‰§è¡Œå¤±è´¥ï¼Œåˆ™è°ƒç”¨rejectï¼›
     * â‘¢promiseå¯¹è±¡è¿˜æœªæ‰§è¡Œï¼Œå°†å›è°ƒå‡½æ•°æ¨å…¥å‡†å¤‡å¥½çš„æ•°ç»„ä¸­ã€‚
     */
    const thenablePromise = new PromiseMon((resolve, reject) => {
      if (this.status === FULFILLED) {
        const thenableValue = successCB(this.value);
        // åˆ¤æ–­è¿”å›çš„å€¼æ˜¯å¦æ˜¯promiseå¯¹è±¡
        resolvePromise(thenableValue, resolve, reject);
      } else if (this.status === REJECTED) {
        const thenableReason = failCB(this.reason);
        // åˆ¤æ–­è¿”å›çš„å€¼æ˜¯å¦æ˜¯promiseå¯¹è±¡
        resolvePromise(thenableReason, resolve, reject);
      } else {
        // é€šè¿‡ç®­å¤´å‡½æ•°çš„æ–¹å¼å°†å›è°ƒå‡½æ•°çš„å€¼å­˜æ”¾è¿›æ•°ç»„ä¸­
        this.successCB.push(() => {
          const thenableValue = successCB(this.value);
          resolvePromise(thenableValue, resolve, reject);
        });
        this.failCB.push(() => {
          const thenableReason = failCB(this.reason);
          resolvePromise(thenableReason, resolve, reject);
        });
      }
    });
    return thenablePromise;
  }
}

/**
 * åˆ¤æ–­ä¼ è¿›æ¥çš„thenablePromiseæ˜¯å¦æ˜¯promiseå¯¹è±¡ï¼Œ
 * å¦‚æœæ˜¯ï¼Œåˆ™è°ƒç”¨thenå‡½æ•°æ¥å¤„ç†ï¼›å¦‚æœå¦ï¼Œåˆ™ç›´æ¥è¿”å›å€¼ã€‚
 */
const resolvePromise = (thenablePromise, resolve, reject) => {
  // åˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªpromiseå¯¹è±¡
  if (thenablePromise instanceof PromiseMon) {
    thenablePromise.then(resolve, reject);
  } else {
    // å¦‚æœä¸æ˜¯promiseå¯¹è±¡ï¼Œåˆ™ç›´æ¥è¿”å›å€¼
    resolve(thenablePromise);
  }
};

// æµ‹è¯•ç”¨ä¾‹
// æµ‹è¯•é“¾å¼è°ƒç”¨æˆåŠŸçŠ¶æ€
const thenablePromise = new PromiseMon((resolve, reject) => {
  resolve('thenableSuccessData');
});

const otherPromise = () => {
  return new PromiseMon((resolve, reject) => {
    setTimeout(() => {
      resolve('otherPromise');
    }, 2000);
  });
};

const anotherPromise = () => {
  return new PromiseMon((resolve, reject) => {
    setTimeout(() => {
      resolve('anotherPromise');
    });
  });
};

thenablePromise
  .then((value) => {
    console.log('ç¬¬ä¸€æ¬¡é“¾å¼è°ƒç”¨æˆåŠŸï¼š', value, new Date()); // ç¬¬ä¸€æ¬¡è°ƒç”¨æˆåŠŸï¼š thenableSuccessData
    // returnçš„ç»“æœæ˜¯ä¸ºäº†ç»™ä¸‹ä¸€ä¸ªthenä½¿ç”¨
    return otherPromise();
  })
  .then((value) => {
    console.log('ç¬¬äºŒæ¬¡é“¾å¼è°ƒç”¨æˆåŠŸï¼š', value, new Date()); // ç¬¬äºŒæ¬¡è°ƒç”¨æˆåŠŸï¼š otherPromise
    return anotherPromise();
  })
  .then((value) => {
    console.log('ç¬¬ä¸‰æ¬¡é“¾å¼è°ƒç”¨æˆåŠŸï¼š', value, new Date()); // ç¬¬ä¸‰æ¬¡è°ƒç”¨æˆåŠŸï¼š anotherPromise
  });

/**
 * æ‰“å°ç»“æœï¼š
 * ç¬¬ä¸€æ¬¡é“¾å¼è°ƒç”¨æˆåŠŸï¼š thenableSuccessData 2021-08-04T11:13:25.868Z
 * ç¬¬äºŒæ¬¡é“¾å¼è°ƒç”¨æˆåŠŸï¼š otherPromise 2021-08-04T11:13:25.877Z
 * ç¬¬ä¸‰æ¬¡é“¾å¼è°ƒç”¨æˆåŠŸï¼š anotherPromise 2021-08-04T11:13:25.878Z
 */
```

è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®Œæˆäº† `promise` çš„é“¾å¼è°ƒç”¨ã€‚

### ï¼ˆ3ï¼‰é“¾å¼è°ƒç”¨çš„è‡ªæˆ‘æ£€æµ‹

æœ‰æ—¶å€™æˆ‘ä»¬æœ‰å¯èƒ½åœ¨è°ƒç”¨ `promise` æ—¶ï¼Œä¼šé™·å…¥è‡ªæˆ‘è°ƒç”¨çš„å¢ƒåœ°ã€‚ä¹Ÿå°±æ˜¯**æ— é™çš„å¾ªç¯åµŒå¥—**å’Œ**æ— é™çš„è‡ªæˆ‘è°ƒç”¨**ã€‚**æ¯”å¦‚ä¸‹é¢è¿™ç§æƒ…å†µï¼š**

```js
const promise1 = new Promise((resolve, reject) => {
  resolve('success');
});

// æ— é™å¾ªç¯åµŒå¥—ï¼Œæ— é™è‡ªæˆ‘è°ƒç”¨
// å½“è¿è¡Œæ—¶æ§åˆ¶å°ä¼šæŠ›å‡ºå¼‚å¸¸
const promise2 = promise1.then((val) => {
  return promise2;
});

// æ‰“å°ç»“æœï¼š
//  TypeError: Chaining cycle detected for promise #<Promise>
```

å› æ­¤ï¼Œç°åœ¨æˆ‘ä»¬è¦åšçš„æ˜¯ï¼Œåœ¨ `resolvePromise` å‡½æ•°ä¸­**æ–°å¢ä¸€ä¸ªå‚æ•°**ï¼Œè¿™ä¸ªå‚æ•°å°±æ˜¯å½“å‰æ‰€åˆ›é€ çš„ `promise` å¯¹è±¡ã€‚ä¹‹ååˆ¤æ–­ä¸¤ä¸ª `promise` å¯¹è±¡æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰ï¼Œé‚£ä¹ˆå°±æŠ›å‡ºå¼‚å¸¸ã€‚ä¾æ®è¿™ä¸ªé€»è¾‘ï¼Œæˆ‘ä»¬æ¥ä¿®æ”¹ä¸Šé¢é“¾å¼è°ƒç”¨çš„åŠŸèƒ½ä»£ç ï¼Œè¾¾åˆ°ç¦æ­¢è‡ªæˆ‘è°ƒç”¨çš„é—­ç¯ã€‚**å…·ä½“ä»£ç å¦‚ä¸‹ï¼š**

```js
/**
 * 07_é“¾å¼è°ƒç”¨çš„è‡ªæˆ‘æ£€æµ‹
 */

const PENDING = 'pending';
const FULFILLED = 'fulfilled';
const REJECTED = 'rejected';

class PromiseMon {
  status = PENDING;
  value = undefined;
  reason = undefined;
  successCB = [];
  failCB = [];

  //æ­¤å¤„çœç•¥constructorä»£ç 
  //æ­¤å¤„çœç•¥resolveä»£ç 
  //æ­¤å¤„çœç•¥rejectä»£ç 

  then(successCB, failCB) {
      const thenablePromise = new PromiseMon((resolve, reject) => {
        /**
         * åˆ©ç”¨setTimeoutæ˜¯å¼‚æ­¥å‡½æ•°çš„ç‰¹æ€§ï¼Œ
         * è¿™æ ·setTimeouté‡Œé¢çš„å†…å®¹ä¼šåœ¨åŒæ­¥å‡½æ•°æ‰§è¡Œå®Œä¹‹åæ‰ä¼šè¿›è¡Œï¼Œ
         * æ‰€ä»¥ï¼Œå½“resolvePromiseåœ¨æ‰§è¡Œçš„æ—¶å€™ï¼ŒthenablePromiseå°±å·²ç»è¢«å®ä¾‹åŒ–äº†ï¼Œ
         * ä½¿å¾—resolvePromiseé¡ºåˆ©çš„è°ƒç”¨thenablePromise
         */
          if(this.status === FULFILLED) {
            setTimeout(() => {
              const thenableValue = successCB(this.value);
              resolvePromise(thenablePromise, thenableValue, resolve, reject);
            }, 0);
          }else if(this.status === REJECTED) {
            setTimeout(() => {
              const thenableReason = failCB(this.reason);
              resolvePromise(thenablePromise, thenableReason, resolve, reject);
            }, 0);
          }else {
            this.successCB.push(() => {
              setTimeout(() => {
                const thenableValue = successCB(this.value);
                resolvePromise(thenablePromise, thenableValue, resolve, reject);
              }, 0);
            });
            this.failCB.push(() => {
              setTimeout(() => {
                const thenableReason = failCB(this.reason);
                resolvePromise(thenablePromise, thenableReason, resolve, reject);
              }, 0);
            });
          }
      });
      return thenablePromise;
  }

const resolvePromise = (createPromise, thenablePromise, resolve, reject) => {
  if(createPromise === thenablePromise) {
    return reject(new TypeError('å‡ºç°å¾ªç¯è°ƒç”¨çš„æƒ…å†µ Chaning cycle detected'))
  }else if(thenablePromise instanceof PromiseMon) {
      thenablePromise.then(resolve, reject);
  } else {
      resolve(thenablePromise);
  }
}

// æµ‹è¯•ç”¨ä¾‹
// æµ‹è¯•è‡ªæˆ‘è°ƒç”¨
const thenablePromise = new PromiseMon((resolve, reject) => {
  resolve('chainningData');
});

const chainingPromise = thenablePromise.then((value) => {
  console.log('æ•°æ®è°ƒç”¨æˆåŠŸ', value, new Date());
  return chainingPromise;
})
//ä¼šæŠ¥é”™ï¼Œå‡ºç°å¾ªç¯è°ƒç”¨
chainingPromise
  .then(
    (value) => {
      console.log('æ‰§è¡Œæ“ä½œæˆåŠŸ', value, new Date());
    },
    (reason) => {
      console.log('æ‰§è¡Œæ“ä½œå¤±è´¥', reason, new Date());
    }
);

/*
æ‰“å°ç»“æœï¼š
æ•°æ®è°ƒç”¨æˆåŠŸ chainningData 2021-08-04T11:28:39.984Z
æ‰§è¡Œæ“ä½œå¤±è´¥ TypeError: å‡ºç°å¾ªç¯è°ƒç”¨çš„æƒ…å†µ Chaning cycle detected
*/
```

è‡³æ­¤ï¼Œæˆ‘ä»¬å®Œæˆäº†é“¾å¼è°ƒç”¨çš„è‡ªæˆ‘æ£€æµ‹ã€‚

## 5. promise çš„é”™è¯¯å¤„ç† ğŸ·ï¸

### ï¼ˆ1ï¼‰é”™è¯¯å¤„ç†åœºæ™¯

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¯¹ `pormise` çš„ `then` æ–¹æ³•åŸºæœ¬å®ç°çš„å·®ä¸å¤šã€‚ä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªå¾ˆé‡è¦ä½†æ˜¯åˆå¾ˆå®¹æ˜“è¢«æˆ‘ä»¬ç–å¿½çš„é—®é¢˜å°±æ˜¯ï¼Œ**é”™è¯¯å¤„ç†**ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹å¯èƒ½**ä¼šå‡ºç°å¼‚å¸¸çš„å¸¸è§åœºæ™¯ï¼š**

- æ„é€ å™¨ä¸­çš„å›è°ƒå‡½æ•° `cb` ï¼Œéœ€è¿›è¡Œ `try/catch` å¤„ç†ï¼›
- `then` å‡½æ•°ä¸­çš„é”™è¯¯å¤„ç†ï¼Œéœ€è¦å¯¹**åŒæ­¥å‡½æ•°å’Œå¼‚æ­¥å‡½æ•°**è¿›è¡Œ `try/catch` å¤„ç†ã€‚

### ï¼ˆ2ï¼‰é”™è¯¯å¤„ç†åŠŸèƒ½å®ç°

ä¾æ®ä¸Šé¢çš„åœºæ™¯åˆ†æï¼Œæˆ‘ä»¬æ¥å®ç° `promise` çš„é”™è¯¯å¤„ç†åŠŸèƒ½ã€‚**å…·ä½“ä»£ç å¦‚ä¸‹ï¼š**

```js
/**
 * 08_promiseçš„é”™è¯¯å¤„ç†
 */

const PENDING = 'pending';
const FULFILLED = 'fulfilled';
const REJECTED = 'rejected';

class PromiseMon {
  status = PENDING;
  value = undefined;
  reason = undefined;
  successCB = [];
  failCB = [];

  constructor(cb) {
    try {
        cb(this.resolve, this.reject);
    } catch (err) {
        this.reject('err in cb');
    }
  }

  //æ­¤å¤„çœç•¥resolveä»£ç 
  //æ­¤å¤„çœç•¥rejectä»£ç 

  then(successCB, failCB) {
      const thenablePromise = new PromiseMon((resolve, reject) => {
        //   ç»™setTimeoutè¿™ä¸ªå¼‚æ­¥å‡½æ•°æ·»åŠ try/catch
          if(this.status === FULFILLED) {
            setTimeout(() => {
              try {
                const thenableValue = successCB(this.value);
                resolvePromise(thenablePromise, thenableValue, resolve, reject);
              } catch (err) {
                  reject(err);
              }
            }, 0);
          }else if(this.status === REJECTED) {
            setTimeout(() => {
              try {
                const thenableReason = failCB(this.reason);
                resolvePromise(thenablePromise, thenableReason, resolve, reject);
              } catch (err) {
                  reject(err);
              }
            }, 0);
          }else {
              // resolvePromise åŒæ—¶è¦åŠ åˆ°successCBå’ŒfailCBä¸­è¿›è¡Œå¤„ç†
              this.successCB.push(() => {
                  setTimeout(() => {
                      try {
                        const thenableValue = successCB(this.value);
                        resolvePromise(thenablePromise, thenableValue, resolve, reject);
                      } catch (err) {
                          reject(err);
                      }
                  }, 0);
              });
              this.failCB.push(() => {
                  setTimeout(() => {
                    try {
                        const thenableReason = failCB(this.reason);
                        resolvePromise(thenablePromise, thenableReason, resolve, reject);
                    } catch (err) {
                        reject(err);
                    }
                  }, 0);
              });
          }
      });
      return thenablePromise;
  }

  // æ­¤å¤„çœç•¥resolvePromiseä»£ç 

// æµ‹è¯•ç”¨ä¾‹
const promise = new PromiseMon((resolve, reject) => {
    setTimeout(() => {
        resolve('successData');
    });
});

promise
    .then(
        (value) => {
            console.log(value); // (1) æ‰“å° 'successData'
            throw new Error('error'); // (2) æŠ›å‡ºå¼‚å¸¸
        },
        (reason) => {
            console.log(reason);
            return 'fail in then';
        }
    )
    .then(
        (value) => {
            console.log(value);
        },
        (reason) => {
            console.log(reason);
            return 'callback fail'; // æŠ›å‡ºå¼‚å¸¸åè¿”å› 'callback fail' ç»™ä¸‹é¢çš„thenæ–¹é¢è°ƒç”¨
        }
    )
    .then(
        (value) => {
            console.log(value);
        },
        (reason) => {
            console.log(reason); // (3)ä¸Šé¢ä¼ æ¥callback failï¼Œå› æ­¤æ‰“å° 'callback fail'
        }
    );

/*
æ‰“å°ç»“æœï¼š
successData
Error: error
callback fail
*/
```

å¤§å®¶å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡ `try/catch` çš„æ–¹å¼ï¼Œå¯¹é‡åˆ°çš„é”™è¯¯è¿›è¡Œå¤„ç†ï¼Œå¹¶ä¸”æœ€ç»ˆæŠ›å‡ºå¼‚å¸¸ä»¥åŠè¿”å› `reason` çš„å€¼ã€‚

## 6. å®ç° then æ–¹æ³•çš„å‚æ•°å¯é€‰ ğŸ·ï¸

### ï¼ˆ1ï¼‰å‚æ•°å¯é€‰å®ç°æ€è·¯

å¤§å®¶å¯ä»¥å‘ç°ï¼Œä¸Šé¢æˆ‘ä»¬åœ¨è°ƒç”¨ `then` æ–¹æ³•çš„æ—¶å€™ï¼Œä¸€ç›´éƒ½æ˜¯éœ€è¦è¿›è¡Œå‚æ•°ä¼ é€’çš„ï¼Œè¿™æ ·çœ‹èµ·æ¥å¥½åƒè¿˜ä¸æ˜¯ç‰¹åˆ«å‹å¥½ã€‚å› æ­¤å‘¢ï¼Œæˆ‘ä»¬ç°åœ¨æ¥å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œè®© `then` æ–¹æ³•çš„å‚æ•°å¯ä»¥æœ‰**ä¼ æˆ–è€…ä¸ä¼ **è¿™ `2` ç§æ“ä½œã€‚å®ç°æ€è·¯ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯åœ¨ `then` å‡½æ•°ä¸­åˆ¤æ–­æ˜¯å¦ä¼ å…¥å‚æ•°ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œåˆ™è¿”å›åŸæ¥çš„ `value` å°±å¥½äº†ã€‚**ç±»ä¼¼äºä¸‹é¢è¿™ç§å½¢å¼ï¼š**

```js
promise
  .then((val) => val) // è¿™æ ·ä½¿ç”¨ç®­å¤´å‡½æ•°è¡¨æ˜ç›´æ¥è¿”å› value
  .then((val) => val)
  .then((val) => val)
  .then((val) => {
    console.log(val); // 200
  });
```

### ï¼ˆ2ï¼‰å‚æ•°å¯é€‰åŠŸèƒ½å®ç°

ä¾æ®ä¸Šé¢çš„æ˜¯å®ç°æ€è·¯ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚**å…·ä½“ä»£ç å¦‚ä¸‹ï¼š**

ä¸‹é¢æˆ‘ä»¬å¯¹ `then` å‡½æ•°è¿›è¡Œæ”¹é€ ï¼š

```js
then(successCB, failCB) {
    successCB = successCB ? successCB : (value) => value;
    failCB = failCB ? failCB : (reason) => {
        throw reason;
    };
}
```

æ¥ç”¨ä¸¤ç»„æµ‹è¯•ç”¨ä¾‹è¿›è¡Œæµ‹è¯•ï¼š

```js
// æµ‹è¯•ç”¨ä¾‹
// æˆåŠŸçŠ¶æ€ä¸‹çš„ç”¨ä¾‹
const successpromise = new PromiseMon((resolve, reject) => {
  resolve(100);
});

successpromise
  .then()
  .then()
  .then()
  .then((val) => {
    console.log(val); // 100
  });

// å¤±è´¥çŠ¶æ€ä¸‹çš„ç”¨ä¾‹
const failPromise = new PromiseMon((resolve, reject) => {
  reject(200);
});

failPromise
  .then()
  .then()
  .then()
  .then(
    (val) => {},
    (reason) => {
      console.log(reason); // 200
    }
  );
/**
 * æ‰“å°ç»“æœï¼š
 * 100
 * 200
 */
```

å¤§å®¶å¯ä»¥çœ‹åˆ°ï¼Œä¸ç®¡æ˜¯ `resolve` è¿˜æ˜¯ `reject` çŠ¶æ€ï¼Œéƒ½ä¸€ä¸€å®Œæˆäº†å¯¹**å‚æ•°å¯é€‰åŠŸèƒ½**çš„å®ç°ã€‚

## 7. å®ç° Promise.allğŸ·ï¸

### ï¼ˆ1ï¼‰Promise.all åŠŸèƒ½åˆ†æ

ä¸Šé¢åœ¨è®² `Promise` å¼‚æ­¥æ–¹æ¡ˆçš„æ—¶å€™å°±å·²ç»è®²è¿‡ `promise.all` å’Œ `promise.race` æ–¹æ³•ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬æ¥æ¢³ç†ä¸‹**å®ç°æ€è·¯ï¼š**

- `Promise.all` æ˜¯ä¸€ä¸ª**é™æ€æ–¹æ³•**ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ª **Promise æ•°ç»„** ä½œä¸ºå‚æ•°ã€‚
- `Promise.all` çš„ç‰¹ç‚¹åœ¨äºï¼Œå®ƒå¯ä»¥**æŒ‰ç…§é¡ºåº**å»è·å–æ‰€æœ‰è°ƒç”¨çš„å¼‚æ­¥å‡½æ•°ã€‚
- `js` çš„**å…³é”®å­— `static`** å°†ä¼šæŠŠå¯¹åº”çš„**å˜é‡æˆ–å‡½æ•°**ç»‘å®šåˆ°**class ç±»**ä¸Šï¼Œè€Œä¸æ˜¯ç»‘å®šåœ¨ ** `prototype` åŸå‹**ä¸Šã€‚

### ï¼ˆ2ï¼‰Promise.all åŠŸèƒ½å®ç°

ä¾æ®å®ç°çš„è¿™ä¸ªé€»è¾‘ï¼Œæ¥å®ç° `promise.all` è¿™ä¸ªåŠŸèƒ½ã€‚**å…·ä½“ä»£ç å¦‚ä¸‹ï¼š**

```js
/**
 * 10_promise.allåŠŸèƒ½çš„å®ç°
 */

const PENDING = 'pending';
const FULFILLED = 'fulfilled';
const REJECTED = 'rejected';

class PromiseMon {
  status = PENDING;
  value = undefined;
  reason = undefined;
  successCB = [];
  failCB = [];

  //çœç•¥constructorã€resolveã€rejectå’Œthenæ–¹æ³•çš„ä»£ç 

  static all(arr) {
    const results = [];
    let index = 0;

    return new PromiseMon((resolve, reject) => {
      // æ·»åŠ æ•°æ®çš„é€»è¾‘ï¼ŒæŠŠæŒ‡å®šçš„æ•°æ®æ·»åŠ åˆ°æ•°ç»„çš„å¯¹åº”ä½ç½®ä¸Š
      const addData = (idx, val) => {
        results[idx] = val;
        index++;
        // è¿›è¡Œè¿™ä¸€æ­¥åˆ¤æ–­çš„ç›®çš„ï¼šä¸ºäº†ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆ
        if (index === arr.length) {
          resolve(results);
        }
      };

      // å¯¹æ•°ç»„è¿›è¡Œå¾ªç¯ï¼Œè·å–æ‰€æœ‰çš„æ•°æ®
      arr.forEach((cur, index) => {
        // å¦‚æœä¼ è¿›æ¥çš„å€¼æ˜¯ä¸€ä¸ªpromiseå¯¹è±¡
        if (cur instanceof PromiseMon) {
          cur.then(
            (value) => addData(index, value),
            (reason) => reject(reason)
          );
        }
        // å¦‚æœä¼ è¿›æ¥çš„æ˜¯æ™®é€šå€¼,è€Œépromiseå¯¹è±¡
        else {
          addData(index, cur);
        }
      });
    });
  }
}

// æ­¤å¤„çœç•¥resolvePromiseä»£ç 

// æµ‹è¯•ç”¨ä¾‹
const promise = () => {
  return new PromiseMon((resolve, reject) => {
    resolve(100);
  });
};

const promise2 = () => {
  return new PromiseMon((resolve, reject) => {
    setTimeout(() => {
      resolve(200);
    }, 1000);
  });
};

//å› ä¸ºä½¿ç”¨staticå…³é”®å­—ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥åœ¨ç±»ä¸Šé¢è¿›è¡Œè°ƒç”¨
PromiseMon.all(['a', 'b', promise(), promise2(), 'c']).then((res) => {
  console.log(res); // [ 'a', 'b', 100, 200, 'c' ]
});
```

å¤§å®¶å¯ä»¥çœ‹åˆ°ï¼Œå³ä½¿ `promise2` æ˜¯å¼‚æ­¥å‡½æ•°ï¼Œä½†æœ€ç»ˆä¹Ÿæ­£å¸¸çš„æ˜¾ç¤ºåœ¨æ•°ç»„å½“ä¸­ï¼Œä¸”æŒ‰åºçš„ä¸€ä¸€è¿›è¡Œæ‰“å°ã€‚åˆ°æ­¤ï¼Œä¹Ÿå°±è¯´æ˜ `promise.all` æˆåŠŸå®ç°å•¦ï¼

åŒæ—¶ï¼Œ `promise.race` ä¹Ÿæ˜¯æŒ‰ç…§è¿™ä¸ªæ¨¡å¼å»å®ç°ï¼Œè¿™é‡Œä¸å†è¿›è¡Œè®²è§£~

## 8. å®ç° Promise.resolveğŸ·ï¸

### ï¼ˆ1ï¼‰Promise.resolve åŠŸèƒ½åˆ†æ

æˆ‘ä»¬å…ˆæ¥æ¢³ç†ä¸‹ `promise.resolve` çš„**å®ç°æ€è·¯ï¼š**

- å¦‚æœå‚æ•°æ˜¯ä¸€ä¸ª `promise` å®ä¾‹ï¼Œé‚£ä¹ˆ `promise.resolve()` å°†ä¸åšä»»ä½•ä¿®æ”¹ï¼ŒåŸå°ä¸åŠ¨åœ°è¿”å›è¿™ä¸ªå®ä¾‹ã€‚
- å‚æ•°ä¸æ˜¯ `promise` å®ä¾‹ï¼Œæˆ–æ ¹æœ¬ä¸æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œåˆ™ `Promise.resolve()` æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„ `promise` å¯¹è±¡ï¼Œæ­¤æ—¶çŠ¶æ€ä¸º `fulfilled` ã€‚
- ä¸å¸¦æœ‰ä»»ä½•å‚æ•°ï¼Œåˆ™ç›´æ¥è¿”å›ä¸€ä¸ª `fulfilled` çŠ¶æ€çš„ `promise` å¯¹è±¡ã€‚

### ï¼ˆ2ï¼‰Promise.resolve åŠŸèƒ½å®ç°

ä¾æ®ä»¥ä¸Šçš„åŠŸèƒ½åˆ†æï¼Œæ¥å®ç° `promise.resolve` è¿™ä¸ªåŠŸèƒ½ã€‚**å…·ä½“ä»£ç å¦‚ä¸‹ï¼š**

```js
/**
 * 11_promise.resolveåŠŸèƒ½çš„å®ç°
 */

const PENDING = 'pending';
const FULFILLED = 'fulfilled';
const REJECTED = 'rejected';

class PromiseMon {
  status = PENDING;
  value = undefined;
  reason = undefined;
  successCB = [];
  failCB = [];

  //çœç•¥constructorã€resolveã€rejectå’Œthenæ–¹æ³•çš„ä»£ç 

  static resolve(value) {
    // ä¼ è¿›æ¥çš„æ˜¯ä¸€ä¸ªpromiseå¯¹è±¡ï¼ŒåŸå°ä¸åŠ¨è¿”å›
    if (value instanceof PromiseMon) {
      return value;
    }
    // ä¼ è¿›æ¥çš„ä¸æ˜¯promiseå¯¹è±¡ï¼Œå°†å…¶ä½œä¸ºå‚æ•°è¿”å›ä¸€ä¸ªpromise
    else {
      return new PromiseMon((resolve, reject) => {
        resolve(value);
      });
    }
  }
}

// æ­¤å¤„çœç•¥resolvePromiseä»£ç 

// æµ‹è¯•ç”¨ä¾‹
const promise = () => {
  return new PromiseMon((resolve, reject) => {
    resolve(100);
  });
};

// 1.å‚æ•°æ˜¯ä¸€ä¸ªpromiseå®ä¾‹ï¼Œé‚£ä¹ˆä¸åšä»»ä½•ä¿®æ”¹ï¼ŒåŸå°ä¸åŠ¨åœ°è¿”å›è¿™ä¸ªå®ä¾‹
PromiseMon.resolve(promise).then((res) => {
  console.log(res); // 100
});

/**
 * 2.å‚æ•°ä¸æ˜¯å…·æœ‰thenæ–¹æ³•çš„å¯¹è±¡ï¼Œæˆ–æ ¹æœ¬å°±ä¸æ˜¯å¯¹è±¡ï¼Œ
 * åˆ™Promise.resolve()æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„promiseå¯¹è±¡ï¼ŒçŠ¶æ€ä¸ºfulfilled
 */
PromiseMon.resolve(200).then((res) => {
  console.log(res); // 200
});

/**
 * 3.ä¸å¸¦æœ‰ä»»ä½•å‚æ•°ï¼Œåˆ™ç›´æ¥è¿”å›ä¸€ä¸ªresolvedçŠ¶æ€çš„promiseå¯¹è±¡
 */
PromiseMon.resolve().then(function () {
  console.log('two'); // two
});
```

å¤§å®¶å¯ä»¥çœ‹åˆ°ï¼Œä¾æ®æˆ‘ä»¬æ‰€ç½—åˆ—çš„ä¸‰ç§æƒ…å†µï¼Œ `promise.resolve` çš„åŠŸèƒ½ä¹Ÿä¸€ä¸€å®ç°å•¦ï¼

åŒæ—¶ï¼Œ `promise.reject` ä¹Ÿæ˜¯æŒ‰ç…§è¿™ä¸ªæ¨¡å¼å»å®ç°ï¼Œè¿™é‡Œä¸å†è¿›è¡Œè®²è§£~

# ğŸ“ å››ã€ç»“æŸè¯­

å†™åˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œå‘ç°æˆ‘å·²ç»èŠ±äº†æ•´æ•´ä¸‰å¤©çš„æ—¶é—´ï¼Œå¤§çº¦æ¥è¿‘ 34h+åœ¨ `promise` è¿™ä¸ªçŸ¥è¯†ä¸Šï¼Œå¥½åœ¨æœ€ç»ˆç®—æ˜¯å¯¹ `promise` æ ¸å¿ƒåŠŸèƒ½çš„çš„å®ç°æœ‰ä¸€ä¸ªè¾ƒä¸ºæ»¡æ„çš„ç»“æœã€‚

å¯èƒ½ä¹Ÿæ˜¯ç¬¬ä¸€æ¬¡è¿™ä¹ˆç»†è‡´çš„å»å•ƒä¸€ä¸ªçŸ¥è¯†ï¼Œæ‰€ä»¥åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­é‡åˆ°å¾ˆå¤šä»¥å‰æ²¡è¸©è¿‡çš„å‘ï¼Œä¸­é—´è¿‡ç¨‹ä¸­å¯¹é—®é¢˜è¿›è¡Œè¯¦ç»†è®°å½•å¹¶å°è¯•è§£å†³ï¼Œæ…¢æ…¢çš„å°±å®Œå–„äº†ä¸€ä¸ªæ–°çš„çŸ¥è¯†ä½“ç³»ã€‚

æœ€åï¼Œæœ¬æ–‡è®²è§£åˆ°è¿™é‡Œå°±ç»“æŸå•¦ï¼å¸Œæœ›å¤§å®¶èƒ½å¯¹ `promise` æœ‰ä¸€ä¸ªæ›´å¥½çš„äº†è§£~

# ğŸ£ å½©è›‹ One More Thing

## ï¼ˆï¼šè¯¾ä»£è¡¨è®°å½•

âœ…ã€Šä¸‰ 7.ã€‹çš„ `Promise.race` æ–¹æ³•æœªç”¨ä»£ç åœ¨åŸæ–‡ä¸­å®ç°ã€‚

âœ…ã€Šä¸‰ 8.ã€‹ä¸­ï¼Œæ®èµ„æ–™è°ƒæŸ¥ï¼Œ `promise.resolve` è¿˜æœ‰ç¬¬ 4 ç§ä¼ å‚æ–¹å¼ï¼Œå½“å‚æ•°æ˜¯ä¸€ä¸ª `thenable` ï¼Œå³å‚æ•°æ˜¯ä¸€ä¸ªå¸¦æœ‰ `then` æ–¹æ³•çš„å¯¹è±¡æ—¶ï¼Œåˆ™ç»“æœè¿”å›å…·æœ‰ `then` æ–¹æ³•çš„å¯¹è±¡ï¼ˆæœ¬åŠŸèƒ½æš‚æœªå®ç°ï¼‰ã€‚

âœ…ã€Šä¸‰ 8.ã€‹çš„ `Promise.reject` æ–¹æ³•æœªç”¨ä»£ç åœ¨åŸæ–‡ä¸­å®ç°ã€‚

## ï¼ˆï¼šå‚è€ƒèµ„æ–™

ğŸ‘‰ [[ä¸‡å­—è¯¦è§£]JavaScript ä¸­çš„å¼‚æ­¥æ¨¡å¼åŠ Promise ä½¿ç”¨](https://blog.csdn.net/weixin_42938619/article/details/118172320?spm=1001.2014.3001.5502)

ğŸ‘‰ [[1w6k å­—è¯¦ç»†è®²è§£] ä¿å§†çº§ä¸€æ­¥ä¸€æ­¥å¸¦ä½ å®ç° Promise çš„æ ¸å¿ƒåŠŸèƒ½](https://blog.csdn.net/weixin_42938619/article/details/118240727)

ğŸ‘‰ [ES6 å¿«é€Ÿå…¥é—¨](https://es6.ruanyifeng.com/#docs/promise)

